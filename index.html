<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC Perfumaria - Perfumes e CosmÃ©ticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .admin-panel { display: none; }
        .cart-sidebar { transform: translateX(100%); transition: transform 0.3s ease; }
        .cart-sidebar.open { transform: translateX(0); }
        .product-image { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; }
        .product-image-placeholder { width: 100%; height: 200px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        .image-upload-area { border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; transition: all 0.3s ease; cursor: pointer; }
        .image-upload-area:hover { border-color: #8b5cf6; background-color: #faf5ff; }
        .image-upload-area.dragover { border-color: #8b5cf6; background-color: #faf5ff; }
        .loading { opacity: 0.6; pointer-events: none; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .db-status { position: fixed; top: 20px; right: 20px; z-index: 1000; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Database Status Indicator -->
    <div id="db-status" class="db-status bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium hidden">
        ğŸ’¾ Banco de Dados Conectado
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-20 h-16 bg-white rounded-lg flex items-center justify-center overflow-hidden cursor-pointer" id="logo-container" onclick="changeLogo()">
                        <img id="logo-image" class="w-full h-full object-cover hidden" alt="KC Perfumaria">
                        <span id="logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">KC Perfumaria</h1>
                        <p class="text-purple-200 text-sm">Perfumes e CosmÃ©ticos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleCart()" class="relative bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        ğŸ›’ <span class="hidden sm:inline">Carrinho</span> (<span id="cart-count">0</span>)
                    </button>
                    <button onclick="accessAdmin()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        âš™ï¸ <span class="hidden sm:inline">Admin</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Customer View -->
        <div id="customer-view">
            <!-- Brand Filters -->
            <div class="mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Marcas</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3">
                    <button onclick="filterByBrand('todas')" class="brand-btn active bg-purple-600 text-white px-3 sm:px-6 py-2 rounded-full hover:bg-purple-700 transition-all text-sm sm:text-base">
                        Todas
                    </button>
                    <button onclick="filterByBrand('boticario')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        ğŸŒ¿ BoticÃ¡rio
                    </button>
                    <button onclick="filterByBrand('mary-kay')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        ğŸ’ Mary Kay
                    </button>
                    <button onclick="filterByBrand('eudora')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        âœ¨ Eudora
                    </button>
                    <button onclick="filterByBrand('natura')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        ğŸƒ Natura
                    </button>
                </div>
            </div>

            <!-- Categories -->
            <div class="mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Categorias</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3">
                    <button onclick="filterProducts('todos')" class="category-btn active bg-indigo-600 text-white px-4 sm:px-6 py-2 rounded-full hover:bg-indigo-700 transition-all text-sm sm:text-base">
                        Todos
                    </button>
                    <button onclick="filterProducts('perfumes')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Perfumes
                    </button>
                    <button onclick="filterProducts('cosmeticos')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        CosmÃ©ticos
                    </button>
                    <button onclick="filterProducts('cuidados')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Cuidados
                    </button>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6" id="products-grid">
                <!-- Products will be loaded here -->
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="admin-panel">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Painel Administrativo</h2>
                    <button onclick="backToStore()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all">
                        ğŸª Voltar para Loja
                    </button>
                </div>
                
                <!-- Logo Management -->
                <div class="max-w-2xl mx-auto mb-8">
                    <h3 class="text-lg font-semibold mb-4">ğŸ–¼ï¸ Gerenciar Logo da Loja</h3>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-center space-x-6">
                            <div class="flex-shrink-0">
                                <div class="w-24 h-20 bg-white rounded-lg flex items-center justify-center overflow-hidden border-2 border-gray-200">
                                    <img id="admin-logo-image" class="w-full h-full object-cover hidden" alt="Logo atual">
                                    <span id="admin-logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-2">Logo Atual</h4>
                                <p class="text-gray-600 text-sm mb-4">Clique no botÃ£o abaixo para alterar a logo da sua loja. Recomendamos imagens quadradas ou retangulares.</p>
                                <div class="flex space-x-3">
                                    <button onclick="changeLogoAdmin()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all">
                                        ğŸ“· Alterar Logo
                                    </button>
                                    <button onclick="removeLogoAdmin()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition-all">
                                        ğŸ—‘ï¸ Remover Logo
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            ğŸ’¡ Dica: Use imagens PNG ou JPG com fundo transparente para melhor resultado. Tamanho mÃ¡ximo: 2MB.
                        </div>
                    </div>
                </div>

                <!-- Add Product Form -->
                <div class="max-w-2xl mx-auto">
                    <h3 class="text-lg font-semibold mb-4">Adicionar Produto</h3>
                    <form id="add-product-form" class="space-y-4">
                        <!-- Product Image Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto do Produto</label>
                            <div class="image-upload-area" id="product-image-upload" onclick="document.getElementById('product-image-input').click()">
                                <div id="image-preview-container" class="hidden">
                                    <img id="image-preview" class="w-full h-32 object-cover rounded-lg mb-2" alt="Preview">
                                    <button type="button" onclick="removeProductImage(event)" class="text-red-600 hover:text-red-800 text-sm">
                                        ğŸ—‘ï¸ Remover Foto
                                    </button>
                                </div>
                                <div id="upload-placeholder">
                                    <div class="text-4xl mb-2">ğŸ“·</div>
                                    <p class="text-gray-600 font-medium">Clique para adicionar foto</p>
                                    <p class="text-gray-400 text-sm mt-1">JPG, PNG ou GIF (mÃ¡x. 5MB)</p>
                                </div>
                            </div>
                            <input type="file" id="product-image-input" accept="image/*" class="hidden">
                        </div>

                        <input type="text" id="product-name" placeholder="Nome do produto" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <select id="product-brand" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Selecione a marca</option>
                            <option value="boticario">ğŸŒ¿ BoticÃ¡rio</option>
                            <option value="mary-kay">ğŸ’ Mary Kay</option>
                            <option value="eudora">âœ¨ Eudora</option>
                            <option value="natura">ğŸƒ Natura</option>
                        </select>
                        <select id="product-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Selecione a categoria</option>
                            <option value="perfumes">Perfumes</option>
                            <option value="cosmeticos">CosmÃ©ticos</option>
                            <option value="cuidados">Cuidados</option>
                        </select>
                        <input type="number" id="product-price" placeholder="PreÃ§o (R$)" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <input type="number" id="product-stock" placeholder="Quantidade em estoque" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <textarea id="product-description" placeholder="DescriÃ§Ã£o do produto" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-24"></textarea>
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-all font-semibold">
                            Adicionar Produto
                        </button>
                    </form>
                </div>
            </div>

            <!-- Product Gallery Management -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Produtos Cadastrados</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="product-gallery">
                    <!-- Product gallery will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-sidebar fixed right-0 top-0 h-full w-full sm:w-96 bg-white shadow-2xl z-50 flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Carrinho de Compras</h3>
                <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <div id="cart-items">
                <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Total:</span>
                <span class="text-xl font-bold text-purple-600" id="cart-total">R$ 0,00</span>
            </div>
            <button onclick="finalizePurchaseWhatsApp()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-semibold">
                ğŸ“± Finalizar pelo WhatsApp
            </button>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleCart()"></div>

    <!-- Hidden file input for import -->
    <input type="file" id="import-file-input" accept=".json" class="hidden">

    <script>
        // Sistema integrado com Supabase
        // ConfiguraÃ§Ã£o do banco de dados
        const SUPABASE_URL = 'https://udyihngwyqhfhdxkxwso.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkeWlobmd3eXFoZmhkeGt4d3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTcwOTUsImV4cCI6MjA3MDQzMzA5NX0.MA3RgucTM7akkqxF1Zgl4aLtGBFAUT48IKfXez8ZK3c';

        // Global Variables
        let products = [];
        let cart = [];
        let sales = [];
        let currentFilter = 'todos';
        let currentBrand = 'todas';
        let currentProductImage = null;

        // Make functions globally accessible
        window.accessAdmin = accessAdmin;
        window.toggleCart = toggleCart;
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.updateQuantity = updateQuantity;
        window.finalizePurchaseWhatsApp = finalizePurchaseWhatsApp;
        window.filterByBrand = filterByBrand;
        window.filterProducts = filterProducts;
        window.backToStore = backToStore;
        window.editProduct = editProduct;
        window.editProductImage = editProductImage;
        window.deleteProduct = deleteProduct;
        window.removeProductImage = removeProductImage;
        window.changeLogo = changeLogo;
        window.changeLogoAdmin = changeLogoAdmin;
        window.removeLogoAdmin = removeLogoAdmin;

        // Database connection
        let supabaseClient = null;

        // Database management system
        const db = {
            client: null,
            connected: false,

            async init() {
                try {
                    console.log('ğŸ”Œ Conectando ao Supabase...');
                    this.client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    // Test connection
                    const { data, error } = await this.client.from('products').select('count').limit(1);
                    
                    if (error) {
                        console.error('âŒ Erro na conexÃ£o:', error);
                        this.connected = false;
                        this.showDBStatus('âŒ Erro na conexÃ£o', 'bg-red-100 text-red-800');
                        return false;
                    }
                    
                    this.connected = true;
                    console.log('âœ… Conectado ao Supabase!');
                    this.showDBStatus('âœ… Conectado ao Supabase', 'bg-green-100 text-green-800');
                    return true;
                } catch (error) {
                    console.error('âŒ Erro ao inicializar Supabase:', error);
                    this.connected = false;
                    this.showDBStatus('âŒ Erro na inicializaÃ§Ã£o', 'bg-red-100 text-red-800');
                    return false;
                }
            },

            showDBStatus(message, className = 'bg-green-100 text-green-800') {
                const statusEl = document.getElementById('db-status');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `db-status px-3 py-1 rounded-full text-sm font-medium ${className}`;
                    statusEl.classList.remove('hidden');
                    
                    // Auto hide after 5 seconds
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 5000);
                }
            },

            async loadProducts() {
                if (!this.connected) return [];
                
                try {
                    const { data, error } = await this.client
                        .from('products')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    console.log(`ğŸ“¦ ${data.length} produtos carregados do banco`);
                    return data || [];
                } catch (error) {
                    console.error('âŒ Erro ao carregar produtos:', error);
                    return [];
                }
            },

            async saveProduct(product) {
                if (!this.connected) return false;
                
                try {
                    const { data, error } = await this.client
                        .from('products')
                        .upsert(product)
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('âœ… Produto salvo no Supabase:', product.name);
                    return true;
                } catch (error) {
                    console.error('âŒ Erro ao salvar produto:', error);
                    return false;
                }
            },

            async deleteProduct(productId) {
                if (!this.connected) return false;
                
                try {
                    const { error } = await this.client
                        .from('products')
                        .delete()
                        .eq('id', productId);
                    
                    if (error) throw error;
                    
                    console.log('âœ… Produto excluÃ­do do Supabase:', productId);
                    return true;
                } catch (error) {
                    console.error('âŒ Erro ao excluir produto:', error);
                    return false;
                }
            },

            async loadSales() {
                if (!this.connected) return [];
                
                try {
                    const { data, error } = await this.client
                        .from('sales')
                        .select('*')
                        .order('date', { ascending: false });
                    
                    if (error) throw error;
                    
                    console.log(`ğŸ’° ${data.length} vendas carregadas do Supabase`);
                    return data || [];
                } catch (error) {
                    console.error('âŒ Erro ao carregar vendas:', error);
                    return [];
                }
            },

            async saveSale(sale) {
                if (!this.connected) return false;
                
                try {
                    const { data, error } = await this.client
                        .from('sales')
                        .insert(sale)
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('âœ… Venda salva no Supabase:', sale.id);
                    return true;
                } catch (error) {
                    console.error('âŒ Erro ao salvar venda:', error);
                    return false;
                }
            },

            async saveImage(imageId, imageData) {
                if (!this.connected) return false;
                
                try {
                    const { data, error } = await this.client
                        .from('images')
                        .upsert({
                            id: imageId,
                            data: imageData
                        })
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('âœ… Imagem salva no Supabase:', imageId);
                    return true;
                } catch (error) {
                    console.error('âŒ Erro ao salvar imagem:', error);
                    return false;
                }
            },

            async getImage(imageId) {
                if (!this.connected) return null;
                
                try {
                    const { data, error } = await this.client
                        .from('images')
                        .select('data')
                        .eq('id', imageId)
                        .single();
                    
                    if (error) throw error;
                    
                    return data?.data || null;
                } catch (error) {
                    console.error('âŒ Erro ao carregar imagem:', error);
                    return null;
                }
            },

            async deleteImage(imageId) {
                if (!this.connected) return false;
                
                try {
                    const { error } = await this.client
                        .from('images')
                        .delete()
                        .eq('id', imageId);
                    
                    if (error) throw error;
                    
                    console.log('âœ… Imagem excluÃ­da do Supabase:', imageId);
                    return true;
                } catch (error) {
                    console.error('âŒ Erro ao excluir imagem:', error);
                    return false;
                }
            }
        };

        // ConfiguraÃ§Ãµes da KC Perfumaria
        let STORE_CONFIG = {
            name: 'KC PERFUMARIA',
            ownerName: 'KELLY CRISTINE',
            document: '123.456.789-00',
            city: 'PARANAGUA',
            state: 'PR',
            pixKey: '41997786625',
            pixKeyType: 'phone',
            whatsapp: '5541997786625',
            bankAccount: {
                bank: 'Banco do Brasil',
                agency: '1234-5',
                account: '12345-6',
                accountType: 'Conta Corrente'
            },
            discounts: {
                pix: 0.05,
                cash: 0.03,
                debit: 0.02
            },
            installments: {
                maxInstallments: 3,
                minAmountPerInstallment: 30.00
            }
        };

        // Admin access function
        function accessAdmin() {
            const password = prompt('ğŸ” Digite a senha de administrador:');
            
            if (password === 'kc0310') {
                // Switch to admin view
                const customerView = document.getElementById('customer-view');
                const adminPanel = document.getElementById('admin-panel');
                
                if (customerView && adminPanel) {
                    customerView.style.display = 'none';
                    adminPanel.style.display = 'block';
                    adminPanel.classList.remove('admin-panel');
                    updateProductGallery();
                }
                
                alert('ğŸ‰ Acesso administrativo concedido!');
                console.log('ğŸ”‘ Acesso administrativo concedido!');
                return true;
            } else if (password !== null) {
                alert('âŒ Senha incorreta! Acesso negado.');
                return false;
            }
            
            return false;
        }

        // Check for admin access
        function checkAdminAccess() {
            const urlParams = new URLSearchParams(window.location.search);
            const adminParam = urlParams.get('admin');
            
            if (adminParam === 'kc0310') {
                // Store admin access in session
                sessionStorage.setItem('kc_admin_access', 'kc0310');
                
                // Automatically switch to admin view
                setTimeout(() => {
                    const customerView = document.getElementById('customer-view');
                    const adminPanel = document.getElementById('admin-panel');
                    
                    if (customerView && adminPanel) {
                        customerView.style.display = 'none';
                        adminPanel.style.display = 'block';
                        updateStockList();
                        updateSalesReport();
                        updateProductGallery();
                    }
                }, 100);
                
                console.log('ğŸ”‘ Acesso administrativo concedido! Painel admin ativado automaticamente.');
                return true;
            }
            
            return false;
        }

        // Tutorial de Hospedagem no Supabase
        function showSupabaseHostingTutorial() {
            const tutorial = `
ğŸš€ TUTORIAL COMPLETO: HOSPEDAGEM NO SUPABASE

ğŸ“‹ PASSO A PASSO DETALHADO:

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£ PREPARAR O CÃ“DIGO:
   â€¢ Baixe o cÃ³digo preparado clicando em "Baixar CÃ³digo Preparado"
   â€¢ Extraia o arquivo ZIP
   â€¢ VocÃª terÃ¡ os arquivos: index.html, database.js, style.css

2ï¸âƒ£ CRIAR CONTA NO SUPABASE:
   â€¢ Acesse: https://supabase.com
   â€¢ Clique em "Start your project"
   â€¢ FaÃ§a login com GitHub (recomendado) ou email

3ï¸âƒ£ CRIAR NOVO PROJETO:
   â€¢ Clique em "New Project"
   â€¢ Nome do projeto: "kc-perfumaria"
   â€¢ Senha do banco: (crie uma senha forte e anote!)
   â€¢ RegiÃ£o: South America (SÃ£o Paulo)
   â€¢ Clique em "Create new project"
   â€¢ â±ï¸ Aguarde 2-3 minutos para criaÃ§Ã£o

4ï¸âƒ£ CONFIGURAR BANCO DE DADOS:
   â€¢ No menu lateral: SQL Editor
   â€¢ Clique em "New query"
   â€¢ Cole o cÃ³digo SQL abaixo:

-- CÃ“DIGO SQL (COPIE E COLE):
CREATE TABLE products (
    id BIGINT PRIMARY KEY,
    name TEXT NOT NULL,
    brand TEXT NOT NULL,
    category TEXT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    stock INTEGER NOT NULL DEFAULT 0,
    description TEXT,
    image TEXT,
    image_url TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE sales (
    id BIGINT PRIMARY KEY,
    items JSONB NOT NULL,
    total DECIMAL(10,2) NOT NULL,
    payment_method TEXT,
    date TIMESTAMP DEFAULT NOW(),
    date_formatted TEXT
);

CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value JSONB NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE images (
    id TEXT PRIMARY KEY,
    data TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Habilitar RLS
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE sales ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE images ENABLE ROW LEVEL SECURITY;

-- PolÃ­ticas de acesso
CREATE POLICY "Allow all operations" ON products FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON sales FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON settings FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON images FOR ALL USING (true);

   â€¢ Clique em "Run" (botÃ£o azul)
   â€¢ Deve aparecer "Success. No rows returned"

5ï¸âƒ£ OBTER CREDENCIAIS:
   â€¢ No menu lateral: Settings â†’ API
   â€¢ Copie a "URL" (https://xxx.supabase.co)
   â€¢ Copie a "anon public" key (chave longa)

6ï¸âƒ£ CONFIGURAR O CÃ“DIGO:
   â€¢ Abra o arquivo "database.js" baixado
   â€¢ Encontre as linhas:
     const SUPABASE_URL = 'SUA_URL_AQUI'
     const SUPABASE_KEY = 'SUA_CHAVE_AQUI'
   â€¢ Substitua pelos valores copiados do Supabase

7ï¸âƒ£ HOSPEDAR NO SUPABASE:
   â€¢ No painel do Supabase: Storage â†’ Create bucket
   â€¢ Nome do bucket: "website"
   â€¢ PÃºblico: âœ… Sim
   â€¢ Clique em "Create bucket"
   
   â€¢ Clique no bucket "website"
   â€¢ Clique em "Upload file"
   â€¢ Selecione todos os arquivos (index.html, database.js, style.css)
   â€¢ Clique em "Upload"

8ï¸âƒ£ CONFIGURAR HOSPEDAGEM:
   â€¢ Clique no arquivo "index.html" enviado
   â€¢ Clique em "Copy URL"
   â€¢ Sua loja estarÃ¡ disponÃ­vel nesta URL!

9ï¸âƒ£ DOMÃNIO PERSONALIZADO (OPCIONAL):
   â€¢ No painel: Settings â†’ Custom domains
   â€¢ Adicione seu domÃ­nio personalizado
   â€¢ Configure DNS conforme instruÃ§Ãµes

ğŸ‰ PRONTO! SUA LOJA ESTÃ NO AR!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¡ VANTAGENS DA HOSPEDAGEM SUPABASE:

âœ… GRATUITO atÃ© 500MB de armazenamento
âœ… HTTPS automÃ¡tico (SSL)
âœ… Banco de dados PostgreSQL na nuvem
âœ… Backup automÃ¡tico
âœ… CDN global (carregamento rÃ¡pido)
âœ… DomÃ­nio personalizado
âœ… Escalabilidade automÃ¡tica
âœ… Painel administrativo completo

ğŸ“Š RECURSOS INCLUÃDOS:

ğŸ›ï¸ Loja online completa
ğŸ“¦ GestÃ£o de produtos e estoque
ğŸ’° RelatÃ³rios de vendas
ğŸ“± WhatsApp integrado
ğŸ¨ Upload de imagens
ğŸ“Š Dashboard administrativo
ğŸ“± Design responsivo
ğŸ”’ Dados seguros na nuvem

ğŸ†˜ SUPORTE:

â€¢ DocumentaÃ§Ã£o: https://supabase.com/docs
â€¢ Comunidade: https://github.com/supabase/supabase/discussions
â€¢ Discord: https://discord.supabase.com

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ DICA EXTRA: ATUALIZAÃ‡Ã•ES

Para atualizar sua loja:
1. Modifique os arquivos localmente
2. FaÃ§a upload novamente no Storage
3. Substitua os arquivos existentes
4. As mudanÃ§as aparecem instantaneamente!

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            `;
            
            // Create modal with tutorial
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-5xl max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold text-blue-800">ğŸš€ Tutorial Hospedagem Supabase</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                        </div>
                        <pre class="whitespace-pre-wrap text-sm bg-gray-50 p-4 rounded-lg border overflow-x-auto font-mono">${tutorial}</pre>
                        <div class="mt-6 flex justify-end space-x-2">
                            <button onclick="navigator.clipboard.writeText(\`${tutorial}\`).then(() => alert('ğŸ“‹ Tutorial copiado!'))" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                                ğŸ“‹ Copiar Tutorial
                            </button>
                            <button onclick="window.open('https://supabase.com', '_blank')" 
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all">
                                ğŸŒ Abrir Supabase
                            </button>
                            <button onclick="downloadForSupabase()" 
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all">
                                ğŸ“¥ Baixar CÃ³digo
                            </button>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-all">
                                Fechar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function downloadForSupabase() {
            // Criar os arquivos preparados para Supabase
            const htmlContent = document.documentElement.outerHTML;
            
            // Criar arquivo ZIP simulado (na verdade serÃ¡ um HTML com instruÃ§Ãµes)
            const downloadContent = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC Perfumaria - Preparado para Supabase</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .alert { background: #e3f2fd; border: 1px solid #2196f3; padding: 15px; border-radius: 5px; margin: 20px 0; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        .step { background: #f9f9f9; padding: 15px; margin: 10px 0; border-left: 4px solid #4caf50; }
    </style>
</head>
<body>
    <h1>ğŸš€ KC Perfumaria - CÃ³digo Preparado para Supabase</h1>
    
    <div class="alert">
        <strong>ğŸ“‹ INSTRUÃ‡Ã•ES:</strong><br>
        Este arquivo contÃ©m sua loja KC Perfumaria preparada para hospedagem no Supabase.<br>
        Siga os passos abaixo para colocar sua loja online!
    </div>

    <div class="step">
        <h3>1ï¸âƒ£ Salvar este arquivo</h3>
        <p>Salve este arquivo como <strong>"index.html"</strong> no seu computador.</p>
    </div>

    <div class="step">
        <h3>2ï¸âƒ£ Criar conta no Supabase</h3>
        <p>Acesse <a href="https://supabase.com" target="_blank">https://supabase.com</a> e crie sua conta gratuita.</p>
    </div>

    <div class="step">
        <h3>3ï¸âƒ£ Criar projeto</h3>
        <p>Crie um novo projeto chamado "kc-perfumaria" na regiÃ£o South America.</p>
    </div>

    <div class="step">
        <h3>4ï¸âƒ£ Configurar banco de dados</h3>
        <p>No SQL Editor do Supabase, execute este cÃ³digo:</p>
        <div class="code">-- Tabela de produtos
CREATE TABLE products (
    id BIGINT PRIMARY KEY,
    name TEXT NOT NULL,
    brand TEXT NOT NULL,
    category TEXT NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    stock INTEGER NOT NULL DEFAULT 0,
    description TEXT,
    image TEXT,
    image_url TEXT,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de vendas
CREATE TABLE sales (
    id BIGINT PRIMARY KEY,
    items JSONB NOT NULL,
    total DECIMAL(10,2) NOT NULL,
    payment_method TEXT,
    date TIMESTAMP DEFAULT NOW(),
    date_formatted TEXT
);

-- Tabela de configuraÃ§Ãµes
CREATE TABLE settings (
    key TEXT PRIMARY KEY,
    value JSONB NOT NULL,
    updated_at TIMESTAMP DEFAULT NOW()
);

-- Tabela de imagens
CREATE TABLE images (
    id TEXT PRIMARY KEY,
    data TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT NOW()
);

-- Habilitar RLS
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE sales ENABLE ROW LEVEL SECURITY;
ALTER TABLE settings ENABLE ROW LEVEL SECURITY;
ALTER TABLE images ENABLE ROW LEVEL SECURITY;

-- PolÃ­ticas de acesso
CREATE POLICY "Allow all operations" ON products FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON sales FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON settings FOR ALL USING (true);
CREATE POLICY "Allow all operations" ON images FOR ALL USING (true);</div>
    </div>

    <div class="step">
        <h3>5ï¸âƒ£ Hospedar arquivo</h3>
        <p>No Storage do Supabase:</p>
        <ul>
            <li>Crie um bucket pÃºblico chamado "website"</li>
            <li>FaÃ§a upload deste arquivo index.html</li>
            <li>Copie a URL pÃºblica</li>
            <li>Sua loja estarÃ¡ online!</li>
        </ul>
    </div>

    <div class="alert">
        <strong>ğŸ‰ PRONTO!</strong><br>
        Sua KC Perfumaria estarÃ¡ online com banco de dados na nuvem, totalmente gratuito!
    </div>

    <hr style="margin: 40px 0;">
    
    <!-- Aqui comeÃ§a o cÃ³digo da loja -->
    ${htmlContent}
</body>
</html>
            `;
            
            // Download do arquivo
            const blob = new Blob([downloadContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'kc-perfumaria-supabase.html';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('ğŸ“¥ Arquivo baixado!\n\nâœ… Sua loja foi preparada para hospedagem no Supabase.\n\nğŸ“‹ Siga as instruÃ§Ãµes no arquivo baixado para colocar sua loja online!');
        }

        // Initialize Application
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('ğŸš€ Inicializando KC Perfumaria...');
                
                // Initialize arrays
                products = [];
                sales = [];
                cart = [];
                
                // Check admin access first
                checkAdminAccess();
                
                // Always load from localStorage first (immediate data)
                loadDataFromStorage();
                
                // Initialize interface with localStorage data
                loadProducts();
                setupProductImageUpload();
                updateProductGallery();
                
                // Then try to connect to Supabase in background
                try {
                    const dbConnected = await db.init();
                    
                    if (dbConnected) {
                        console.log('ğŸ”„ Sincronizando com Supabase...');
                        // Load data from Supabase and merge/update
                        await loadDataFromSupabase();
                        
                        // Refresh interface with Supabase data
                        loadProducts();
                        updateProductGallery();
                    }
                } catch (dbError) {
                    console.warn('âš ï¸ Supabase indisponÃ­vel, usando apenas localStorage:', dbError);
                }
                
                console.log('ğŸ‰ KC Perfumaria inicializada com sucesso!');
                console.log(`ğŸ“Š Estado atual: ${products.length} produtos, ${sales.length} vendas`);
                
            } catch (error) {
                console.error('âŒ Erro ao inicializar aplicaÃ§Ã£o:', error);
                // Ensure arrays are initialized even on error
                products = products || [];
                sales = sales || [];
                cart = [];
                
                // Try to load interface anyway
                loadProducts();
                setupProductImageUpload();
                updateProductGallery();
            }
        });

        // Load data from Supabase
        async function loadDataFromSupabase() {
            try {
                console.log('ğŸ“¡ Carregando dados do Supabase...');
                
                // Load products
                const supabaseProducts = await db.loadProducts();
                if (supabaseProducts.length > 0) {
                    products = supabaseProducts;
                    console.log(`ğŸ“¦ ${products.length} produtos carregados do Supabase`);
                } else {
                    // Initialize with default data if no products exist
                    await initializeDefaultDataSupabase();
                }
                
                // Load sales
                const supabaseSales = await db.loadSales();
                if (supabaseSales.length > 0) {
                    sales = supabaseSales;
                    console.log(`ğŸ’° ${sales.length} vendas carregadas do Supabase`);
                }
                
                // Load logo
                const logoData = await db.getImage('logo');
                if (logoData) {
                    updateLogo(logoData);
                    updateAdminLogoPreview(logoData);
                    console.log('ğŸ–¼ï¸ Logo carregada do Supabase');
                } else {
                    // Try localStorage fallback
                    const localLogo = localStorage.getItem('kc_logo');
                    if (localLogo) {
                        updateLogo(localLogo);
                        updateAdminLogoPreview(localLogo);
                        console.log('ğŸ–¼ï¸ Logo carregada do localStorage');
                    }
                }
                
            } catch (error) {
                console.error('âŒ Erro ao carregar dados do Supabase:', error);
                // Fallback to localStorage
                loadDataFromStorage();
            }
        }

        // Enhanced data loading with multiple recovery methods
        function loadDataFromStorage() {
            try {
                console.log('ğŸ“‚ Iniciando carregamento de dados...');
                
                // Initialize arrays
                products = [];
                sales = [];
                
                // Method 1: Try primary store data
                const primaryData = localStorage.getItem('kc_store_data');
                if (primaryData) {
                    try {
                        const parsed = JSON.parse(primaryData);
                        if (parsed.products && Array.isArray(parsed.products)) {
                            products = parsed.products;
                            console.log(`ğŸ“¦ ${products.length} produtos carregados do armazenamento principal`);
                        }
                        if (parsed.sales && Array.isArray(parsed.sales)) {
                            sales = parsed.sales;
                            console.log(`ğŸ’° ${sales.length} vendas carregadas do armazenamento principal`);
                        }
                    } catch (parseError) {
                        console.warn('âš ï¸ Erro no armazenamento principal, tentando mÃ©todo alternativo...');
                    }
                }
                
                // Method 2: Try individual arrays if primary failed
                if (products.length === 0) {
                    const savedProducts = localStorage.getItem('kc_products');
                    if (savedProducts) {
                        try {
                            const parsedProducts = JSON.parse(savedProducts);
                            if (Array.isArray(parsedProducts)) {
                                products = parsedProducts;
                                console.log(`ğŸ“¦ ${products.length} produtos carregados do armazenamento secundÃ¡rio`);
                            }
                        } catch (parseError) {
                            console.warn('âš ï¸ Erro no armazenamento secundÃ¡rio...');
                        }
                    }
                }
                
                if (sales.length === 0) {
                    const savedSales = localStorage.getItem('kc_sales');
                    if (savedSales) {
                        try {
                            const parsedSales = JSON.parse(savedSales);
                            if (Array.isArray(parsedSales)) {
                                sales = parsedSales;
                                console.log(`ğŸ’° ${sales.length} vendas carregadas do armazenamento secundÃ¡rio`);
                            }
                        } catch (parseError) {
                            console.warn('âš ï¸ Erro ao carregar vendas...');
                        }
                    }
                }
                
                // Method 3: Try emergency backup if still empty
                if (products.length === 0) {
                    const emergencyData = localStorage.getItem('kc_emergency_save');
                    if (emergencyData) {
                        try {
                            const parsed = JSON.parse(emergencyData);
                            if (parsed.products && Array.isArray(parsed.products)) {
                                products = parsed.products;
                                console.log(`ğŸ†˜ ${products.length} produtos recuperados do backup de emergÃªncia`);
                            }
                        } catch (emergencyError) {
                            console.warn('âš ï¸ Backup de emergÃªncia tambÃ©m falhou...');
                        }
                    }
                }
                
                // Method 4: Try timestamped backups
                if (products.length === 0) {
                    try {
                        const keys = Object.keys(localStorage);
                        const backupKeys = keys.filter(key => key.startsWith('kc_backup_')).sort().reverse();
                        
                        for (const backupKey of backupKeys) {
                            try {
                                const backupData = JSON.parse(localStorage.getItem(backupKey));
                                if (backupData.products && Array.isArray(backupData.products) && backupData.products.length > 0) {
                                    products = backupData.products;
                                    if (backupData.sales && Array.isArray(backupData.sales)) {
                                        sales = backupData.sales;
                                    }
                                    console.log(`ğŸ”„ ${products.length} produtos recuperados do backup: ${backupKey}`);
                                    break;
                                }
                            } catch (backupError) {
                                console.warn(`âš ï¸ Erro no backup ${backupKey}:`, backupError);
                            }
                        }
                    } catch (backupSearchError) {
                        console.warn('âš ï¸ Erro na busca por backups:', backupSearchError);
                    }
                }
                
                // Load logo
                const localLogo = localStorage.getItem('kc_logo');
                if (localLogo) {
                    try {
                        updateLogo(localLogo);
                        updateAdminLogoPreview(localLogo);
                        console.log('ğŸ–¼ï¸ Logo carregada');
                    } catch (logoError) {
                        console.warn('âš ï¸ Erro ao carregar logo:', logoError);
                    }
                }
                
                console.log(`âœ… Carregamento finalizado: ${products.length} produtos, ${sales.length} vendas`);
                
                // Ensure data integrity by saving immediately
                if (products.length > 0 || sales.length > 0) {
                    setTimeout(() => {
                        console.log('ğŸ”„ Verificando integridade dos dados...');
                        saveDataToStorage();
                    }, 500);
                }
                
                return true;
                
            } catch (error) {
                console.error('âŒ Erro crÃ­tico no carregamento:', error);
                
                // Last resort: initialize empty
                products = [];
                sales = [];
                console.log('ğŸ†• Inicializando com dados vazios devido a erro crÃ­tico');
                return false;
            }
        }

        // Enhanced save system with multiple fallbacks
        function saveDataToStorage() {
            try {
                console.log(`ğŸ’¾ Iniciando salvamento: ${products.length} produtos, ${sales.length} vendas`);
                
                // Create comprehensive backup
                const dataToSave = {
                    products: products,
                    sales: sales,
                    timestamp: new Date().toISOString(),
                    version: '2.0'
                };
                
                // Primary save - complete data
                localStorage.setItem('kc_store_data', JSON.stringify(dataToSave));
                
                // Secondary saves - individual arrays
                localStorage.setItem('kc_products', JSON.stringify(products));
                localStorage.setItem('kc_sales', JSON.stringify(sales));
                
                // Tertiary save - emergency backup
                localStorage.setItem('kc_backup_' + Date.now(), JSON.stringify(dataToSave));
                
                // Immediate verification with multiple checks
                const primaryCheck = localStorage.getItem('kc_store_data');
                const secondaryCheck = localStorage.getItem('kc_products');
                
                if (primaryCheck && secondaryCheck) {
                    try {
                        const parsedPrimary = JSON.parse(primaryCheck);
                        const parsedSecondary = JSON.parse(secondaryCheck);
                        
                        const primaryValid = parsedPrimary.products && parsedPrimary.products.length === products.length;
                        const secondaryValid = parsedSecondary.length === products.length;
                        
                        if (primaryValid && secondaryValid) {
                            console.log('âœ… Dados salvos e verificados com sucesso!');
                            console.log(`ğŸ“Š VerificaÃ§Ã£o: ${parsedPrimary.products.length} produtos salvos`);
                            
                            // Clean old backups (keep only last 5)
                            cleanOldBackups();
                            
                            return true;
                        } else {
                            console.error('âŒ VerificaÃ§Ã£o de integridade falhou');
                            console.error(`Primary valid: ${primaryValid}, Secondary valid: ${secondaryValid}`);
                            return false;
                        }
                    } catch (parseError) {
                        console.error('âŒ Erro ao verificar dados salvos:', parseError);
                        return false;
                    }
                } else {
                    console.error('âŒ Dados nÃ£o foram salvos corretamente');
                    return false;
                }
                
            } catch (error) {
                console.error('âŒ Erro crÃ­tico no salvamento:', error);
                
                // Emergency save attempt
                try {
                    const emergencyData = {
                        products: products.map(p => ({
                            id: p.id,
                            name: p.name,
                            brand: p.brand,
                            category: p.category,
                            price: p.price,
                            stock: p.stock,
                            description: p.description || '',
                            image: p.image || 'ğŸŒ¸',
                            imageUrl: p.imageUrl || null
                        })),
                        emergency: true,
                        timestamp: new Date().toISOString()
                    };
                    
                    localStorage.setItem('kc_emergency_save', JSON.stringify(emergencyData));
                    console.log('ğŸ†˜ Salvamento de emergÃªncia realizado');
                    
                    alert('âš ï¸ Salvamento principal falhou, mas backup de emergÃªncia foi criado.');
                    return false;
                } catch (emergencyError) {
                    console.error('âŒ Falha total no salvamento:', emergencyError);
                    alert('âŒ ERRO CRÃTICO: NÃ£o foi possÃ­vel salvar os dados. Verifique o espaÃ§o de armazenamento do navegador.');
                    return false;
                }
            }
        }

        // Clean old backup files
        function cleanOldBackups() {
            try {
                const keys = Object.keys(localStorage);
                const backupKeys = keys.filter(key => key.startsWith('kc_backup_')).sort();
                
                // Keep only the 5 most recent backups
                if (backupKeys.length > 5) {
                    const toDelete = backupKeys.slice(0, backupKeys.length - 5);
                    toDelete.forEach(key => {
                        localStorage.removeItem(key);
                    });
                    console.log(`ğŸ§¹ Limpeza: ${toDelete.length} backups antigos removidos`);
                }
            } catch (error) {
                console.warn('âš ï¸ Erro na limpeza de backups:', error);
            }
        }

        // Initialize with empty data - admin will add products
        async function initializeDefaultDataSupabase() {
            products = [];
            console.log('âœ… Loja inicializada vazia - pronta para cadastro de produtos!');
        }

        // Initialize default data (localStorage fallback)
        function initializeDefaultData() {
            products = [];
            saveDataToStorage();
        }

        // Product Image Upload Functions
        function setupProductImageUpload() {
            const imageInput = document.getElementById('product-image-input');
            const uploadArea = document.getElementById('product-image-upload');
            
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleProductImageFile(file);
                }
            });

            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleProductImageFile(file);
                }
            });
        }

        function handleProductImageFile(file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('Arquivo muito grande! O tamanho mÃ¡ximo Ã© 5MB.');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('Por favor, selecione apenas arquivos de imagem.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentProductImage = e.target.result;
                showImagePreview(currentProductImage);
            };
            reader.readAsDataURL(file);
        }

        function showImagePreview(imageData) {
            const previewContainer = document.getElementById('image-preview-container');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const imagePreview = document.getElementById('image-preview');

            imagePreview.src = imageData;
            previewContainer.classList.remove('hidden');
            uploadPlaceholder.classList.add('hidden');
        }

        function removeProductImage(event) {
            event.stopPropagation();
            
            const previewContainer = document.getElementById('image-preview-container');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const imageInput = document.getElementById('product-image-input');

            currentProductImage = null;
            previewContainer.classList.add('hidden');
            uploadPlaceholder.classList.remove('hidden');
            imageInput.value = '';
        }

        // Logo Management
        function changeLogo() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        alert('Arquivo muito grande! O tamanho mÃ¡ximo Ã© 2MB.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const logoImage = document.getElementById('logo-image');
                        const logoText = document.getElementById('logo-text');
                        
                        logoImage.src = e.target.result;
                        logoImage.classList.remove('hidden');
                        logoText.classList.add('hidden');
                        
                        // Salvar no banco de dados
                        if (db.connected) {
                            await db.saveImage('logo', e.target.result);
                            db.showDBStatus('âœ… Logo salva!');
                        }
                        
                        alert('âœ… Logo atualizada com sucesso!');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            fileInput.click();
        }

        // Admin Logo Management Functions
        function changeLogoAdmin() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        alert('âŒ Arquivo muito grande! O tamanho mÃ¡ximo Ã© 2MB.');
                        return;
                    }

                    if (!file.type.startsWith('image/')) {
                        alert('âŒ Por favor, selecione apenas arquivos de imagem (PNG, JPG, GIF).');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        const logoData = e.target.result;
                        
                        // Update header logo
                        updateLogo(logoData);
                        
                        // Update admin preview
                        updateAdminLogoPreview(logoData);
                        
                        // Save to database
                        if (db.connected) {
                            try {
                                await db.saveImage('logo', logoData);
                                db.showDBStatus('âœ… Logo salva no banco!');
                                console.log('âœ… Logo salva no Supabase');
                            } catch (error) {
                                console.error('âŒ Erro ao salvar logo:', error);
                            }
                        }
                        
                        // Save to localStorage as fallback
                        try {
                            localStorage.setItem('kc_logo', logoData);
                        } catch (error) {
                            console.error('âŒ Erro ao salvar logo no localStorage:', error);
                        }
                        
                        alert('âœ… Logo atualizada com sucesso!\n\nğŸ”„ A nova logo jÃ¡ estÃ¡ visÃ­vel no cabeÃ§alho da loja.');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            fileInput.click();
        }

        function removeLogoAdmin() {
            if (confirm('ğŸ—‘ï¸ Tem certeza que deseja remover a logo?\n\nA logo padrÃ£o "KC" serÃ¡ exibida.')) {
                // Remove from header
                const logoImage = document.getElementById('logo-image');
                const logoText = document.getElementById('logo-text');
                
                logoImage.classList.add('hidden');
                logoText.classList.remove('hidden');
                
                // Remove from admin preview
                const adminLogoImage = document.getElementById('admin-logo-image');
                const adminLogoText = document.getElementById('admin-logo-text');
                
                adminLogoImage.classList.add('hidden');
                adminLogoText.classList.remove('hidden');
                
                // Remove from database
                if (db.connected) {
                    db.deleteImage('logo').then(() => {
                        db.showDBStatus('âœ… Logo removida do banco!');
                        console.log('âœ… Logo removida do Supabase');
                    }).catch(error => {
                        console.error('âŒ Erro ao remover logo:', error);
                    });
                }
                
                // Remove from localStorage
                try {
                    localStorage.removeItem('kc_logo');
                } catch (error) {
                    console.error('âŒ Erro ao remover logo do localStorage:', error);
                }
                
                alert('âœ… Logo removida com sucesso!\n\nğŸ”„ A logo padrÃ£o "KC" estÃ¡ sendo exibida.');
            }
        }

        function updateLogo(logoData) {
            const logoImage = document.getElementById('logo-image');
            const logoText = document.getElementById('logo-text');
            
            if (logoData) {
                logoImage.src = logoData;
                logoImage.classList.remove('hidden');
                logoText.classList.add('hidden');
            } else {
                logoImage.classList.add('hidden');
                logoText.classList.remove('hidden');
            }
        }

        function updateAdminLogoPreview(logoData) {
            const adminLogoImage = document.getElementById('admin-logo-image');
            const adminLogoText = document.getElementById('admin-logo-text');
            
            if (logoData) {
                adminLogoImage.src = logoData;
                adminLogoImage.classList.remove('hidden');
                adminLogoText.classList.add('hidden');
            } else {
                adminLogoImage.classList.add('hidden');
                adminLogoText.classList.remove('hidden');
            }
        }

        // Product Management
        function loadProducts() {
            const grid = document.getElementById('products-grid');
            let filteredProducts = products;

            if (currentBrand !== 'todas') {
                filteredProducts = filteredProducts.filter(p => p.brand === currentBrand);
            }

            if (currentFilter !== 'todos') {
                filteredProducts = filteredProducts.filter(p => p.category === currentFilter);
            }

            const brandNames = {
                'boticario': 'ğŸŒ¿ BoticÃ¡rio',
                'mary-kay': 'ğŸ’ Mary Kay',
                'eudora': 'âœ¨ Eudora',
                'natura': 'ğŸƒ Natura'
            };

            grid.innerHTML = filteredProducts.map(product => {
                const productImageHtml = product.imageUrl 
                    ? `<img src="${product.imageUrl}" alt="${product.name}" class="product-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <div class="product-image-placeholder" style="display: none;">${product.image}</div>`
                    : `<div class="product-image-placeholder">${product.image}</div>`;

                return `
                    <div class="product-card bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="p-0">
                            ${productImageHtml}
                        </div>
                        <div class="p-6">
                            <div class="text-xs text-purple-600 font-semibold mb-2 text-center">${brandNames[product.brand]}</div>
                            <h3 class="font-semibold text-lg mb-2">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-3">${product.description}</p>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-2xl font-bold text-purple-600">R$ ${product.price.toFixed(2)}</span>
                                <span class="text-sm text-gray-500">Estoque: ${product.stock}</span>
                            </div>
                            <button onclick="addToCart(${product.id})" 
                                    ${product.stock === 0 ? 'disabled' : ''}
                                    class="w-full py-2 px-4 rounded-lg font-semibold transition-all
                                    ${product.stock === 0 
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                        : 'bg-purple-600 text-white hover:bg-purple-700'}">
                                ${product.stock === 0 ? 'Sem Estoque' : 'ğŸ›’ Adicionar ao Carrinho'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProductGallery() {
            const gallery = document.getElementById('product-gallery');
            
            const brandNames = {
                'boticario': 'ğŸŒ¿ BoticÃ¡rio',
                'mary-kay': 'ğŸ’ Mary Kay',
                'eudora': 'âœ¨ Eudora',
                'natura': 'ğŸƒ Natura'
            };

            gallery.innerHTML = products.map(product => {
                const productImageHtml = product.imageUrl 
                    ? `<img src="${product.imageUrl}" alt="${product.name}" class="w-full h-32 object-cover rounded-lg mb-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center text-3xl mb-2" style="display: none;">${product.image}</div>`
                    : `<div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center text-3xl mb-2">${product.image}</div>`;

                return `
                    <div class="bg-gray-50 rounded-lg p-4">
                        ${productImageHtml}
                        <div class="text-xs text-purple-600 font-medium mb-1">${brandNames[product.brand]}</div>
                        <h4 class="font-semibold text-sm mb-1">${product.name}</h4>
                        <p class="text-xs text-gray-600 mb-2">R$ ${product.price.toFixed(2)}</p>
                        <div class="flex space-x-1">
                            <button onclick="editProduct(${product.id})" class="flex-1 bg-green-100 text-green-600 text-xs py-1 px-2 rounded hover:bg-green-200 transition-all">
                                âœï¸ Editar
                            </button>
                            <button onclick="editProductImage(${product.id})" class="flex-1 bg-blue-100 text-blue-600 text-xs py-1 px-2 rounded hover:bg-blue-200 transition-all">
                                ğŸ“· Foto
                            </button>
                            <button onclick="deleteProduct(${product.id})" class="flex-1 bg-red-100 text-red-600 text-xs py-1 px-2 rounded hover:bg-red-200 transition-all">
                                ğŸ—‘ï¸ Excluir
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const brandNames = {
                'boticario': 'ğŸŒ¿ BoticÃ¡rio',
                'mary-kay': 'ğŸ’ Mary Kay',
                'eudora': 'âœ¨ Eudora',
                'natura': 'ğŸƒ Natura'
            };

            // Create edit modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-lg max-w-md w-full p-6">
                    <h3 class="text-lg font-bold mb-4">âœï¸ Editar Produto</h3>
                    <form id="edit-product-form">
                        <input type="text" id="edit-name" value="${product.name}" placeholder="Nome do produto" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                        
                        <select id="edit-brand" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                            <option value="boticario" ${product.brand === 'boticario' ? 'selected' : ''}>ğŸŒ¿ BoticÃ¡rio</option>
                            <option value="mary-kay" ${product.brand === 'mary-kay' ? 'selected' : ''}>ğŸ’ Mary Kay</option>
                            <option value="eudora" ${product.brand === 'eudora' ? 'selected' : ''}>âœ¨ Eudora</option>
                            <option value="natura" ${product.brand === 'natura' ? 'selected' : ''}>ğŸƒ Natura</option>
                        </select>
                        
                        <select id="edit-category" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                            <option value="perfumes" ${product.category === 'perfumes' ? 'selected' : ''}>Perfumes</option>
                            <option value="cosmeticos" ${product.category === 'cosmeticos' ? 'selected' : ''}>CosmÃ©ticos</option>
                            <option value="cuidados" ${product.category === 'cuidados' ? 'selected' : ''}>Cuidados</option>
                        </select>
                        
                        <input type="number" id="edit-price" value="${product.price}" placeholder="PreÃ§o (R$)" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                        
                        <input type="number" id="edit-stock" value="${product.stock}" placeholder="Quantidade em estoque" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                        
                        <textarea id="edit-description" placeholder="DescriÃ§Ã£o do produto" class="w-full p-3 border border-gray-300 rounded-lg mb-4 h-20 focus:ring-2 focus:ring-purple-500">${product.description}</textarea>
                        
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-all">
                                âœ… Salvar
                            </button>
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all">
                                âŒ Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;

            document.body.appendChild(modal);

            // Handle form submission
            document.getElementById('edit-product-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Update product data
                product.name = document.getElementById('edit-name').value;
                product.brand = document.getElementById('edit-brand').value;
                product.category = document.getElementById('edit-category').value;
                product.price = parseFloat(document.getElementById('edit-price').value);
                product.stock = parseInt(document.getElementById('edit-stock').value);
                product.description = document.getElementById('edit-description').value;
                
                // Save to Supabase
                if (db.connected) {
                    await db.saveProduct(product);
                    db.showDBStatus('âœ… Produto atualizado!');
                }
                
                // Save to localStorage
                saveDataToStorage();
                
                // Update displays
                loadProducts();
                updateProductGallery();
                
                // Close modal
                modal.remove();
                
                alert('âœ… Produto atualizado com sucesso!');
            });
        }

        async function editProductImage(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        alert('Arquivo muito grande! O tamanho mÃ¡ximo Ã© 5MB.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = async function(e) {
                        product.imageUrl = e.target.result;
                        
                        // Salvar no banco de dados
                        if (db.db) {
                            await db.saveProduct(product);
                            await db.saveImage(`product_${product.id}`, e.target.result);
                        }
                        
                        loadProducts();
                        updateProductGallery();
                        alert('âœ… Foto do produto atualizada e salva no banco!');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            fileInput.click();
        }

        async function deleteProduct(productId) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                // Remover do array local
                products = products.filter(p => p.id !== productId);
                
                // Remover do banco de dados
                if (db.db) {
                    await db.deleteProduct(productId);
                    await db.deleteImage(`product_${productId}`);
                }
                
                loadProducts();
                updateProductGallery();
                updateStockList();
                updateSalesReport();
                alert('âœ… Produto excluÃ­do do banco de dados!');
            }
        }

        function filterByBrand(brand) {
            currentBrand = brand;
            
            document.querySelectorAll('.brand-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.add('active', 'bg-purple-600', 'text-white');
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            
            loadProducts();
        }

        function filterProducts(category) {
            currentFilter = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.add('active', 'bg-indigo-600', 'text-white');
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            
            loadProducts();
        }

        // Cart Management
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock === 0) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                }
            } else {
                cart.push({
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    image: product.image,
                    imageUrl: product.imageUrl
                });
            }
            
            updateCartDisplay();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCartDisplay();
        }

        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (item && product) {
                const newQuantity = item.quantity + change;
                if (newQuantity > 0 && newQuantity <= product.stock) {
                    item.quantity = newQuantity;
                } else if (newQuantity <= 0) {
                    removeFromCart(productId);
                }
            }
            updateCartDisplay();
        }

        function updateCartDisplay() {
            const cartItems = document.getElementById('cart-items');
            const cartCount = document.getElementById('cart-count');
            const cartTotal = document.getElementById('cart-total');

            cartCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);

            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Carrinho vazio</p>';
                cartTotal.textContent = 'R$ 0,00';
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            cartTotal.textContent = `R$ ${total.toFixed(2)}`;

            cartItems.innerHTML = cart.map(item => {
                const itemImageHtml = item.imageUrl 
                    ? `<img src="${item.imageUrl}" alt="${item.name}" class="w-12 h-12 object-cover rounded" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                       <span class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-xl" style="display: none;">${item.image}</span>`
                    : `<span class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-xl">${item.image}</span>`;

                return `
                    <div class="flex items-center justify-between py-3 border-b border-gray-200">
                        <div class="flex items-center space-x-3">
                            ${itemImageHtml}
                            <div>
                                <h4 class="font-semibold">${item.name}</h4>
                                <p class="text-purple-600 font-semibold">R$ ${item.price.toFixed(2)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateQuantity(${item.id}, -1)" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300">-</button>
                            <span class="w-8 text-center">${item.quantity}</span>
                            <button onclick="updateQuantity(${item.id}, 1)" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300">+</button>
                            <button onclick="removeFromCart(${item.id})" class="ml-2 text-red-500 hover:text-red-700">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('overlay');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('hidden');
        }

        // WhatsApp Purchase Function
        async function finalizePurchaseWhatsApp() {
            if (cart.length === 0) {
                alert('Seu carrinho estÃ¡ vazio!');
                return;
            }

            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            let message = `ğŸ›ï¸ *PEDIDO KC PERFUMARIA* ğŸ’œ\n\n`;
            
            message += `ğŸ“¦ *PRODUTOS:*\n`;
            cart.forEach((item, index) => {
                message += `${index + 1}. ${item.name}\n`;
                message += `   Qtd: ${item.quantity}x - R$ ${(item.price * item.quantity).toFixed(2)}\n\n`;
            });
            
            message += `ğŸ’° *TOTAL: R$ ${total.toFixed(2)}*\n\n`;
            message += `OlÃ¡! Gostaria de fazer este pedido. Podemos combinar a entrega? ğŸ˜Š`;

            try {
                // Update stock
                for (const item of cart) {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        product.stock -= item.quantity;
                        
                        // Update in Supabase
                        if (db.connected) {
                            await db.saveProduct(product);
                        }
                    }
                }

                // Record sale
                const sale = {
                    id: Date.now(),
                    items: [...cart],
                    total: total,
                    payment_method: 'WhatsApp',
                    date: new Date().toISOString(),
                    date_formatted: new Date().toLocaleDateString('pt-BR')
                };
                
                sales.push(sale);
                
                // Save to Supabase
                if (db.connected) {
                    try {
                        await db.saveSale(sale);
                        db.showDBStatus('âœ… Venda registrada no Supabase!');
                        console.log('âœ… Venda salva no Supabase:', sale.id);
                    } catch (error) {
                        console.error('âŒ Erro ao salvar venda no Supabase:', error);
                    }
                }
                
                // Save to localStorage
                saveDataToStorage();

                // Open WhatsApp
                const whatsappUrl = `https://wa.me/${STORE_CONFIG.whatsapp}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');

                // Clear cart and close sidebar
                cart = [];
                updateCartDisplay();
                toggleCart();
                loadProducts();
                updateStockList();
                updateSalesReport();

                // Show success message
                alert('ğŸ‰ Pedido enviado para o WhatsApp! Estoque atualizado automaticamente.');
                
            } catch (error) {
                console.error('âŒ Erro ao processar venda:', error);
                // Error message removed - process continues silently
            }
        }

        // Admin Functions
        function backToStore() {
            const customerView = document.getElementById('customer-view');
            const adminPanel = document.getElementById('admin-panel');
            
            customerView.style.display = 'block';
            adminPanel.style.display = 'none';
            
            // Remove admin parameter from URL without reloading page
            const url = new URL(window.location);
            url.searchParams.delete('admin');
            window.history.replaceState({}, document.title, url.pathname + url.search);
            
            // Clear admin session
            sessionStorage.removeItem('kc_admin_access');
        }

        document.getElementById('add-product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            console.log('ğŸ“ === INICIANDO ADIÃ‡ÃƒO DE PRODUTO ===');
            
            const newProduct = {
                id: Date.now(),
                name: document.getElementById('product-name').value.trim(),
                brand: document.getElementById('product-brand').value,
                category: document.getElementById('product-category').value,
                price: parseFloat(document.getElementById('product-price').value),
                stock: parseInt(document.getElementById('product-stock').value),
                description: document.getElementById('product-description').value.trim(),
                image: getRandomEmoji(),
                imageUrl: currentProductImage,
                created_at: new Date().toISOString()
            };

            // Validate required fields
            if (!newProduct.name || !newProduct.brand || !newProduct.category || isNaN(newProduct.price) || isNaN(newProduct.stock)) {
                alert('âŒ Por favor, preencha todos os campos obrigatÃ³rios!');
                return;
            }

            console.log('ğŸ“¦ Produto criado:', {
                id: newProduct.id,
                name: newProduct.name,
                brand: newProduct.brand,
                category: newProduct.category,
                price: newProduct.price,
                stock: newProduct.stock
            });

            try {
                // STEP 1: Check current state
                console.log(`ğŸ“Š Estado ANTES: ${products.length} produtos na memÃ³ria`);
                
                // STEP 2: Add to memory
                products.push(newProduct);
                console.log(`ğŸ“Š Estado DEPOIS: ${products.length} produtos na memÃ³ria`);
                console.log('âœ… Produto adicionado Ã  memÃ³ria');
                
                // STEP 3: CRITICAL SAVE - Multiple attempts
                console.log('ğŸ’¾ === INICIANDO SALVAMENTO CRÃTICO ===');
                
                let saveAttempts = 0;
                let saveSuccess = false;
                
                while (saveAttempts < 3 && !saveSuccess) {
                    saveAttempts++;
                    console.log(`ğŸ’¾ Tentativa de salvamento ${saveAttempts}/3...`);
                    
                    saveSuccess = saveDataToStorage();
                    
                    if (saveSuccess) {
                        console.log(`âœ… Salvamento bem-sucedido na tentativa ${saveAttempts}`);
                        break;
                    } else {
                        console.error(`âŒ Falha na tentativa ${saveAttempts}`);
                        if (saveAttempts < 3) {
                            console.log('ğŸ”„ Aguardando 1 segundo antes da prÃ³xima tentativa...');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                if (!saveSuccess) {
                    console.error('âŒ FALHA CRÃTICA: Todas as tentativas de salvamento falharam');
                    products.pop(); // Remove from memory
                    alert('âŒ ERRO CRÃTICO: NÃ£o foi possÃ­vel salvar o produto apÃ³s 3 tentativas.\n\nVerifique:\nâ€¢ EspaÃ§o disponÃ­vel no navegador\nâ€¢ Se nÃ£o hÃ¡ outros sites usando muito armazenamento\nâ€¢ Tente fechar outras abas');
                    return;
                }
                
                // STEP 4: Verify save immediately
                console.log('ğŸ” === VERIFICAÃ‡ÃƒO IMEDIATA ===');
                const verification = localStorage.getItem('kc_store_data');
                if (verification) {
                    try {
                        const parsed = JSON.parse(verification);
                        const savedCount = parsed.products ? parsed.products.length : 0;
                        console.log(`ğŸ” VerificaÃ§Ã£o: ${savedCount} produtos salvos no localStorage`);
                        
                        if (savedCount === products.length) {
                            console.log('âœ… VerificaÃ§Ã£o PASSOU: Dados salvos corretamente');
                        } else {
                            console.error(`âŒ VerificaÃ§Ã£o FALHOU: Esperado ${products.length}, encontrado ${savedCount}`);
                        }
                    } catch (verifyError) {
                        console.error('âŒ Erro na verificaÃ§Ã£o:', verifyError);
                    }
                } else {
                    console.error('âŒ VerificaÃ§Ã£o FALHOU: Dados nÃ£o encontrados no localStorage');
                }
                
                // STEP 5: Try Supabase (optional)
                if (db.connected) {
                    try {
                        console.log('â˜ï¸ Tentando salvar no Supabase...');
                        const supabaseSuccess = await db.saveProduct(newProduct);
                        
                        if (supabaseSuccess) {
                            if (currentProductImage) {
                                await db.saveImage(`product_${newProduct.id}`, currentProductImage);
                            }
                            db.showDBStatus('âœ… Produto salvo no Supabase!');
                            console.log('âœ… Produto salvo no Supabase');
                        } else {
                            console.warn('âš ï¸ Falha no Supabase, mas localStorage funcionou');
                        }
                    } catch (supabaseError) {
                        console.error('âŒ Erro no Supabase:', supabaseError);
                        console.log('âœ… Produto salvo apenas no localStorage');
                    }
                } else {
                    console.log('âš ï¸ Supabase desconectado, produto salvo no localStorage');
                }
                
                // STEP 6: Update interface
                console.log('ğŸ”„ Atualizando interface...');
                loadProducts();
                updateProductGallery();
                
                // STEP 7: Reset form
                console.log('ğŸ§¹ Limpando formulÃ¡rio...');
                this.reset();
                currentProductImage = null;
                
                const previewContainer = document.getElementById('image-preview-container');
                const uploadPlaceholder = document.getElementById('upload-placeholder');
                if (previewContainer && uploadPlaceholder) {
                    previewContainer.classList.add('hidden');
                    uploadPlaceholder.classList.remove('hidden');
                }
                
                const imageInput = document.getElementById('product-image-input');
                if (imageInput) {
                    imageInput.value = '';
                }
                
                // STEP 8: Final verification
                console.log('ğŸ === VERIFICAÃ‡ÃƒO FINAL ===');
                setTimeout(() => {
                    const finalCheck = localStorage.getItem('kc_store_data');
                    if (finalCheck) {
                        try {
                            const parsed = JSON.parse(finalCheck);
                            const finalCount = parsed.products ? parsed.products.length : 0;
                            console.log(`ğŸ VerificaÃ§Ã£o final: ${finalCount} produtos persistidos`);
                            
                            if (finalCount === products.length) {
                                console.log('ğŸ‰ SUCESSO TOTAL: Produto salvo e persistido com sucesso!');
                            } else {
                                console.error('âŒ PROBLEMA: Dados podem nÃ£o ter sido persistidos corretamente');
                            }
                        } catch (finalError) {
                            console.error('âŒ Erro na verificaÃ§Ã£o final:', finalError);
                        }
                    }
                }, 2000);
                
                console.log('âœ… === PRODUTO ADICIONADO COM SUCESSO ===');
                alert(`âœ… Produto "${newProduct.name}" adicionado com sucesso!\n\nğŸ’¾ Dados salvos e verificados\nğŸ“Š Total de produtos: ${products.length}\n\nğŸ”„ Atualize a pÃ¡gina para confirmar que o produto foi salvo permanentemente!`);
                
            } catch (error) {
                console.error('âŒ === ERRO CRÃTICO ===', error);
                
                // Remove from memory if save failed
                const index = products.findIndex(p => p.id === newProduct.id);
                if (index > -1) {
                    products.splice(index, 1);
                    console.log('ğŸ”„ Produto removido da memÃ³ria devido ao erro');
                }
                
                alert(`âŒ ERRO CRÃTICO ao salvar produto!\n\nDetalhes do erro:\n${error.message}\n\nVerifique o console (F12) para mais informaÃ§Ãµes.`);
            }
        });

        function getRandomEmoji() {
            const emojis = ['ğŸŒ¸', 'ğŸ’„', 'ğŸ§´', 'âœ¨', 'ğŸ’', 'ğŸŒº', 'ğŸ€', 'ğŸ’‹', 'ğŸŒ·', 'ğŸ¦‹'];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        // Simplified admin functions - only product management

        // Placeholder functions for future features
        function loadStoreConfig() {
            console.log('Store config loaded');
        }

        function updateConfigForm() {
            console.log('Config form updated');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e3dbde61807a84',t:'MTc1NTA0MjQ1Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
