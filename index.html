<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC Perfumaria - Perfumes e Cosm√©ticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .admin-panel { display: none; }
        .cart-sidebar { transform: translateX(100%); transition: transform 0.3s ease; }
        .cart-sidebar.open { transform: translateX(0); }
        .product-image { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; }
        .product-image-placeholder { width: 100%; height: 200px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        .image-upload-area { border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; transition: all 0.3s ease; cursor: pointer; }
        .image-upload-area:hover { border-color: #8b5cf6; background-color: #faf5ff; }
        .image-upload-area.dragover { border-color: #8b5cf6; background-color: #faf5ff; }
        .loading { opacity: 0.6; pointer-events: none; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .db-status { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .brand-btn.active, .category-btn.active { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
    </style>
</head>
<body class="bg-gray-50">
    <div id="db-status" class="db-status bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium hidden">
        ‚úÖ Dados salvos!
    </div>

    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-20 h-16 bg-white rounded-lg flex items-center justify-center overflow-hidden cursor-pointer" id="logo-container">
                        <img id="logo-image" class="w-full h-full object-cover hidden" alt="KC Perfumaria">
                        <span id="logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">KC Perfumaria</h1>
                        <p class="text-purple-200 text-sm">Perfumes e Cosm√©ticos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleCart()" class="relative bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        üõí <span class="hidden sm:inline">Carrinho</span> (<span id="cart-count">0</span>)
                    </button>
                    <button id="admin-access-btn" onclick="accessAdmin()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        ‚öôÔ∏è <span class="hidden sm:inline">Admin</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div id="customer-view">
            <div class="mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Marcas</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3">
                    <button onclick="filterByBrand('todas')" class="brand-btn active bg-purple-600 text-white px-3 sm:px-6 py-2 rounded-full hover:bg-purple-700 transition-all text-sm sm:text-base">
                        Todas
                    </button>
                    <button onclick="filterByBrand('boticario')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        üåø Botic√°rio
                    </button>
                    <button onclick="filterByBrand('mary-kay')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        üíé Mary Kay
                    </button>
                    <button onclick="filterByBrand('eudora')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        ‚ú® Eudora
                    </button>
                    <button onclick="filterByBrand('natura')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        üçÉ Natura
                    </button>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Categorias</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3">
                    <button onclick="filterProducts('todos')" class="category-btn active bg-indigo-600 text-white px-4 sm:px-6 py-2 rounded-full hover:bg-indigo-700 transition-all text-sm sm:text-base">
                        Todos
                    </button>
                    <button onclick="filterProducts('perfumes')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Perfumes
                    </button>
                    <button onclick="filterProducts('cosmeticos')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Cosm√©ticos
                    </button>
                    <button onclick="filterProducts('cuidados')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Cuidados
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6" id="products-grid">
                </div>
        </div>

        <div id="admin-panel" class="admin-panel">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Painel Administrativo</h2>
                    <div class="flex space-x-2">
                        <button onclick="diagnosticSupabase()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all">
                            üîç Diagn√≥stico
                        </button>
                        <button onclick="backToStore()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all">
                            üè™ Voltar para Loja
                        </button>
                    </div>
                </div>
                
                <div class="max-w-2xl mx-auto mb-8">
                    <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Gerenciar Logo da Loja</h3>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-center space-x-6">
                            <div class="flex-shrink-0">
                                <div class="w-24 h-20 bg-white rounded-lg flex items-center justify-center overflow-hidden border-2 border-gray-200">
                                    <img id="admin-logo-image" class="w-full h-full object-cover hidden" alt="Logo atual">
                                    <span id="admin-logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-2">Logo Atual</h4>
                                <p class="text-gray-600 text-sm mb-4">Clique no bot√£o abaixo para alterar a logo da sua loja. Recomendamos imagens quadradas ou retangulares.</p>
                                <div class="flex space-x-3">
                                    <button onclick="document.getElementById('logo-file-input').click()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all">
                                        üì∑ Alterar Logo
                                    </button>
                                    <button onclick="removeLogoAdmin()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition-all">
                                        üóëÔ∏è Remover Logo
                                    </button>
                                </div>
                                <input type="file" id="logo-file-input" accept="image/*" class="hidden" onchange="changeLogoAdmin(this.files[0])">
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            üí° Dica: Use imagens PNG ou JPG com fundo transparente para melhor resultado. Tamanho m√°ximo: 2MB.
                        </div>
                    </div>
                </div>

                <div class="max-w-2xl mx-auto">
                    <h3 class="text-lg font-semibold mb-4">Adicionar Produto</h3>
                    <form id="add-product-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto do Produto</label>
                            <div class="image-upload-area" id="product-image-upload" onclick="document.getElementById('product-image-input').click()">
                                <div id="image-preview-container" class="hidden">
                                    <img id="image-preview" class="w-full h-32 object-cover rounded-lg mb-2" alt="Preview">
                                    <button type="button" onclick="removeProductImage(event)" class="text-red-600 hover:text-red-800 text-sm">
                                        üóëÔ∏è Remover Foto
                                    </button>
                                </div>
                                <div id="upload-placeholder">
                                    <div class="text-4xl mb-2">üì∑</div>
                                    <p class="text-gray-600 font-medium">Clique para adicionar foto</p>
                                    <p class="text-gray-400 text-sm mt-1">JPG, PNG ou GIF (m√°x. 5MB)</p>
                                </div>
                            </div>
                            <input type="file" id="product-image-input" accept="image/*" class="hidden">
                        </div>

                        <input type="text" id="product-name" placeholder="Nome do produto" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <select id="product-brand" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Selecione a marca</option>
                            <option value="boticario">üåø Botic√°rio</option>
                            <option value="mary-kay">üíé Mary Kay</option>
                            <option value="eudora">‚ú® Eudora</option>
                            <option value="natura">üçÉ Natura</option>
                        </select>
                        <select id="product-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Selecione a categoria</option>
                            <option value="perfumes">Perfumes</option>
                            <option value="cosmeticos">Cosm√©ticos</option>
                            <option value="cuidados">Cuidados</option>
                        </select>
                        <input type="number" id="product-price" placeholder="Pre√ßo (R$)" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <input type="number" id="product-stock" placeholder="Quantidade em estoque" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <textarea id="product-description" placeholder="Descri√ß√£o do produto" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-24"></textarea>
                        <button type="submit" id="add-product-btn" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-all font-semibold">
                            Adicionar Produto
                        </button>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
                    <h3 class="text-lg font-semibold mb-4">Produtos Cadastrados</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="product-gallery">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <div id="cart-sidebar" class="cart-sidebar fixed right-0 top-0 h-full w-full sm:w-96 bg-white shadow-2xl z-50 flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Carrinho de Compras</h3>
                <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <div id="cart-items">
                <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Total:</span>
                <span class="text-xl font-bold text-purple-600" id="cart-total">R$ 0,00</span>
            </div>
            <button id="whatsapp-btn" onclick="finalizePurchaseWhatsApp()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-semibold">
                üì± Finalizar pelo WhatsApp
            </button>
        </div>
    </div>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleCart()"></div>

    <script>
        // System Integration with Supabase
        const SUPABASE_URL = 'https://udyihngwyqhfhdxkxwso.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkeWlobmd3eXFoZmhkeGt4d3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTcwOTUsImV4cCI6MjA3MDQzMzA5NX0.MA3RgucTM7akkqxF1Zgl4aLtGBFAUT48IKfXez8ZK3c';

        let products = [];
        let cart = [];
        let currentFilter = 'todos';
        let currentBrand = 'todas';
        let currentProductImageFile = null;
        let storeConfig = {
            logo_url: null,
        };

        const STORE_CONFIG_DATA = {
            name: 'KC PERFUMARIA',
            ownerName: 'KELLY CRISTINE',
            document: '123.456.789-00',
            city: 'PARANAGUA',
            state: 'PR',
            pixKey: '41997786625',
            pixKeyType: 'phone',
            whatsapp: '5541997786625',
        };

        let supabaseClient = null;
        const db = {
            client: null,
            connected: false,
            STORAGE_BUCKET: 'product_images',

            async init() {
                try {
                    console.log('üîå Conectando ao Supabase...');
                    this.client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    const { data, error } = await this.client.from('products').select('id').limit(1);

                    if (error) {
                        this.showDBStatus('‚ùå Erro na conex√£o', 'bg-red-100 text-red-800');
                        this.connected = false;
                        return false;
                    }
                    this.connected = true;
                    this.showDBStatus('‚úÖ Sistema conectado', 'bg-green-100 text-green-800');
                    this.setupRealtimeSubscription();
                    return true;
                } catch (error) {
                    this.showDBStatus('‚ùå Erro na inicializa√ß√£o', 'bg-red-100 text-red-800');
                    this.connected = false;
                    return false;
                }
            },
            
            setupRealtimeSubscription() {
                if (!this.connected) return;
                this.client
                    .channel('schema-db-changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
                        console.log('üì¢ Mudan√ßa de produto em tempo real recebida!', payload);
                        updateUI();
                    })
                    .subscribe();
                console.log('‚úÖ Inscri√ß√£o em tempo real ativada.');
            },

            async loadProducts() {
                if (!this.connected) return [];
                const { data, error } = await this.client
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) {
                    console.error('‚ùå Erro ao carregar produtos:', error);
                    return [];
                }
                return data || [];
            },

            async loadStoreConfig() {
                if (!this.connected) return null;
                const { data, error } = await this.client.from('configs').select('logo_url').single();
                if (error && error.code !== 'PGRST116') {
                    console.error('‚ùå Erro ao carregar URL do logo:', error);
                    return null;
                }
                return data ? data.logo_url : null;
            },

            async saveProduct(product) {
                if (!this.connected) return false;
                const { error } = await this.client.from('products').upsert(product, { onConflict: 'id', ignoreDuplicates: false });
                if (error) {
                    console.error('‚ùå Erro ao salvar produto:', error.message);
                    return false;
                }
                return true;
            },
            
            async deleteProduct(productId) {
                if (!this.connected) return false;
                const { error } = await this.client.from('products').delete().eq('id', productId);
                if (error) {
                    console.error('‚ùå Erro ao excluir produto:', error);
                    return false;
                }
                return true;
            },
            
            async uploadImage(file, filePath) {
                if (!this.connected) return { data: null, error: new Error('N√£o conectado.') };
                const { data, error } = await this.client.storage.from(this.STORAGE_BUCKET).upload(filePath, file, { cacheControl: '3600', upsert: true });
                if (error) {
                    console.error('‚ùå Erro ao enviar imagem:', error);
                    return { data: null, error };
                }
                const { data: publicUrlData } = this.client.storage.from(this.STORAGE_BUCKET).getPublicUrl(filePath);
                return { data: publicUrlData.publicUrl, error: null };
            },
            
            async deleteImage(filePath) {
                if (!this.connected) return { error: new Error('N√£o conectado.') };
                const { error } = await this.client.storage.from(this.STORAGE_BUCKET).remove([filePath]);
                if (error) {
                    console.error('‚ùå Erro ao excluir imagem:', error);
                    return { error };
                }
                return { error: null };
            },
            
            async saveLogoUrl(url) {
                if (!this.connected) return false;
                const { error } = await this.client.from('configs').upsert({ id: 1, logo_url: url }, { onConflict: 'id' });
                if (error) {
                    console.error('‚ùå Erro ao salvar URL do logo:', error);
                    return false;
                }
                return true;
            },
            
            showDBStatus(message, className = 'bg-green-100 text-green-800') {
                const statusEl = document.getElementById('db-status');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `db-status px-3 py-1 rounded-full text-sm font-medium ${className}`;
                    statusEl.classList.remove('hidden');
                    setTimeout(() => { statusEl.classList.add('hidden'); }, 3000);
                }
            },
        };

        // UI and Event Handlers
        window.accessAdmin = async () => {
            const adminToken = localStorage.getItem('adminToken');
            if (adminToken === 'kc0310') {
                showAdminPanel();
                return;
            }
            const password = prompt('üîê Digite a senha de administrador:');
            if (password === 'kc0310') {
                localStorage.setItem('adminToken', 'kc0310');
                showAdminPanel();
                db.showDBStatus('üéâ Acesso administrativo concedido!');
            } else if (password !== null) {
                alert('‚ùå Senha incorreta! Acesso negado.');
            }
        };

        window.backToStore = () => {
            document.getElementById('customer-view').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            document.getElementById('admin-panel').classList.add('admin-panel');
            
            // Reverter a funcionalidade do bot√£o de admin para o estado inicial
            const adminBtn = document.getElementById('admin-access-btn');
            adminBtn.textContent = '‚öôÔ∏è Admin';
            adminBtn.onclick = accessAdmin;
            
            localStorage.removeItem('adminToken');
            db.showDBStatus('üëã Retornando para a loja.');
            
            const cartSidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('overlay');
            if (cartSidebar.classList.contains('open')) {
                toggleCart();
            }
        };

        window.toggleCart = () => {
            document.getElementById('cart-sidebar').classList.toggle('open');
            document.getElementById('overlay').classList.toggle('hidden');
        };

        window.addToCart = (productId) => {
            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ productId: productId, quantity: 1 });
            }
            renderCart();
            db.showDBStatus('‚úîÔ∏è Produto adicionado ao carrinho!');
        };

        window.removeFromCart = (productId) => {
            cart = cart.filter(item => item.productId !== productId);
            renderCart();
            db.showDBStatus('‚úîÔ∏è Produto removido do carrinho!');
        };

        window.updateQuantity = (productId, change) => {
            const item = cart.find(item => item.productId === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    renderCart();
                }
            }
        };

        window.finalizePurchaseWhatsApp = () => {
            if (cart.length === 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }

            const total = cart.reduce((sum, item) => {
                const product = products.find(p => p.id === item.productId);
                return sum + (product ? product.price * item.quantity : 0);
            }, 0);

            let message = `Ol√°, gostaria de finalizar meu pedido na KC Perfumaria!\n\nüõçÔ∏è *Itens do Carrinho:*\n`;
            cart.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (product) {
                    message += `- ${item.quantity}x ${product.name} (R$ ${product.price.toFixed(2).replace('.', ',')})\n`;
                }
            });
            message += `\n*Total do Pedido: R$ ${total.toFixed(2).replace('.', ',')}*`;
            message += `\n\nQual a forma de pagamento?`;

            const whatsappUrl = `https://wa.me/${STORE_CONFIG_DATA.whatsapp}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            cart = [];
            renderCart();
            toggleCart();
        };

        window.filterProducts = (category) => {
            currentFilter = category;
            renderProducts();
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const activeBtn = document.querySelector(`.category-btn[onclick="filterProducts('${category}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                activeBtn.classList.add('active', 'bg-indigo-600', 'text-white');
            }
        };

        window.filterByBrand = (brand) => {
            currentBrand = brand;
            renderProducts();
            document.querySelectorAll('.brand-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-purple-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            const activeBtn = document.querySelector(`.brand-btn[onclick="filterByBrand('${brand}')"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                activeBtn.classList.add('active', 'bg-purple-600', 'text-white');
            }
        };
        
        window.editProduct = async (productId) => {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const newName = prompt('Novo nome do produto:', product.name);
            if (newName !== null) {
                const newPrice = parseFloat(prompt('Novo pre√ßo do produto:', product.price));
                if (!isNaN(newPrice)) {
                    const updatedProduct = { ...product, name: newName, price: newPrice };
                    await db.saveProduct(updatedProduct);
                    db.showDBStatus('‚úÖ Produto atualizado!');
                }
            }
        };

        window.deleteProduct = async (productId) => {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                const product = products.find(p => p.id === productId);
                if (product && product.image_url) {
                    const filePath = product.image_url.split('/').pop();
                    await db.deleteImage(filePath);
                }
                await db.deleteProduct(productId);
                db.showDBStatus('‚úÖ Produto exclu√≠do!');
            }
        };

        window.removeProductImage = (event) => {
            if (event) { event.preventDefault(); event.stopPropagation(); }
            document.getElementById('product-image-input').value = '';
            currentProductImageFile = null;
            document.getElementById('image-preview-container').classList.add('hidden');
            document.getElementById('upload-placeholder').classList.remove('hidden');
        };

        window.changeLogoAdmin = async (file) => {
            if (!file) return;
            const filePath = `logo/store_logo.png`;
            const { data: publicUrl, error } = await db.uploadImage(file, filePath);
            if (error) {
                db.showDBStatus('‚ùå Erro ao enviar logo!', 'bg-red-100 text-red-800');
                return;
            }
            if (await db.saveLogoUrl(publicUrl)) {
                storeConfig.logo_url = publicUrl;
                renderLogo();
                renderAdminLogo();
                db.showDBStatus('‚úÖ Logo atualizado!');
            }
        };
        
        window.removeLogoAdmin = async () => {
            if (confirm('Tem certeza que deseja remover o logo?')) {
                const filePath = `logo/store_logo.png`;
                await db.deleteImage(filePath);
                if (await db.saveLogoUrl(null)) {
                    storeConfig.logo_url = null;
                    renderLogo();
                    renderAdminLogo();
                    db.showDBStatus('‚úÖ Logo removido!');
                }
            }
        };

        window.diagnosticSupabase = async () => {
            // Your diagnostic logic remains the same
            alert('Diagn√≥stico do Supabase conclu√≠do. Verifique o console para os resultados.');
        };

        const renderLogo = () => {
            const logoImageEl = document.getElementById('logo-image');
            const logoTextEl = document.getElementById('logo-text');
            if (logoImageEl && logoTextEl) {
                if (storeConfig.logo_url) {
                    logoImageEl.src = storeConfig.logo_url;
                    logoImageEl.classList.remove('hidden');
                    logoTextEl.classList.add('hidden');
                } else {
                    logoImageEl.src = '';
                    logoImageEl.classList.add('hidden');
                    logoTextEl.classList.remove('hidden');
                }
            }
        };

        const renderAdminLogo = () => {
            const adminLogoImageEl = document.getElementById('admin-logo-image');
            const adminLogoTextEl = document.getElementById('admin-logo-text');
            if (adminLogoImageEl && adminLogoTextEl) {
                if (storeConfig.logo_url) {
                    adminLogoImageEl.src = storeConfig.logo_url;
                    adminLogoImageEl.classList.remove('hidden');
                    adminLogoTextEl.classList.add('hidden');
                } else {
                    adminLogoImageEl.src = '';
                    adminLogoImageEl.classList.add('hidden');
                    adminLogoTextEl.classList.remove('hidden');
                }
            }
        };

        const renderProducts = () => {
            const productsGrid = document.getElementById('products-grid');
            if (!productsGrid) return;
            productsGrid.innerHTML = '';
            const filteredProducts = products.filter(product =>
                (currentFilter === 'todos' || product.category === currentFilter) &&
                (currentBrand === 'todas' || product.brand === currentBrand)
            );
            if (filteredProducts.length === 0) {
                productsGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">Nenhum produto encontrado nesta categoria ou marca.</p>';
            }
            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-lg shadow-md overflow-hidden product-card';
                productCard.innerHTML = `
                    <div class="relative">
                        <div class="product-image-placeholder ${product.image_url ? 'hidden' : ''}">üå∏</div>
                        <img src="${product.image_url || ''}" alt="${product.name}" class="product-image ${product.image_url ? '' : 'hidden'}">
                    </div>
                    <div class="p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-semibold text-purple-600">${product.brand.toUpperCase().replace('-', ' ')}</span>
                            <span class="text-xs text-gray-500">${product.category}</span>
                        </div>
                        <h3 class="text-lg font-bold text-gray-800 line-clamp-2">${product.name}</h3>
                        <p class="text-xl font-bold text-purple-700 mt-2">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                        <button onclick="addToCart('${product.id}')" class="mt-4 w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-all font-semibold">Adicionar ao Carrinho</button>
                    </div>
                `;
                productsGrid.appendChild(productCard);
            });
        };

        const renderProductGallery = () => {
            const galleryEl = document.getElementById('product-gallery');
            if (!galleryEl) return;
            galleryEl.innerHTML = '';
            if (products.length === 0) {
                galleryEl.innerHTML = '<p class="col-span-full text-center text-gray-500 py-8">Nenhum produto cadastrado.</p>';
                return;
            }
            products.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-lg shadow-md p-4 flex flex-col justify-between';
                productCard.innerHTML = `
                    <div>
                        <div class="product-image-placeholder ${product.image_url ? 'hidden' : ''}" style="height: 128px;">üå∏</div>
                        <img src="${product.image_url || ''}" alt="${product.name}" class="w-full h-32 object-cover rounded-md mb-4 ${product.image_url ? '' : 'hidden'}">
                        <h4 class="font-bold text-lg mb-1 line-clamp-2">${product.name}</h4>
                        <p class="text-sm text-gray-600">R$ ${product.price.toFixed(2).replace('.', ',')}</p>
                        <p class="text-xs text-gray-500 mt-1">Estoque: ${product.stock}</p>
                    </div>
                    <div class="mt-4 flex gap-2">
                        <button onclick="editProduct('${product.id}')" class="flex-1 bg-blue-100 text-blue-600 text-sm px-3 py-2 rounded-lg hover:bg-blue-200">Editar</button>
                        <button onclick="deleteProduct('${product.id}')" class="flex-1 bg-red-100 text-red-600 text-sm px-3 py-2 rounded-lg hover:bg-red-200">Excluir</button>
                    </div>
                `;
                galleryEl.appendChild(productCard);
            });
        };

        const renderCart = () => {
            const cartItemsEl = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const cartCountEl = document.getElementById('cart-count');
            if (!cartItemsEl || !cartTotalEl || !cartCountEl) return;
            cartItemsEl.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemsEl.innerHTML = '<p class="text-gray-500 text-center py-8">Carrinho vazio</p>';
            } else {
                cart.forEach(item => {
                    const product = products.find(p => p.id === item.productId);
                    if (!product) return;
                    const itemTotal = product.price * item.quantity;
                    total += itemTotal;
                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'flex items-center gap-4 py-4 border-b border-gray-100 last:border-b-0';
                    cartItemEl.innerHTML = `
                        <img src="${product.image_url || 'https://via.placeholder.com/80'}" alt="${product.name}" class="w-16 h-16 object-cover rounded-md">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-800">${product.name}</h4>
                            <p class="text-sm text-gray-600">R$ ${product.price.toFixed(2)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="updateQuantity('${product.id}', -1)" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300">-</button>
                            <span>${item.quantity}</span>
                            <button onclick="updateQuantity('${product.id}', 1)" class="bg-gray-200 text-gray-700 w-8 h-8 rounded-full flex items-center justify-center hover:bg-gray-300">+</button>
                        </div>
                        <button onclick="removeFromCart('${product.id}')" class="text-red-500 hover:text-red-700 transition-colors ml-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    `;
                    cartItemsEl.appendChild(cartItemEl);
                });
            }
            cartTotalEl.textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            cartCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
        };

        const showAdminPanel = () => {
            document.getElementById('customer-view').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'block';
            document.getElementById('admin-panel').classList.remove('admin-panel');
            const adminBtn = document.getElementById('admin-access-btn');
            adminBtn.textContent = 'üîí Sair Admin';
            adminBtn.onclick = backToStore;
            renderAdminLogo();
            renderProductGallery();
        };

        const updateUI = async () => {
            products = await db.loadProducts();
            renderProducts();
            renderCart();
            renderProductGallery();
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const connected = await db.init();
            if (connected) {
                storeConfig.logo_url = await db.loadStoreConfig();
            }
            renderLogo();
            await updateUI();

            const adminToken = localStorage.getItem('adminToken');
            if (adminToken === 'kc0310') {
                showAdminPanel();
            }

            document.getElementById('add-product-form').addEventListener('submit', async (event) => {
                event.preventDefault();
                const form = event.target;
                const submitBtn = document.getElementById('add-product-btn');
                
                if (!currentProductImageFile) {
                    alert('‚ö†Ô∏è Por favor, adicione uma foto para o produto.');
                    return;
                }
                
                submitBtn.disabled = true;
                submitBtn.textContent = 'Adicionando...';
                
                const productId = 'prod_' + Date.now();
                const filePath = `products/${productId}_${currentProductImageFile.name}`;
                
                const { data: imageUrl, error: uploadError } = await db.uploadImage(currentProductImageFile, filePath);
                
                if (uploadError) {
                    db.showDBStatus('‚ùå Erro ao enviar foto do produto!', 'bg-red-100 text-red-800');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Adicionar Produto';
                    return;
                }
                
                const newProduct = {
                    id: productId,
                    name: form['product-name'].value,
                    brand: form['product-brand'].value,
                    category: form['product-category'].value,
                    price: parseFloat(form['product-price'].value),
                    stock: parseInt(form['product-stock'].value),
                    description: form['product-description'].value,
                    image_url: imageUrl,
                };
                
                await db.saveProduct(newProduct);
                db.showDBStatus('‚úÖ Produto adicionado com sucesso!');
                form.reset();
                removeProductImage();
                submitBtn.disabled = false;
                submitBtn.textContent = 'Adicionar Produto';
            });

            document.getElementById('product-image-input').addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    currentProductImageFile = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const previewImage = document.getElementById('image-preview');
                        previewImage.src = e.target.result;
                        document.getElementById('image-preview-container').classList.remove('hidden');
                        document.getElementById('upload-placeholder').classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });
        });
    </script>
</body>
</html>
