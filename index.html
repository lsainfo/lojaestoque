<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC Perfumaria - Perfumes e Cosm√©ticos</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">

    <div id="productModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3">
            <h2 id="modalTitle" class="text-2xl font-bold mb-4">Adicionar Novo Produto</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="productName">Nome do Produto</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="productName" type="text" placeholder="Nome do Produto" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="productPrice">Pre√ßo</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="productPrice" type="number" step="0.01" placeholder="Pre√ßo" required>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="productQuantity">Quantidade</label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="productQuantity" type="number" placeholder="Quantidade" required>
                </div>
                <div class="flex items-center justify-between">
                    <button id="saveProductBtn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">Salvar</button>
                    <button id="cancelModalBtn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <div class="bg-white p-4 shadow-md sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-gray-800">Gerenciamento de Estoque</h1>
            <button id="addProductBtn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Adicionar Produto</button>
        </div>
    </div>

    <div class="container mx-auto p-4">
        <div id="statusMessage" class="rounded p-4 mb-4 text-center text-sm font-medium"></div>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Lista de Produtos</h2>
            <div id="productList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://ufnujvldbfgdwqftbgnj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVmbnVqdmxkYmZnZHdxZnRiZ25qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTgzODk2OTQsImV4cCI6MjAzMzk2NTY5NH0.T4BqM8tIu5J42wF1K0a-s36d9vJ7xL-t03yE9s_J_e4';

        const db = {
            client: null,
            connected: false,
            init() {
                try {
                    this.client = supabase.createClient(supabaseUrl, supabaseKey);
                    this.connected = true;
                    isDbConnected = true;
                    console.log('‚úÖ Supabase conectado com sucesso!');
                    this.showStatus('‚úÖ Sistema online', 'bg-green-100 text-green-800');

                    // =========================================================================
                    // C√ìDIGO ADICIONADO PARA O TEMPO REAL (REALTIME) DO SUPABASE
                    // Este trecho ir√° "escutar" as mudan√ßas na tabela 'products'
                    // e ir√° recarregar a lista de produtos automaticamente.
                    // =========================================================================
                    this.client
                        .channel('products-channel') // Nome do canal (pode ser qualquer string)
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
                            console.log('üîÑ Altera√ß√£o em tempo real detectada!', payload);
                            // Quando uma mudan√ßa acontece, recarregue a lista de produtos
                            loadAndRenderProducts(); 
                        })
                        .subscribe();
                    // =========================================================================

                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao conectar ao Supabase:', error);
                    this.connected = false;
                    this.showStatus('‚ùå Sistema offline', 'bg-red-100 text-red-800');
                    return false;
                }
            },
            showStatus(message, className) {
                const statusMessageDiv = document.getElementById('statusMessage');
                statusMessageDiv.textContent = message;
                statusMessageDiv.className = `rounded p-4 mb-4 text-center text-sm font-medium ${className}`;
            }
        };

        let isDbConnected = false;

        document.addEventListener('DOMContentLoaded', () => {
            db.init();
            loadAndRenderProducts();
        });

        // ================= FUN√á√ïES DE CRIA√á√ÉO E RENDERIZA√á√ÉO =================
        const productListDiv = document.getElementById('productList');

        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'bg-gray-50 p-4 rounded-lg shadow-md flex flex-col justify-between';
            card.innerHTML = `
                <div>
                    <h3 class="text-lg font-bold text-gray-900">${product.name}</h3>
                    <p class="text-gray-600">Pre√ßo: R$ ${product.price.toFixed(2)}</p>
                    <p class="text-gray-600">Quantidade: ${product.quantity}</p>
                </div>
                <div class="mt-4 flex space-x-2">
                    <button class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded text-sm edit-btn" data-id="${product.id}">Editar</button>
                    <button class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm delete-btn" data-id="${product.id}">Excluir</button>
                </div>
            `;
            return card;
        }

        async function loadAndRenderProducts() {
            if (!isDbConnected) return;

            const { data: products, error } = await db.client.from('products').select('*');
            if (error) {
                console.error('Erro ao buscar produtos:', error.message);
                return;
            }

            productListDiv.innerHTML = '';
            products.forEach(product => {
                productListDiv.appendChild(createProductCard(product));
            });

            setupEventListeners();
        }

        // ================= FUN√á√ïES DE INTERA√á√ÉO COM O BANCO =================
        async function saveProduct(id, name, price, quantity) {
            const productData = { name, price, quantity };
            if (id) {
                // Atualizar produto existente
                const { error } = await db.client.from('products').update(productData).eq('id', id);
                if (error) {
                    console.error('Erro ao atualizar produto:', error.message);
                } else {
                    console.log('Produto atualizado com sucesso!');
                    loadAndRenderProducts();
                }
            } else {
                // Inserir novo produto
                const { error } = await db.client.from('products').insert(productData);
                if (error) {
                    console.error('Erro ao adicionar produto:', error.message);
                } else {
                    console.log('Produto adicionado com sucesso!');
                    loadAndRenderProducts();
                }
            }
        }

        async function deleteProduct(id) {
            const { error } = await db.client.from('products').delete().eq('id', id);
            if (error) {
                console.error('Erro ao excluir produto:', error.message);
            } else {
                console.log('Produto exclu√≠do com sucesso!');
                loadAndRenderProducts();
            }
        }

        // ================= INTERFACE E EVENTOS =================
        const productModal = document.getElementById('productModal');
        const modalTitle = document.getElementById('modalTitle');
        const productForm = document.getElementById('productForm');
        const productIdInput = document.getElementById('productId');
        const productNameInput = document.getElementById('productName');
        const productPriceInput = document.getElementById('productPrice');
        const productQuantityInput = document.getElementById('productQuantity');

        function openModal(isEdit = false, product = {}) {
            if (isEdit) {
                modalTitle.textContent = 'Editar Produto';
                productIdInput.value = product.id;
                productNameInput.value = product.name;
                productPriceInput.value = product.price;
                productQuantityInput.value = product.quantity;
            } else {
                modalTitle.textContent = 'Adicionar Novo Produto';
                productForm.reset();
                productIdInput.value = '';
            }
            productModal.classList.remove('hidden');
            productModal.classList.add('flex');
        }

        function closeModal() {
            productModal.classList.remove('flex');
            productModal.classList.add('hidden');
        }

        function setupEventListeners() {
            const editButtons = document.querySelectorAll('.edit-btn');
            const deleteButtons = document.querySelectorAll('.delete-btn');

            editButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const id = button.dataset.id;
                    const { data, error } = await db.client.from('products').select('*').eq('id', id).single();
                    if (!error && data) {
                        openModal(true, data);
                    }
                });
            });

            deleteButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.dataset.id;
                    if (confirm('Tem certeza que deseja excluir este produto?')) {
                        deleteProduct(id);
                    }
                });
            });
        }

        document.getElementById('addProductBtn').addEventListener('click', () => {
            openModal(false);
        });

        document.getElementById('cancelModalBtn').addEventListener('click', closeModal);

        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = productIdInput.value || null;
            const name = productNameInput.value;
            const price = parseFloat(productPriceInput.value);
            const quantity = parseInt(productQuantityInput.value);

            await saveProduct(id, name, price, quantity);
            closeModal();
        });

    </script>
</body>
</html>
