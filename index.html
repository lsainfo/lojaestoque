<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sua Loja de Perfumes e Cosméticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <style>
        /* Estilos adicionais para o modal de administrador e a barra lateral do carrinho */
        .admin-modal-backdrop, .cart-sidebar-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
        .admin-modal-content, .cart-sidebar-content {
            transition: transform 0.3s ease;
        }
        .admin-modal-content {
            transform: translateY(-50px);
        }
        .cart-sidebar-content {
            transform: translateX(100%);
        }
        .cart-sidebar-open .cart-sidebar-content {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <nav class="bg-white shadow-lg">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="#" class="font-bold text-gray-800 text-2xl">Sua Loja</a>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <input id="search-input" type="text" placeholder="Pesquisar..." class="border rounded-full py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="cart-button" class="relative">
                    <svg class="h-6 w-6 text-gray-600" fill="none" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewBox="0 0 24 24" stroke="currentColor">
                        <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">0</span>
                </button>
            </div>
        </div>
    </nav>

    <div id="cart-sidebar" class="fixed inset-0 overflow-hidden z-50 transform translate-x-full cart-sidebar-backdrop">
        <div class="absolute inset-0 overflow-hidden">
            <div class="pointer-events-none fixed inset-y-0 right-0 flex max-w-full pl-10">
                <div class="pointer-events-auto w-screen max-w-md cart-sidebar-content bg-white shadow-xl">
                    <div class="flex h-full flex-col overflow-y-scroll bg-white shadow-xl">
                        <div class="flex-1 overflow-y-auto px-4 py-6 sm:px-6">
                            <div class="flex items-start justify-between">
                                <h2 class="text-lg font-medium text-gray-900">Carrinho de Compras</h2>
                                <div class="ml-3 flex h-7 items-center">
                                    <button id="close-cart-button" type="button" class="relative -m-2 p-2 text-gray-400 hover:text-gray-500">
                                        <span class="absolute -inset-0.5"></span>
                                        <span class="sr-only">Fechar painel</span>
                                        <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <div class="mt-8">
                                <div class="flow-root">
                                    <ul role="list" id="cart-items" class="-my-6 divide-y divide-gray-200">
                                        </ul>
                                </div>
                            </div>
                        </div>
                        <div class="border-t border-gray-200 px-4 py-6 sm:px-6">
                            <div class="flex justify-between text-base font-medium text-gray-900">
                                <p>Subtotal</p>
                                <p id="cart-total">R$ 0,00</p>
                            </div>
                            <p class="mt-0.5 text-sm text-gray-500">Frete e impostos calculados na finalização da compra.</p>
                            <div class="mt-6">
                                <a href="#" class="flex items-center justify-center rounded-md border border-transparent bg-indigo-600 px-6 py-3 text-base font-medium text-white shadow-sm hover:bg-indigo-700">Finalizar Compra</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6 py-8">
        <div class="flex flex-col lg:flex-row -mx-2">
            <div class="w-full lg:w-1/4 px-2">
                <div class="bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="font-semibold text-xl mb-4">Filtros</h3>
                    <div class="mb-4">
                        <label class="block text-gray-700 font-bold mb-2">Marcas</label>
                        <select id="brand-filter" class="w-full p-2 border rounded">
                            <option value="all">Todas as Marcas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-2">Categorias</label>
                        <select id="category-filter" class="w-full p-2 border rounded">
                            <option value="all">Todas as Categorias</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="w-full lg:w-3/4 px-2 mt-8 lg:mt-0">
                <div id="product-list" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                    </div>
            </div>
        </div>
    </div>

    <footer class="bg-white mt-8 shadow-lg py-6">
        <div class="container mx-auto px-6 text-center text-gray-600">
            &copy; 2024 Sua Loja. Todos os direitos reservados.
            <button id="admin-button" class="ml-4 text-sm text-blue-500 hover:text-blue-700">Painel do Administrador</button>
        </div>
    </footer>

    <div id="admin-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50 admin-modal-backdrop">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white admin-modal-content">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Painel do Administrador</h3>
                <div id="admin-login" class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Insira a senha de administrador.</p>
                    <input id="admin-password" type="password" placeholder="Senha" class="mt-4 w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="admin-login-button" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Entrar</button>
                </div>
                <div id="admin-content" class="mt-2 px-7 py-3 hidden">
                    <button id="add-product-button" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Adicionar Novo Produto</button>
                    <div id="product-management-form" class="mt-4 p-4 border rounded hidden">
                        <h4 class="font-bold text-md mb-2">Gerenciar Produto</h4>
                        <input type="hidden" id="product-id">
                        <input type="text" id="product-name" placeholder="Nome do Produto" class="w-full p-2 border rounded mb-2">
                        <input type="text" id="product-description" placeholder="Descrição" class="w-full p-2 border rounded mb-2">
                        <input type="number" id="product-price" placeholder="Preço" class="w-full p-2 border rounded mb-2">
                        <select id="product-brand" class="w-full p-2 border rounded mb-2">
                            <option value="">Selecione a Marca</option>
                        </select>
                        <select id="product-category" class="w-full p-2 border rounded mb-2">
                            <option value="">Selecione a Categoria</option>
                        </select>
                        <input type="file" id="product-image-upload" class="w-full p-2 mb-2">
                        <button id="save-product-button" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Salvar Produto</button>
                        <button id="cancel-edit-button" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Cancelar</button>
                    </div>
                    <div id="admin-product-list" class="mt-4">
                        </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Use variáveis de ambiente em um ambiente de produção!
        // No front-end, isso ainda é visível, então para projetos sensíveis
        // o ideal é ter uma API intermediária para o Supabase.
        const SUPABASE_URL = 'https://udyihngwyqhfhdxkxwso.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkeWlobmd3eXFoZmhkeGt4d3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTcwOTUsImV4cCI6MjA3MDQzMzA5NX0.MA3RgucTM7akkqxF1Zgl4aLtGBFAUT48IKfXez8ZK3c';
        const ADMIN_PASSWORD = 'kc0310'; 

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let products = [];
        let brands = new Set();
        let categories = new Set();
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let sales = JSON.parse(localStorage.getItem('sales')) || [];

        const productList = document.getElementById('product-list');
        const cartButton = document.getElementById('cart-button');
        const cartSidebar = document.getElementById('cart-sidebar');
        const closeCartButton = document.getElementById('close-cart-button');
        const cartItemsList = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const cartCountSpan = document.getElementById('cart-count');
        const brandFilterSelect = document.getElementById('brand-filter');
        const categoryFilterSelect = document.getElementById('category-filter');
        const searchInput = document.getElementById('search-input');

        // Admin elements
        const adminButton = document.getElementById('admin-button');
        const adminModal = document.getElementById('admin-modal');
        const adminLogin = document.getElementById('admin-login');
        const adminContent = document.getElementById('admin-content');
        const adminPasswordInput = document.getElementById('admin-password');
        const adminLoginButton = document.getElementById('admin-login-button');
        const addProductButton = document.getElementById('add-product-button');
        const productManagementForm = document.getElementById('product-management-form');
        const saveProductButton = document.getElementById('save-product-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const adminProductListDiv = document.getElementById('admin-product-list');

        // Função para carregar e exibir os produtos
        async function loadProducts() {
            try {
                const { data, error } = await supabase
                    .from('products')
                    .select('*');

                if (error) throw error;
                products = data;
                renderProducts(products);
                updateFilters(products);
            } catch (error) {
                console.error('Erro ao carregar produtos do Supabase:', error.message);
                // Contingência: carregar do armazenamento local
                products = JSON.parse(localStorage.getItem('products')) || [];
                renderProducts(products);
                updateFilters(products);
            }
        }

        function renderProducts(productsToRender) {
            productList.innerHTML = '';
            if (productsToRender.length === 0) {
                productList.innerHTML = '<p class="col-span-full text-center text-gray-500">Nenhum produto encontrado.</p>';
            }
            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'bg-white rounded-lg shadow-lg overflow-hidden transition-transform duration-300 hover:scale-105';
                productCard.innerHTML = `
                    <img src="${product.imageUrl || 'https://via.placeholder.com/400x300.png?text=Sem+Imagem'}" alt="${product.name}" class="w-full h-48 object-cover">
                    <div class="p-6">
                        <h4 class="font-bold text-lg mb-2">${product.name}</h4>
                        <p class="text-gray-600 text-sm mb-2">${product.description}</p>
                        <p class="font-bold text-xl text-blue-600 mb-4">R$ ${product.price.toFixed(2)}</p>
                        <button onclick="addToCart(${product.id})" class="w-full bg-blue-500 text-white py-2 px-4 rounded-full font-bold hover:bg-blue-600 transition-colors duration-300">
                            Adicionar ao Carrinho
                        </button>
                    </div>
                `;
                productList.appendChild(productCard);
            });
        }

        function updateFilters(productsList) {
            brands.clear();
            categories.clear();
            productsList.forEach(p => {
                brands.add(p.brand);
                categories.add(p.category);
            });

            brandFilterSelect.innerHTML = '<option value="all">Todas as Marcas</option>';
            brands.forEach(b => {
                brandFilterSelect.innerHTML += `<option value="${b}">${b}</option>`;
            });

            categoryFilterSelect.innerHTML = '<option value="all">Todas as Categorias</option>';
            categories.forEach(c => {
                categoryFilterSelect.innerHTML += `<option value="${c}">${c}</option>`;
            });

            // Preenche os selects do formulário de admin
            const productBrandSelect = document.getElementById('product-brand');
            const productCategorySelect = document.getElementById('product-category');
            productBrandSelect.innerHTML = '<option value="">Selecione a Marca</option>';
            productCategorySelect.innerHTML = '<option value="">Selecione a Categoria</option>';
            brands.forEach(b => productBrandSelect.innerHTML += `<option value="${b}">${b}</option>`);
            categories.forEach(c => productCategorySelect.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function filterProducts() {
            const selectedBrand = brandFilterSelect.value;
            const selectedCategory = categoryFilterSelect.value;
            const searchQuery = searchInput.value.toLowerCase();

            const filtered = products.filter(product => {
                const matchesBrand = selectedBrand === 'all' || product.brand === selectedBrand;
                const matchesCategory = selectedCategory === 'all' || product.category === selectedCategory;
                const matchesSearch = product.name.toLowerCase().includes(searchQuery) || product.description.toLowerCase().includes(searchQuery);
                return matchesBrand && matchesCategory && matchesSearch;
            });

            renderProducts(filtered);
        }

        // Eventos para filtros
        brandFilterSelect.addEventListener('change', filterProducts);
        categoryFilterSelect.addEventListener('change', filterProducts);
        searchInput.addEventListener('input', filterProducts);

        // Funções do carrinho
        function updateCartCount() {
            const count = cart.reduce((acc, item) => acc + item.quantity, 0);
            cartCountSpan.textContent = count;
        }

        function renderCartItems() {
            cartItemsList.innerHTML = '';
            let total = 0;
            if (cart.length === 0) {
                cartItemsList.innerHTML = '<li class="text-center text-gray-500">O seu carrinho está vazio.</li>';
            } else {
                cart.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex py-6';
                    li.innerHTML = `
                        <div class="h-24 w-24 flex-shrink-0 overflow-hidden rounded-md border border-gray-200">
                            <img src="${item.imageUrl || 'https://via.placeholder.com/96'}" alt="${item.name}" class="h-full w-full object-cover object-center">
                        </div>
                        <div class="ml-4 flex flex-1 flex-col">
                            <div>
                                <div class="flex justify-between text-base font-medium text-gray-900">
                                    <h3>${item.name}</h3>
                                    <p class="ml-4">R$ ${(item.price * item.quantity).toFixed(2)}</p>
                                </div>
                                <p class="mt-1 text-sm text-gray-500">${item.brand}</p>
                            </div>
                            <div class="flex flex-1 items-end justify-between text-sm">
                                <p class="text-gray-500">Qtd ${item.quantity}</p>
                                <div class="flex">
                                    <button onclick="removeFromCart(${item.id})" type="button" class="font-medium text-indigo-600 hover:text-indigo-500">Remover</button>
                                </div>
                            </div>
                        </div>
                    `;
                    cartItemsList.appendChild(li);
                    total += item.price * item.quantity;
                });
            }
            cartTotal.textContent = `R$ ${total.toFixed(2)}`;
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            renderCartItems();
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCartItems();
        }

        // Eventos do carrinho
        cartButton.addEventListener('click', () => {
            cartSidebar.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            setTimeout(() => {
                cartSidebar.classList.add('cart-sidebar-open');
            }, 10);
        });

        closeCartButton.addEventListener('click', () => {
            cartSidebar.classList.remove('cart-sidebar-open');
            document.body.classList.remove('overflow-hidden');
            setTimeout(() => {
                cartSidebar.classList.add('hidden');
            }, 300);
        });

        // Funções do painel de administração
        adminButton.addEventListener('click', () => {
            adminModal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
        });

        adminModal.addEventListener('click', (event) => {
            if (event.target === adminModal) {
                adminModal.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
                // Reseta o estado do modal ao fechar
                adminLogin.classList.remove('hidden');
                adminContent.classList.add('hidden');
                adminPasswordInput.value = '';
                productManagementForm.classList.add('hidden');
            }
        });

        adminLoginButton.addEventListener('click', () => {
            // Em uma implementação real, essa autenticação seria feita via Supabase Auth
            if (adminPasswordInput.value === ADMIN_PASSWORD) {
                adminLogin.classList.add('hidden');
                adminContent.classList.remove('hidden');
                renderAdminProducts();
            } else {
                alert('Senha incorreta!');
            }
        });

        addProductButton.addEventListener('click', () => {
            // Limpa o formulário para um novo produto
            document.getElementById('product-id').value = '';
            document.getElementById('product-name').value = '';
            document.getElementById('product-description').value = '';
            document.getElementById('product-price').value = '';
            document.getElementById('product-brand').value = '';
            document.getElementById('product-category').value = '';
            productManagementForm.classList.remove('hidden');
        });

        cancelEditButton.addEventListener('click', () => {
            productManagementForm.classList.add('hidden');
        });

        async function renderAdminProducts() {
            adminProductListDiv.innerHTML = '';
            products.forEach(product => {
                const productRow = document.createElement('div');
                productRow.className = 'flex justify-between items-center p-2 border-b';
                productRow.innerHTML = `
                    <span>${product.name} - R$${product.price.toFixed(2)}</span>
                    <div>
                        <button onclick="editProduct(${product.id})" class="text-blue-500 mr-2">Editar</button>
                        <button onclick="deleteProduct(${product.id})" class="text-red-500">Excluir</button>
                    </div>
                `;
                adminProductListDiv.appendChild(productRow);
            });
        }

        async function saveProduct() {
            const id = document.getElementById('product-id').value;
            const name = document.getElementById('product-name').value;
            const description = document.getElementById('product-description').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const brand = document.getElementById('product-brand').value;
            const category = document.getElementById('product-category').value;
            const imageFile = document.getElementById('product-image-upload').files[0];

            if (!name || !description || isNaN(price) || !brand || !category) {
                alert('Por favor, preencha todos os campos.');
                return;
            }

            let imageUrl = null;

            if (imageFile) {
                // Upload para o Supabase Storage
                const filePath = `${Date.now()}_${imageFile.name}`;
                const { data, error } = await supabase.storage
                    .from('product-images')
                    .upload(filePath, imageFile);

                if (error) {
                    console.error('Erro ao fazer upload da imagem:', error);
                    alert('Erro ao fazer upload da imagem.');
                    return;
                }
                
                // Obtém a URL pública da imagem
                const { data: publicUrlData } = supabase.storage
                    .from('product-images')
                    .getPublicUrl(filePath);
                
                imageUrl = publicUrlData.publicUrl;
            }

            const newProduct = {
                name: name,
                description: description,
                price: price,
                brand: brand,
                category: category,
                imageUrl: imageUrl, // Armazena a URL pública
            };

            if (id) {
                // Atualizar produto existente
                const { error } = await supabase
                    .from('products')
                    .update(newProduct)
                    .eq('id', id);

                if (error) {
                    alert('Erro ao atualizar produto.');
                } else {
                    alert('Produto atualizado com sucesso!');
                }
            } else {
                // Adicionar novo produto
                const { error } = await supabase
                    .from('products')
                    .insert([newProduct]);

                if (error) {
                    alert('Erro ao adicionar produto.');
                } else {
                    alert('Produto adicionado com sucesso!');
                }
            }
            
            productManagementForm.classList.add('hidden');
            loadProducts();
            renderAdminProducts();
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('product-id').value = product.id;
            document.getElementById('product-name').value = product.name;
            document.getElementById('product-description').value = product.description;
            document.getElementById('product-price').value = product.price;
            document.getElementById('product-brand').value = product.brand;
            document.getElementById('product-category').value = product.category;
            productManagementForm.classList.remove('hidden');
        }

        async function deleteProduct(productId) {
            if (confirm('Tem certeza que deseja excluir este produto?')) {
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', productId);

                if (error) {
                    alert('Erro ao excluir produto.');
                } else {
                    alert('Produto excluído com sucesso!');
                    loadProducts();
                    renderAdminProducts();
                }
            }
        }

        saveProductButton.addEventListener('click', saveProduct);

        // Inicializar a aplicação
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            renderCartItems();
        });
    </script>
</body>
</html>
