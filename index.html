<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC Perfumaria - Perfumes e Cosm√©ticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .product-card { transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .admin-panel { display: none; }
        .cart-sidebar { transform: translateX(100%); transition: transform 0.3s ease; }
        .cart-sidebar.open { transform: translateX(0); }
        .product-image { width: 100%; height: 200px; object-fit: cover; border-radius: 8px; }
        .product-image-placeholder { width: 100%; height: 200px; background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 3rem; }
        .image-upload-area { border: 2px dashed #d1d5db; border-radius: 8px; padding: 2rem; text-align: center; transition: all 0.3s ease; cursor: pointer; }
        .image-upload-area:hover { border-color: #8b5cf6; background-color: #faf5ff; }
        .image-upload-area.dragover { border-color: #8b5cf6; background-color: #faf5ff; }
        .loading { opacity: 0.6; pointer-events: none; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .db-status { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .modal-content { background: white; border-radius: 0.5rem; max-width: 28rem; width: 100%; padding: 1.5rem; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body class="bg-gray-50">
    <div id="db-status" class="db-status bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium hidden">
        ‚úÖ Sistema conectado
    </div>

    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                <div class="flex items-center space-x-3">
                    <div class="w-20 h-16 bg-white rounded-lg flex items-center justify-center overflow-hidden cursor-pointer" id="logo-container" onclick="changeLogo()">
                        <img id="logo-image" class="w-full h-full object-cover hidden" alt="KC Perfumaria">
                        <span id="logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">KC Perfumaria</h1>
                        <p class="text-purple-200 text-sm">Perfumes e Cosm√©ticos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleCart()" class="relative bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        üõí <span class="hidden sm:inline">Carrinho</span> (<span id="cart-count">0</span>)
                    </button>
                    <button onclick="accessAdmin()" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all">
                        ‚öôÔ∏è <span class="hidden sm:inline">Admin</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mx-auto px-4 py-8">
        <div id="customer-view">
            <div class="mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Marcas</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3">
                    <button onclick="filterByBrand('todas')" class="brand-btn active bg-purple-600 text-white px-3 sm:px-6 py-2 rounded-full hover:bg-purple-700 transition-all text-sm sm:text-base">
                        Todas
                    </button>
                    <button onclick="filterByBrand('boticario')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        üåø Botic√°rio
                    </button>
                    <button onclick="filterByBrand('mary-kay')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        üíé Mary Kay
                    </button>
                    <button onclick="filterByBrand('eudora')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        ‚ú® Eudora
                    </button>
                    <button onclick="filterByBrand('natura')" class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        üçÉ Natura
                    </button>
                </div>
            </div>

            <div class="mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Categorias</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3">
                    <button onclick="filterProducts('todos')" class="category-btn active bg-indigo-600 text-white px-4 sm:px-6 py-2 rounded-full hover:bg-indigo-700 transition-all text-sm sm:text-base">
                        Todos
                    </button>
                    <button onclick="filterProducts('perfumes')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Perfumes
                    </button>
                    <button onclick="filterProducts('cosmeticos')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Cosm√©ticos
                    </button>
                    <button onclick="filterProducts('cuidados')" class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base">
                        Cuidados
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6" id="products-grid">
                </div>
        </div>

        <div id="admin-panel" class="admin-panel">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                    <h2 class="text-2xl font-bold text-gray-800">Painel Administrativo</h2>
                    <div class="flex space-x-2">
                        <button onclick="diagnosticSupabase()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all w-full sm:w-auto">
                            üîç Diagn√≥stico
                        </button>
                        <button onclick="backToStore()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all w-full sm:w-auto">
                            üè™ Voltar para Loja
                        </button>
                    </div>
                </div>
                
                <div class="max-w-2xl mx-auto mb-8">
                    <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Gerenciar Logo da Loja</h3>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-center space-x-6">
                            <div class="flex-shrink-0">
                                <div class="w-24 h-20 bg-white rounded-lg flex items-center justify-center overflow-hidden border-2 border-gray-200">
                                    <img id="admin-logo-image" class="w-full h-full object-cover hidden" alt="Logo atual">
                                    <span id="admin-logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-2">Logo Atual</h4>
                                <p class="text-gray-600 text-sm mb-4">Clique no bot√£o abaixo para alterar a logo da sua loja. Recomendamos imagens quadradas ou retangulares.</p>
                                <div class="flex space-x-3">
                                    <button onclick="changeLogoAdmin()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all">
                                        üì∑ Alterar Logo
                                    </button>
                                    <button onclick="removeLogoAdmin()" class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition-all">
                                        üóëÔ∏è Remover Logo
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            üí° Dica: Use imagens PNG ou JPG com fundo transparente para melhor resultado. Tamanho m√°ximo: 2MB.
                        </div>
                    </div>
                </div>

                <div class="max-w-2xl mx-auto">
                    <h3 class="text-lg font-semibold mb-4">Adicionar Produto</h3>
                    <form id="add-product-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto do Produto</label>
                            <div class="image-upload-area" id="product-image-upload" onclick="document.getElementById('product-image-input').click()">
                                <div id="image-preview-container" class="hidden">
                                    <img id="image-preview" class="w-full h-32 object-cover rounded-lg mb-2" alt="Preview">
                                    <button type="button" onclick="removeProductImage(event)" class="text-red-600 hover:text-red-800 text-sm">
                                        üóëÔ∏è Remover Foto
                                    </button>
                                </div>
                                <div id="upload-placeholder">
                                    <div class="text-4xl mb-2">üì∑</div>
                                    <p class="text-gray-600 font-medium">Clique para adicionar foto</p>
                                    <p class="text-gray-400 text-sm mt-1">JPG, PNG ou GIF (m√°x. 5MB)</p>
                                </div>
                            </div>
                            <input type="file" id="product-image-input" accept="image/*" class="hidden">
                        </div>

                        <input type="text" id="product-name" placeholder="Nome do produto" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <select id="product-brand" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Selecione a marca</option>
                            <option value="boticario">üåø Botic√°rio</option>
                            <option value="mary-kay">üíé Mary Kay</option>
                            <option value="eudora">‚ú® Eudora</option>
                            <option value="natura">üçÉ Natura</option>
                        </select>
                        <select id="product-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                            <option value="">Selecione a categoria</option>
                            <option value="perfumes">Perfumes</option>
                            <option value="cosmeticos">Cosm√©ticos</option>
                            <option value="cuidados">Cuidados</option>
                        </select>
                        <input type="number" id="product-price" placeholder="Pre√ßo (R$)" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <input type="number" id="product-stock" placeholder="Quantidade em estoque" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" required>
                        <textarea id="product-description" placeholder="Descri√ß√£o do produto" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-24"></textarea>
                        <button type="submit" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-all font-semibold">
                            Adicionar Produto
                        </button>
                    </form>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold mb-4">Produtos Cadastrados</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="product-gallery">
                    </div>
            </div>
        </div>
    </div>

    <div id="cart-sidebar" class="cart-sidebar fixed right-0 top-0 h-full w-full sm:w-96 bg-white shadow-2xl z-50 flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Carrinho de Compras</h3>
                <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <div id="cart-items">
                <p class="text-gray-500 text-center py-8">Carrinho vazio</p>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Total:</span>
                <span class="text-xl font-bold text-purple-600" id="cart-total">R$ 0,00</span>
            </div>
            <button onclick="finalizePurchaseWhatsApp()" class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-semibold">
                üì± Finalizar pelo WhatsApp
            </button>
        </div>
    </div>

    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleCart()"></div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://udyihngwyqhfhdxkxwso.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkeWlobmd3eXFoZmhkeGt4d3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTcwOTUsImV4cCI6MjA3MDQzMzA5NX0.MA3RgucTM7akkqxF1Zgl4aLtGBFAUT48IKfXez8ZK3c';
        const ADMIN_PASSWORD = 'kc0310';
        const WHATSAPP_NUMBER = '5541997786625';
        // Global Variables
        let supabaseClient = null;
        let products = [];
        let cart = [];
        let sales = [];
        let currentFilter = 'todos';
        let currentBrand = 'todas';
        let currentProductImage = null;
        let isDbConnected = false;

        // Database Management System
        const db = {
            client: null,
            connected: false,

            async init() {
                try {
                    console.log('üîå Inicializando conex√£o com Supabase...');
                    this.client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    
                    // Test connection
                    const { data, error } = await this.client
                        .from('products')
                        .select('id')
                        .limit(1);
                    
                    if (error) {
                        console.error('‚ùå Erro na conex√£o:', error);
                        this.connected = false;
                        this.showStatus('‚ùå Banco offline - modo local', 'bg-yellow-100 text-yellow-800');
                        return false;
                    }
                    
                    this.connected = true;
                    isDbConnected = true;
                    console.log('‚úÖ Supabase conectado com sucesso!');
                    this.showStatus('‚úÖ Sistema online', 'bg-green-100 text-green-800');

                    // ========== ALTERA√á√ÉO AQUI: Sincroniza√ß√£o em tempo real ==========
                    this.client
                        .channel('products_changes')
                        .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, (payload) => {
                            console.log('üîÑ Altera√ß√£o em tempo real detectada!', payload);
                            loadAndRenderProducts(); 
                        })
                        .subscribe();
                    // =================================================================

                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao inicializar Supabase:', error);
                    this.connected = false;
                    this.showStatus('‚ùå Erro de conex√£o', 'bg-red-100 text-red-800');
                    return false;
                }
            },

            showStatus(message, className = 'bg-green-100 text-green-800') {
                const statusEl = document.getElementById('db-status');
                if (statusEl) {
                    statusEl.textContent = message;
                    statusEl.className = `db-status px-3 py-1 rounded-full text-sm font-medium ${className}`;
                    statusEl.classList.remove('hidden');
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, 3000);
                }
            },

            async loadProducts() {
                if (!this.connected) return [];
                try {
                    const { data, error } = await this.client
                        .from('products')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    console.log(`üì¶ ${data?.length || 0} produtos carregados do Supabase`);
                    return data || [];
                } catch (error) {
                    console.error('‚ùå Erro ao carregar produtos:', error);
                    return [];
                }
            },

            async saveProduct(product) {
                if (!this.connected) return false;
                try {
                    const productData = {
                        id: product.id,
                        name: product.name,
                        brand: product.brand,
                        category: product.category,
                        price: parseFloat(product.price),
                        stock: parseInt(product.stock),
                        description: product.description || '',
                        image: product.image || 'üå∏',
                        image_url: product.imageUrl || null
                    };
                    const { data, error } = await this.client
                        .from('products')
                        .upsert(productData, { onConflict: 'id' })
                        .select();
                    if (error) throw error;
                    
                    console.log('‚úÖ Produto salvo no Supabase:', product.name);
                    this.showStatus('‚úÖ Produto salvo!');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar produto:', error);
                    return false;
                }
            },

            async deleteProduct(productId) {
                if (!this.connected) return false;
                try {
                    const { error } = await this.client
                        .from('products')
                        .delete()
                        .eq('id', productId);
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Produto exclu√≠do do Supabase');
                    this.showStatus('‚úÖ Produto exclu√≠do!');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao excluir produto:', error);
                    return false;
                }
            },

            async uploadImage(file, fileName) {
                if (!this.connected) return null;
                try {
                    const { data, error } = await this.client.storage
                        .from('product_images')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: true
                        });
                    if (error) throw error;
                    
                    const { data: urlData } = this.client.storage
                        .from('product_images')
                        .getPublicUrl(fileName);
                    console.log('‚úÖ Imagem enviada para Supabase Storage');
                    return urlData.publicUrl;
                } catch (error) {
                    console.error('‚ùå Erro ao enviar imagem:', error);
                    return null;
                }
            },

            async deleteImage(fileName) {
                if (!this.connected) return false;
                try {
                    const { error } = await this.client.storage
                        .from('product_images')
                        .remove([fileName]);
                    if (error) throw error;
                    
                    console.log('‚úÖ Imagem exclu√≠da do Storage');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao excluir imagem:', error);
                    return false;
                }
            },

            async saveSale(sale) {
                if (!this.connected) return false;
                try {
                    const { data, error } = await this.client
                        .from('sales')
                        .insert(sale)
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Venda salva no Supabase');
                    this.showStatus('‚úÖ Venda registrada!');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar venda:', error);
                    return false;
                }
            }
        };
        // Utility Functions
        function getRandomEmoji() {
            const emojis = ['üå∏', 'üíÑ', 'üß¥', '‚ú®', 'üíé', 'üå∫', 'üéÄ', 'üíã', 'üå∑', 'ü¶ã'];
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(price);
        }

        function showModal(title, content, buttons = []) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    <div class="mb-6">${content}</div>
                    <div class="flex justify-end space-x-2">
                        ${buttons.map(btn => `<button onclick="${btn.action}" class="${btn.class}">${btn.text}</button>`).join('')}
                        <button onclick="this.closest('.modal-overlay').remove()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition-all">Fechar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            return modal;
        }

        // Local Storage Functions
        function saveToLocalStorage() {
            try {
                localStorage.setItem('kc_products', JSON.stringify(products));
                localStorage.setItem('kc_sales', JSON.stringify(sales));
                localStorage.setItem('kc_cart', JSON.stringify(cart));
                console.log('üíæ Dados salvos no localStorage');
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao salvar no localStorage:', error);
                return false;
            }
        }

        function loadFromLocalStorage() {
            try {
                const savedProducts = localStorage.getItem('kc_products');
                const savedSales = localStorage.getItem('kc_sales');
                const savedCart = localStorage.getItem('kc_cart');
                
                if (savedProducts) {
                    products = JSON.parse(savedProducts);
                    console.log(`üì± ${products.length} produtos carregados do localStorage`);
                }
                
                if (savedSales) {
                    sales = JSON.parse(savedSales);
                    console.log(`üí∞ ${sales.length} vendas carregadas do localStorage`);
                }
                
                if (savedCart) {
                    cart = JSON.parse(savedCart);
                    console.log(`üõí ${cart.length} itens carregados no carrinho`);
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao carregar do localStorage:', error);
                return false;
            }
        }

        // Image Handling Functions
        function setupProductImageUpload() {
            const imageInput = document.getElementById('product-image-input');
            const uploadArea = document.getElementById('product-image-upload');
            
            if (!imageInput || !uploadArea) return;
            
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    handleProductImageFile(file);
                }
            });
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });
            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    handleProductImageFile(file);
                }
            });
        }

        function handleProductImageFile(file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('‚ùå Arquivo muito grande! O tamanho m√°ximo √© 5MB.');
                return;
            }

            if (!file.type.startsWith('image/')) {
                alert('‚ùå Por favor, selecione apenas arquivos de imagem.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                currentProductImage = {
                    file: file,
                    dataUrl: e.target.result
                };
                showImagePreview(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function showImagePreview(imageData) {
            const previewContainer = document.getElementById('image-preview-container');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const imagePreview = document.getElementById('image-preview');

            if (previewContainer && uploadPlaceholder && imagePreview) {
                imagePreview.src = imageData;
                previewContainer.classList.remove('hidden');
                uploadPlaceholder.classList.add('hidden');
            }
        }

        function removeProductImage(event) {
            event.stopPropagation();
            const previewContainer = document.getElementById('image-preview-container');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const imageInput = document.getElementById('product-image-input');

            currentProductImage = null;
            if (previewContainer && uploadPlaceholder && imageInput) {
                previewContainer.classList.add('hidden');
                uploadPlaceholder.classList.remove('hidden');
                imageInput.value = '';
            }
        }

        // Logo Management Functions
        function changeLogo() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        alert('‚ùå Arquivo muito grande! O tamanho m√°ximo √© 2MB.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        updateLogo(e.target.result);
                        localStorage.setItem('kc_logo', e.target.result);
                        alert('‚úÖ Logo atualizada com sucesso!');
                    };
                    reader.readAsDataURL(file);
                }
            };
            fileInput.click();
        }

        function changeLogoAdmin() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 2 * 1024 * 1024) {
                        alert('‚ùå Arquivo muito grande! O tamanho m√°ximo √© 2MB.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const logoData = e.target.result;
                        updateLogo(logoData);
                        updateAdminLogoPreview(logoData);
                        localStorage.setItem('kc_logo', logoData);
                        alert('‚úÖ Logo atualizada com sucesso!');
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            fileInput.click();
        }

        function removeLogoAdmin() {
            if (confirm('üóëÔ∏è Tem certeza que deseja remover a logo?')) {
                updateLogo(null);
                updateAdminLogoPreview(null);
                localStorage.removeItem('kc_logo');
                alert('‚úÖ Logo removida com sucesso!');
            }
        }

        function updateLogo(logoData) {
            const logoImage = document.getElementById('logo-image');
            const logoText = document.getElementById('logo-text');
            
            if (logoImage && logoText) {
                if (logoData) {
                    logoImage.src = logoData;
                    logoImage.classList.remove('hidden');
                    logoText.classList.add('hidden');
                } else {
                    logoImage.classList.add('hidden');
                    logoText.classList.remove('hidden');
                }
            }
        }

        function updateAdminLogoPreview(logoData) {
            const adminLogoImage = document.getElementById('admin-logo-image');
            const adminLogoText = document.getElementById('admin-logo-text');
            
            if (adminLogoImage && adminLogoText) {
                if (logoData) {
                    adminLogoImage.src = logoData;
                    adminLogoImage.classList.remove('hidden');
                    adminLogoText.classList.add('hidden');
                } else {
                    adminLogoImage.classList.add('hidden');
                    adminLogoText.classList.remove('hidden');
                }
            }
        }

        // Product Management Functions
        async function loadAndRenderProducts() {
            try {
                console.log('üîÑ Carregando produtos...');
                if (isDbConnected) {
                    const supabaseProducts = await db.loadProducts();
                    if (supabaseProducts && supabaseProducts.length > 0) {
                        products = supabaseProducts;
                        console.log(`‚úÖ ${products.length} produtos carregados do Supabase`);
                        saveToLocalStorage();
                    } else {
                        loadFromLocalStorage();
                    }
                } else {
                    loadFromLocalStorage();
                }
                renderProducts();
                updateProductGallery();
            } catch (error) {
                console.error('‚ùå Erro ao carregar produtos:', error);
                loadFromLocalStorage();
                renderProducts();
                updateProductGallery();
            }
        }

        function renderProducts() {
            const grid = document.getElementById('products-grid');
            if (!grid) return;
            let filteredProducts = products;
            if (currentBrand !== 'todas') {
                filteredProducts = filteredProducts.filter(p => p.brand === currentBrand);
            }
            if (currentFilter !== 'todos') {
                filteredProducts = filteredProducts.filter(p => p.category === currentFilter);
            }
            const brandNames = { 'boticario': 'üåø Botic√°rio', 'mary-kay': 'üíé Mary Kay', 'eudora': '‚ú® Eudora', 'natura': 'üçÉ Natura' };
            if (filteredProducts.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Nenhum produto encontrado</div>';
                return;
            }
            grid.innerHTML = filteredProducts.map(product => {
                const productImageHtml = product.imageUrl || product.image_url ? `<img src="${product.imageUrl || product.image_url}" alt="${product.name}" class="product-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"> <div class="product-image-placeholder" style="display: none;">${product.image}</div>` : `<div class="product-image-placeholder">${product.image}</div>`;
                return `
                    <div class="product-card bg-white rounded-lg shadow-md overflow-hidden">
                        <div class="p-0">
                            ${productImageHtml}
                        </div>
                        <div class="p-6">
                            <div class="text-xs text-purple-600 font-semibold mb-2 text-center">${brandNames[product.brand] || product.brand}</div>
                            <h3 class="font-semibold text-lg mb-2 line-clamp-2">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">${product.description || ''}</p>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-2xl font-bold text-purple-600">${formatPrice(product.price)}</span>
                                <span class="text-sm text-gray-500">Estoque: ${product.stock}</span>
                            </div>
                            <button onclick="addToCart(${product.id})" ${product.stock === 0 ? 'disabled' : ''} class="w-full py-2 px-4 rounded-lg font-semibold transition-all ${product.stock === 0 ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-purple-600 text-white hover:bg-purple-700'}">
                                ${product.stock === 0 ? 'Sem Estoque' : 'üõí Adicionar ao Carrinho'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateProductGallery() {
            const gallery = document.getElementById('product-gallery');
            if (!gallery) return;
            const brandNames = { 'boticario': 'üåø Botic√°rio', 'mary-kay': 'üíé Mary Kay', 'eudora': '‚ú® Eudora', 'natura': 'üçÉ Natura' };
            if (products.length === 0) {
                gallery.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Nenhum produto cadastrado</div>';
                return;
            }
            gallery.innerHTML = products.map(product => {
                const productImageHtml = product.imageUrl || product.image_url ? `<img src="${product.imageUrl || product.image_url}" alt="${product.name}" class="w-full h-32 object-cover rounded-lg mb-2" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"> <div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center text-3xl mb-2" style="display: none;">${product.image}</div>` : `<div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center text-3xl mb-2">${product.image}</div>`;
                return `
                    <div class="bg-gray-50 rounded-lg p-4">
                        ${productImageHtml}
                        <div class="text-xs text-purple-600 font-medium mb-1">${brandNames[product.brand] || product.brand}</div>
                        <h4 class="font-semibold text-sm mb-1 line-clamp-2">${product.name}</h4>
                        <p class="text-xs text-gray-600 mb-2">${formatPrice(product.price)} | Estoque: ${product.stock}</p>
                        <div class="flex space-x-1">
                            <button onclick="editProduct(${product.id})" class="flex-1 bg-green-100 text-green-600 text-xs py-1 px-2 rounded hover:bg-green-200 transition-all"> ‚úèÔ∏è Editar </button>
                            <button onclick="editProductImage(${product.id})" class="flex-1 bg-blue-100 text-blue-600 text-xs py-1 px-2 rounded hover:bg-blue-200 transition-all"> üì∑ Foto </button>
                            <button onclick="deleteProduct(${product.id})" class="flex-1 bg-red-100 text-red-600 text-xs py-1 px-2 rounded hover:bg-red-200 transition-all"> üóëÔ∏è Excluir </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-lg font-bold mb-4">‚úèÔ∏è Editar Produto</h3>
                    <form id="edit-product-form">
                        <input type="text" id="edit-name" value="${product.name}" placeholder="Nome do produto" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                        <select id="edit-brand" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                            <option value="boticario" ${product.brand === 'boticario' ? 'selected' : ''}>üåø Botic√°rio</option>
                            <option value="mary-kay" ${product.brand === 'mary-kay' ? 'selected' : ''}>üíé Mary Kay</option>
                            <option value="eudora" ${product.brand === 'eudora' ? 'selected' : ''}>‚ú® Eudora</option>
                            <option value="natura" ${product.brand === 'natura' ? 'selected' : ''}>üçÉ Natura</option>
                        </select>
                        <select id="edit-category" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                            <option value="perfumes" ${product.category === 'perfumes' ? 'selected' : ''}>Perfumes</option>
                            <option value="cosmeticos" ${product.category === 'cosmeticos' ? 'selected' : ''}>Cosm√©ticos</option>
                            <option value="cuidados" ${product.category === 'cuidados' ? 'selected' : ''}>Cuidados</option>
                        </select>
                        <input type="number" id="edit-price" value="${product.price}" placeholder="Pre√ßo (R$)" step="0.01" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                        <input type="number" id="edit-stock" value="${product.stock}" placeholder="Quantidade em estoque" class="w-full p-3 border border-gray-300 rounded-lg mb-3 focus:ring-2 focus:ring-purple-500" required>
                        <textarea id="edit-description" placeholder="Descri√ß√£o do produto" class="w-full p-3 border border-gray-300 rounded-lg mb-4 h-20 focus:ring-2 focus:ring-purple-500">${product.description || ''}</textarea>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-all"> ‚úÖ Salvar </button>
                            <button type="button" onclick="this.closest('.modal-overlay').remove()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all"> ‚ùå Cancelar </button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('edit-product-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                product.name = document.getElementById('edit-name').value;
                product.brand = document.getElementById('edit-brand').value;
                product.category = document.getElementById('edit-category').value;
                product.price = parseFloat(document.getElementById('edit-price').value);
                product.stock = parseInt(document.getElementById('edit-stock').value);
                product.description = document.getElementById('edit-description').value;

                const success = await db.saveProduct(product);
                if (success) {
                    await loadAndRenderProducts();
                    modal.remove();
                }
            });
        }

        async function editProductImage(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            let currentImageUrl = product.imageUrl || product.image_url;
            let currentImage = currentImageUrl ? `<img src="${currentImageUrl}" class="w-full h-40 object-cover rounded-lg" alt="Foto atual do produto">` : `
                <div class="w-full h-40 bg-gray-100 rounded-lg flex items-center justify-center text-4xl">
                    <span class="text-gray-400">üì∑</span>
                </div>
            `;

            const modal = showModal('üì∑ Alterar Foto do Produto', `
                <div class="mb-4">
                    <h4 class="font-semibold text-gray-800 mb-2">Foto Atual:</h4>
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-2 flex items-center justify-center">
                        ${currentImage}
                    </div>
                </div>
                <div id="image-upload-area-edit" class="image-upload-area mt-4">
                    <div class="text-4xl mb-2">üì∏</div>
                    <p class="text-gray-600 font-medium">Clique ou arraste a nova foto aqui</p>
                    <p class="text-gray-400 text-sm mt-1">JPG, PNG ou GIF (m√°x. 5MB)</p>
                </div>
                <input type="file" id="image-upload-input-edit" accept="image/*" class="hidden">
            `, [
                {
                    text: 'üóëÔ∏è Remover Foto',
                    action: `
                        if(confirm('Tem certeza que deseja remover a foto?')){
                            await db.deleteImage('product_images/' + product.image_url.split('/').pop());
                            product.imageUrl = null;
                            product.image_url = null;
                            product.image = getRandomEmoji();
                            await db.saveProduct(product);
                            loadAndRenderProducts();
                            this.closest('.modal-overlay').remove();
                        }
                    `,
                    class: 'bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition-all'
                }
            ]);

            const imageInput = document.getElementById('image-upload-input-edit');
            const uploadArea = document.getElementById('image-upload-area-edit');
            
            uploadArea.addEventListener('click', () => imageInput.click());
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); });
            uploadArea.addEventListener('drop', (e) => { e.preventDefault(); uploadArea.classList.remove('dragover'); const file = e.dataTransfer.files[0]; handleImageUpdate(file, product); });

            imageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleImageUpdate(file, product);
            });
            
            async function handleImageUpdate(file, product) {
                if (file.size > 5 * 1024 * 1024) {
                    alert('‚ùå Arquivo muito grande! O tamanho m√°ximo √© 5MB.');
                    return;
                }
                if (!file.type.startsWith('image/')) {
                    alert('‚ùå Por favor, selecione apenas arquivos de imagem.');
                    return;
                }

                const loadingModal = showModal('üîÑ Enviando Imagem', '<p>Por favor, aguarde enquanto a foto √© enviada...</p>');
                const fileName = `product-${product.id}-${Date.now()}`;
                const imageUrl = await db.uploadImage(file, fileName);
                
                loadingModal.remove();

                if (imageUrl) {
                    if (product.image_url) {
                        const oldFileName = 'product_images/' + product.image_url.split('/').pop();
                        await db.deleteImage(oldFileName);
                    }
                    product.image = getRandomEmoji(); // Reset emoji to a random one
                    product.image_url = imageUrl;
                    await db.saveProduct(product);
                    loadAndRenderProducts();
                    modal.remove();
                } else {
                    alert('‚ùå Erro ao enviar a foto. Tente novamente.');
                }
            }
        }
        
        async function deleteProduct(productId) {
            if (confirm('üóëÔ∏è Tem certeza que deseja excluir este produto?')) {
                const product = products.find(p => p.id === productId);
                if (product && product.image_url) {
                    const fileName = 'product_images/' + product.image_url.split('/').pop();
                    await db.deleteImage(fileName);
                }
                await db.deleteProduct(productId);
            }
        }

        // Customer Functions
        function filterProducts(category) {
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active', 'bg-indigo-600', 'text-white'));
            document.querySelectorAll('.category-btn').forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700'));
            const activeBtn = document.querySelector(`.category-btn[onclick="filterProducts('${category}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-indigo-600', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }
            currentFilter = category;
            renderProducts();
        }

        function filterByBrand(brand) {
            document.querySelectorAll('.brand-btn').forEach(btn => btn.classList.remove('active', 'bg-purple-600', 'text-white'));
            document.querySelectorAll('.brand-btn').forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700'));
            const activeBtn = document.querySelector(`.brand-btn[onclick="filterByBrand('${brand}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'bg-purple-600', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
            }
            currentBrand = brand;
            renderProducts();
        }

        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (product && product.stock > 0) {
                const cartItem = cart.find(item => item.id === productId);
                if (cartItem) {
                    cartItem.quantity++;
                } else {
                    cart.push({ ...product, quantity: 1 });
                }
                product.stock--;
                saveToLocalStorage();
                updateCartUI();
                renderProducts(); // Update stock count on product card
            }
        }

        function updateCartUI() {
            const cartItemsEl = document.getElementById('cart-items');
            const cartCountEl = document.getElementById('cart-count');
            const cartTotalEl = document.getElementById('cart-total');
            
            if (!cartItemsEl || !cartCountEl || !cartTotalEl) return;
            
            cartItemsEl.innerHTML = '';
            let total = 0;
            let totalItems = 0;

            if (cart.length === 0) {
                cartItemsEl.innerHTML = '<p class="text-gray-500 text-center py-8">Carrinho vazio</p>';
            } else {
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    total += itemTotal;
                    totalItems += item.quantity;
                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'flex items-center justify-between py-4 border-b border-gray-200';
                    cartItemEl.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <img src="${item.imageUrl || item.image_url || ''}" class="w-12 h-12 object-cover rounded" alt="${item.name}" onerror="this.style.display='none';">
                            <div>
                                <h4 class="font-semibold text-gray-800">${item.name}</h4>
                                <p class="text-sm text-gray-600">${formatPrice(item.price)} x ${item.quantity}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="font-bold text-purple-600">${formatPrice(itemTotal)}</span>
                            <button onclick="removeFromCart(${item.id})" class="text-red-500 hover:text-red-700">&times;</button>
                        </div>
                    `;
                    cartItemsEl.appendChild(cartItemEl);
                });
            }
            
            cartCountEl.textContent = totalItems;
            cartTotalEl.textContent = formatPrice(total);
        }

        function removeFromCart(productId) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex > -1) {
                const product = products.find(p => p.id === productId);
                if (product) {
                    product.stock += cart[itemIndex].quantity;
                }
                cart.splice(itemIndex, 1);
                saveToLocalStorage();
                updateCartUI();
                renderProducts();
            }
        }

        function toggleCart() {
            const sidebar = document.getElementById('cart-sidebar');
            const overlay = document.getElementById('overlay');
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
            } else {
                sidebar.classList.add('open');
                overlay.classList.remove('hidden');
            }
        }

        function finalizePurchaseWhatsApp() {
            if (cart.length === 0) {
                alert('Seu carrinho est√° vazio!');
                return;
            }

            const productsSummary = cart.map(item => `- ${item.quantity}x ${item.name} (${formatPrice(item.price)})`).join('\n');
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const message = `Ol√°, gostaria de finalizar a minha compra na KC Perfumaria. Aqui est√° o meu pedido:\n\n${productsSummary}\n\nTotal: ${formatPrice(total)}\n\nPor favor, me informe sobre as op√ß√µes de pagamento e entrega.`;
            const encodedMessage = encodeURIComponent(message);
            const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodedMessage}`;
            
            window.open(whatsappUrl, '_blank');
            
            saveSale(cart);
            cart = [];
            saveToLocalStorage();
            updateCartUI();
            toggleCart();
        }

        async function saveSale(items) {
            const sale = {
                items: items.map(item => ({
                    product_id: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price
                })),
                total: items.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                date: new Date().toISOString()
            };

            await db.saveSale(sale);
        }

        // Admin Functions
        function accessAdmin() {
            const password = prompt('Digite a senha de administrador:');
            if (password === ADMIN_PASSWORD) {
                document.getElementById('customer-view').style.display = 'none';
                document.getElementById('admin-panel').style.display = 'block';
                loadAndRenderProducts(); // Update gallery in admin panel
            } else {
                alert('Senha incorreta!');
            }
        }

        function backToStore() {
            document.getElementById('customer-view').style.display = 'block';
            document.getElementById('admin-panel').style.display = 'none';
            loadAndRenderProducts();
        }

        document.getElementById('add-product-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('product-name').value;
            const brand = document.getElementById('product-brand').value;
            const category = document.getElementById('product-category').value;
            const price = parseFloat(document.getElementById('product-price').value);
            const stock = parseInt(document.getElementById('product-stock').value);
            const description = document.getElementById('product-description').value;
            
            const newProduct = {
                id: Date.now(),
                name,
                brand,
                category,
                price,
                stock,
                description,
                image: getRandomEmoji(),
                imageUrl: null,
                image_url: null
            };
            
            const loadingModal = showModal('üîÑ Enviando Produto', '<p>Por favor, aguarde enquanto o produto √© salvo...</p>');
            
            if (currentProductImage) {
                const fileName = `product-${newProduct.id}-${Date.now()}`;
                const imageUrl = await db.uploadImage(currentProductImage.file, fileName);
                if (imageUrl) {
                    newProduct.image_url = imageUrl;
                    newProduct.imageUrl = imageUrl;
                } else {
                    alert('‚ùå Erro ao enviar a foto. O produto ser√° salvo sem imagem.');
                }
            }

            const success = await db.saveProduct(newProduct);
            
            loadingModal.remove();

            if (success) {
                document.getElementById('add-product-form').reset();
                removeProductImage(new Event('click'));
                await loadAndRenderProducts();
            } else {
                alert('‚ùå Erro ao adicionar o produto. Tente novamente.');
            }
        });

        // Initial Load
        document.addEventListener('DOMContentLoaded', async () => {
            await db.init();
            const storedLogo = localStorage.getItem('kc_logo');
            if (storedLogo) {
                updateLogo(storedLogo);
                updateAdminLogoPreview(storedLogo);
            }
            await loadAndRenderProducts();
            updateCartUI();
            setupProductImageUpload();
        });

    </script>
</body>
</html>
