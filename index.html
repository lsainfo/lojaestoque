<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KC Perfumaria - Perfumes e Cosm√©ticos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Poppins', sans-serif; 
        }
        
        .gradient-bg { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
        }
        
        .product-card { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        .product-card:hover { 
            transform: translateY(-8px); 
            box-shadow: 0 25px 50px rgba(0,0,0,0.15); 
        }
        
        .admin-panel { 
            display: none; 
        }
        
        .cart-sidebar { 
            transform: translateX(100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        .cart-sidebar.open { 
            transform: translateX(0); 
        }
        
        .product-image { 
            width: 100%; 
            height: 200px; 
            object-fit: cover; 
            border-radius: 8px; 
            transition: opacity 0.3s ease;
        }
        
        .product-image-placeholder { 
            width: 100%; 
            height: 200px; 
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 3rem; 
        }
        
        .image-upload-area { 
            border: 2px dashed #d1d5db; 
            border-radius: 8px; 
            padding: 2rem; 
            text-align: center; 
            transition: all 0.3s ease; 
            cursor: pointer; 
        }
        
        .image-upload-area:hover { 
            border-color: #8b5cf6; 
            background-color: #faf5ff; 
        }
        
        .image-upload-area.dragover { 
            border-color: #8b5cf6; 
            background-color: #faf5ff; 
            transform: scale(1.02);
        }
        
        .loading { 
            opacity: 0.6; 
            pointer-events: none; 
            position: relative;
        }
        
        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .line-clamp-2 { 
            display: -webkit-box; 
            -webkit-line-clamp: 2; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        
        .db-status { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1000; 
            transition: all 0.3s ease;
        }
        
        .modal-overlay { 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.5); 
            z-index: 50; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 1rem; 
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content { 
            background: white; 
            border-radius: 0.75rem; 
            max-width: 28rem; 
            width: 100%; 
            padding: 1.5rem; 
            max-height: 90vh; 
            overflow-y: auto; 
            animation: slideUp 0.3s ease;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
            word-wrap: break-word;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.info { background-color: #3b82f6; }
        .toast.warning { background-color: #f59e0b; }
        
        .search-container {
            position: relative;
        }
        
        .search-input {
            transition: all 0.3s ease;
        }
        
        .search-input:focus {
            transform: scale(1.02);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .btn-loading {
            position: relative;
            color: transparent !important;
        }
        
        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6b7280;
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        /* Responsive improvements */
        @media (max-width: 640px) {
            .modal-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }
            
            .product-card:hover {
                transform: translateY(-4px);
            }
        }
        
        /* Accessibility improvements */
        .focus-visible:focus {
            outline: 2px solid #8b5cf6;
            outline-offset: 2px;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Database Status Indicator -->
    <div id="db-status" class="db-status bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium hidden">
        ‚úÖ Sistema conectado
    </div>

    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <div class="w-20 h-16 bg-white rounded-lg flex items-center justify-center overflow-hidden cursor-pointer transition-transform hover:scale-105" 
                         id="logo-container" 
                         onclick="changeLogo()"
                         role="button"
                         tabindex="0"
                         aria-label="Alterar logo da loja">
                        <img id="logo-image" class="w-full h-full object-cover hidden" alt="KC Perfumaria">
                        <span id="logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold">KC Perfumaria</h1>
                        <p class="text-purple-200 text-sm">Perfumes e Cosm√©ticos</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button onclick="toggleCart()" 
                            class="relative bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all focus-visible:focus"
                            aria-label="Abrir carrinho de compras">
                        üõí <span class="hidden sm:inline">Carrinho</span> (<span id="cart-count">0</span>)
                    </button>
                    <button onclick="accessAdmin()" 
                            class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all focus-visible:focus"
                            aria-label="Acessar painel administrativo">
                        ‚öôÔ∏è <span class="hidden sm:inline">Admin</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-8">
        <!-- Customer View -->
        <div id="customer-view">
            <!-- Search Bar -->
            <div class="mb-6 search-container">
                <div class="max-w-md mx-auto">
                    <div class="relative">
                        <input type="text" 
                               id="search-input" 
                               placeholder="üîç Buscar produtos..." 
                               class="search-input w-full p-4 pr-12 border border-gray-300 rounded-full focus:ring-2 focus:ring-purple-500 focus:border-transparent text-center"
                               autocomplete="off">
                        <button id="clear-search" 
                                class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 hidden"
                                onclick="clearSearch()"
                                aria-label="Limpar busca">
                            ‚úï
                        </button>
                    </div>
                    <div id="search-results-count" class="text-center text-sm text-gray-500 mt-2 hidden"></div>
                </div>
            </div>

            <!-- Brand Filters -->
            <div class="mb-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Marcas</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3" role="group" aria-label="Filtros por marca">
                    <button onclick="filterByBrand('todas')" 
                            class="brand-btn active bg-purple-600 text-white px-3 sm:px-6 py-2 rounded-full hover:bg-purple-700 transition-all text-sm sm:text-base focus-visible:focus"
                            data-brand="todas">
                        Todas
                    </button>
                    <button onclick="filterByBrand('boticario')" 
                            class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base focus-visible:focus"
                            data-brand="boticario">
                        üåø Botic√°rio
                    </button>
                    <button onclick="filterByBrand('mary-kay')" 
                            class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base focus-visible:focus"
                            data-brand="mary-kay">
                        üíé Mary Kay
                    </button>
                    <button onclick="filterByBrand('eudora')" 
                            class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base focus-visible:focus"
                            data-brand="eudora">
                        ‚ú® Eudora
                    </button>
                    <button onclick="filterByBrand('natura')" 
                            class="brand-btn bg-gray-200 text-gray-700 px-3 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base focus-visible:focus"
                            data-brand="natura">
                        üçÉ Natura
                    </button>
                </div>
            </div>

            <!-- Categories -->
            <div class="mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Categorias</h2>
                <div class="flex flex-wrap gap-2 sm:gap-3" role="group" aria-label="Filtros por categoria">
                    <button onclick="filterProducts('todos')" 
                            class="category-btn active bg-indigo-600 text-white px-4 sm:px-6 py-2 rounded-full hover:bg-indigo-700 transition-all text-sm sm:text-base focus-visible:focus"
                            data-category="todos">
                        Todos
                    </button>
                    <button onclick="filterProducts('perfumes')" 
                            class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base focus-visible:focus"
                            data-category="perfumes">
                        Perfumes
                    </button>
                    <button onclick="filterProducts('cosmeticos')" 
                            class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base focus-visible:focus"
                            data-category="cosmeticos">
                        Cosm√©ticos
                    </button>
                    <button onclick="filterProducts('cuidados')" 
                            class="category-btn bg-gray-200 text-gray-700 px-4 sm:px-6 py-2 rounded-full hover:bg-gray-300 transition-all text-sm sm:text-base focus-visible:focus"
                            data-category="cuidados">
                        Cuidados
                    </button>
                </div>
            </div>

            <!-- Products Grid -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6" id="products-grid">
                <!-- Products will be loaded here -->
                <div class="col-span-full flex justify-center items-center py-12">
                    <div class="loading w-8 h-8"></div>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div id="admin-panel" class="admin-panel">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Painel Administrativo</h2>
                    <div class="flex space-x-2">
                        <button onclick="diagnosticSupabase()" 
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-all focus-visible:focus">
                            üîç Diagn√≥stico
                        </button>
                        <button onclick="backToStore()" 
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all focus-visible:focus">
                            üè™ Voltar para Loja
                        </button>
                    </div>
                </div>
                
                <!-- Logo Management -->
                <div class="max-w-2xl mx-auto mb-8">
                    <h3 class="text-lg font-semibold mb-4">üñºÔ∏è Gerenciar Logo da Loja</h3>
                    <div class="bg-gray-50 rounded-lg p-6">
                        <div class="flex items-center space-x-6">
                            <div class="flex-shrink-0">
                                <div class="w-24 h-20 bg-white rounded-lg flex items-center justify-center overflow-hidden border-2 border-gray-200">
                                    <img id="admin-logo-image" class="w-full h-full object-cover hidden" alt="Logo atual">
                                    <span id="admin-logo-text" class="text-purple-600 font-bold text-2xl">KC</span>
                                </div>
                            </div>
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 mb-2">Logo Atual</h4>
                                <p class="text-gray-600 text-sm mb-4">Clique no bot√£o abaixo para alterar a logo da sua loja. Recomendamos imagens quadradas ou retangulares.</p>
                                <div class="flex space-x-3">
                                    <button onclick="changeLogoAdmin()" 
                                            class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-all focus-visible:focus">
                                        üì∑ Alterar Logo
                                    </button>
                                    <button onclick="removeLogoAdmin()" 
                                            class="bg-red-100 text-red-600 px-4 py-2 rounded-lg hover:bg-red-200 transition-all focus-visible:focus">
                                        üóëÔ∏è Remover Logo
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            üí° Dica: Use imagens PNG ou JPG com fundo transparente para melhor resultado. Tamanho m√°ximo: 2MB.
                        </div>
                    </div>
                </div>

                <!-- Add Product Form -->
                <div class="max-w-2xl mx-auto">
                    <h3 class="text-lg font-semibold mb-4">Adicionar Produto</h3>
                    <form id="add-product-form" class="space-y-4">
                        <!-- Product Image Upload -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Foto do Produto</label>
                            <div class="image-upload-area" 
                                 id="product-image-upload" 
                                 onclick="document.getElementById('product-image-input').click()"
                                 role="button"
                                 tabindex="0"
                                 aria-label="Clique para adicionar foto do produto">
                                <div id="image-preview-container" class="hidden">
                                    <img id="image-preview" class="w-full h-32 object-cover rounded-lg mb-2" alt="Preview">
                                    <button type="button" 
                                            onclick="removeProductImage(event)" 
                                            class="text-red-600 hover:text-red-800 text-sm focus-visible:focus">
                                        üóëÔ∏è Remover Foto
                                    </button>
                                </div>
                                <div id="upload-placeholder">
                                    <div class="text-4xl mb-2">üì∑</div>
                                    <p class="text-gray-600 font-medium">Clique para adicionar foto</p>
                                    <p class="text-gray-400 text-sm mt-1">JPG, PNG ou GIF (m√°x. 5MB)</p>
                                </div>
                            </div>
                            <input type="file" 
                                   id="product-image-input" 
                                   accept="image/*" 
                                   class="hidden"
                                   aria-label="Selecionar arquivo de imagem">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="text" 
                                   id="product-name" 
                                   placeholder="Nome do produto" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                   required
                                   maxlength="100">
                            
                            <select id="product-brand" 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                    required>
                                <option value="">Selecione a marca</option>
                                <option value="boticario">üåø Botic√°rio</option>
                                <option value="mary-kay">üíé Mary Kay</option>
                                <option value="eudora">‚ú® Eudora</option>
                                <option value="natura">üçÉ Natura</option>
                            </select>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <select id="product-category" 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                    required>
                                <option value="">Selecione a categoria</option>
                                <option value="perfumes">Perfumes</option>
                                <option value="cosmeticos">Cosm√©ticos</option>
                                <option value="cuidados">Cuidados</option>
                            </select>
                            
                            <input type="number" 
                                   id="product-price" 
                                   placeholder="Pre√ßo (R$)" 
                                   step="0.01" 
                                   min="0"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                   required>
                            
                            <input type="number" 
                                   id="product-stock" 
                                   placeholder="Estoque" 
                                   min="0"
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                   required>
                        </div>

                        <textarea id="product-description" 
                                  placeholder="Descri√ß√£o do produto" 
                                  class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent h-24"
                                  maxlength="500"></textarea>
                        
                        <button type="submit" 
                                id="add-product-btn"
                                class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition-all font-semibold focus-visible:focus">
                            ‚ûï Adicionar Produto
                        </button>
                    </form>
                </div>
            </div>

            <!-- Product Gallery Management -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Produtos Cadastrados</h3>
                    <div class="text-sm text-gray-500">
                        Total: <span id="admin-product-count">0</span> produtos
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="product-gallery">
                    <!-- Product gallery will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Sidebar -->
    <div id="cart-sidebar" class="cart-sidebar fixed right-0 top-0 h-full w-full sm:w-96 bg-white shadow-2xl z-50 flex flex-col">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">Carrinho de Compras</h3>
                <button onclick="toggleCart()" 
                        class="text-gray-500 hover:text-gray-700 text-2xl focus-visible:focus"
                        aria-label="Fechar carrinho">
                    &times;
                </button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto p-6">
            <div id="cart-items">
                <div class="empty-state">
                    <div class="empty-state-icon">üõí</div>
                    <p>Carrinho vazio</p>
                    <p class="text-sm mt-2">Adicione produtos para come√ßar suas compras</p>
                </div>
            </div>
        </div>
        
        <div class="p-6 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-semibold">Total:</span>
                <span class="text-xl font-bold text-purple-600" id="cart-total">R$ 0,00</span>
            </div>
            <button onclick="finalizePurchaseWhatsApp()" 
                    id="checkout-btn"
                    class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition-all font-semibold focus-visible:focus disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled>
                üì± Finalizar pelo WhatsApp
            </button>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden" onclick="toggleCart()"></div>

    <script>
        // Configuration and Constants
        const CONFIG = {
            SUPABASE_URL: 'https://udyihngwyqhfhdxkxwso.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVkeWlobmd3eXFoZmhkeGt4d3NvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTcwOTUsImV4cCI6MjA3MDQzMzA5NX0.MA3RgucTM7akkqxF1Zgl4aLtGBFAUT48IKfXez8ZK3c',
            ADMIN_PASSWORD: 'kc0310',
            WHATSAPP_NUMBER: '5541997786625',
            MAX_IMAGE_SIZE: 5 * 1024 * 1024, // 5MB
            MAX_LOGO_SIZE: 2 * 1024 * 1024, // 2MB
            SEARCH_DEBOUNCE_DELAY: 300,
            TOAST_DURATION: 3000
        };

        // Global State Management
        const AppState = {
            supabaseClient: null,
            products: [],
            cart: [],
            sales: [],
            currentFilter: 'todos',
            currentBrand: 'todas',
            currentSearchTerm: '',
            currentProductImage: null,
            isDbConnected: false,
            isLoading: false,
            eventListeners: new Map() // Track event listeners for cleanup
        };

        // Utility Functions
        const Utils = {
            /**
             * Generate random emoji for products
             */
            getRandomEmoji() {
                const emojis = ['üå∏', 'üíÑ', 'üß¥', '‚ú®', 'üíé', 'üå∫', 'üéÄ', 'üíã', 'üå∑', 'ü¶ã'];
                return emojis[Math.floor(Math.random() * emojis.length)];
            },

            /**
             * Format price to Brazilian currency
             */
            formatPrice(price) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(price);
            },

            /**
             * Sanitize HTML to prevent XSS
             */
            sanitizeHtml(str) {
                const div = document.createElement('div');
                div.textContent = str;
                return div.innerHTML;
            },

            /**
             * Debounce function for search
             */
            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            },

            /**
             * Validate image file
             */
            validateImageFile(file, maxSize = CONFIG.MAX_IMAGE_SIZE) {
                if (!file.type.startsWith('image/')) {
                    throw new Error('Por favor, selecione apenas arquivos de imagem.');
                }
                
                if (file.size > maxSize) {
                    const maxSizeMB = maxSize / (1024 * 1024);
                    throw new Error(`Arquivo muito grande! O tamanho m√°ximo √© ${maxSizeMB}MB.`);
                }
                
                return true;
            },

            /**
             * Generate unique ID
             */
            generateId() {
                return Date.now() + Math.random().toString(36).substr(2, 9);
            },

            /**
             * Clean up event listeners
             */
            cleanupEventListeners() {
                AppState.eventListeners.forEach((cleanup, key) => {
                    if (typeof cleanup === 'function') {
                        cleanup();
                    }
                });
                AppState.eventListeners.clear();
            }
        };

        // Toast Notification System
        const Toast = {
            show(message, type = 'info', duration = CONFIG.TOAST_DURATION) {
                const container = document.getElementById('toast-container');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                container.appendChild(toast);
                
                // Trigger animation
                setTimeout(() => toast.classList.add('show'), 100);
                
                // Auto remove
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            },

            success(message) {
                this.show(message, 'success');
            },

            error(message) {
                this.show(message, 'error');
            },

            info(message) {
                this.show(message, 'info');
            },

            warning(message) {
                this.show(message, 'warning');
            }
        };

        // Loading State Management
        const LoadingManager = {
            setLoading(element, isLoading) {
                if (!element) return;
                
                if (isLoading) {
                    element.classList.add('loading');
                    element.disabled = true;
                } else {
                    element.classList.remove('loading');
                    element.disabled = false;
                }
            },

            setButtonLoading(buttonId, isLoading, originalText = '') {
                const button = document.getElementById(buttonId);
                if (!button) return;

                if (isLoading) {
                    button.dataset.originalText = button.textContent;
                    button.classList.add('btn-loading');
                    button.disabled = true;
                } else {
                    button.classList.remove('btn-loading');
                    button.disabled = false;
                    if (originalText) {
                        button.textContent = originalText;
                    } else if (button.dataset.originalText) {
                        button.textContent = button.dataset.originalText;
                    }
                }
            }
        };

        // Enhanced Database Management System
        const DatabaseManager = {
            client: null,
            connected: false,

            /**
             * Initialize Supabase connection with enhanced error handling
             */
            async init() {
                try {
                    console.log('üîå Inicializando conex√£o com Supabase...');
                    this.client = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
                    
                    // Test connection with timeout
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Connection timeout')), 10000)
                    );
                    
                    const testPromise = this.client
                        .from('products')
                        .select('id')
                        .limit(1);
                    
                    const { data, error } = await Promise.race([testPromise, timeoutPromise]);
                    
                    if (error) {
                        console.error('‚ùå Erro na conex√£o:', error);
                        this.connected = false;
                        AppState.isDbConnected = false;
                        this.showStatus('‚ùå Banco offline - modo local', 'warning');
                        return false;
                    }
                    
                    this.connected = true;
                    AppState.isDbConnected = true;
                    console.log('‚úÖ Supabase conectado com sucesso!');
                    this.showStatus('‚úÖ Sistema online', 'success');
                    
                    // Setup realtime subscriptions
                    this.setupRealtimeSubscriptions();
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao inicializar Supabase:', error);
                    this.connected = false;
                    AppState.isDbConnected = false;
                    this.showStatus('‚ùå Erro de conex√£o', 'error');
                    return false;
                }
            },

            /**
             * Setup realtime subscriptions for live updates
             */
            setupRealtimeSubscriptions() {
                if (!this.connected) return;

                try {
                    // Subscribe to product changes
                    const productSubscription = this.client
                        .channel('products_changes')
                        .on('postgres_changes', 
                            { event: '*', schema: 'public', table: 'products' },
                            (payload) => {
                                console.log('üîÑ Produto atualizado em tempo real:', payload);
                                this.handleRealtimeProductChange(payload);
                            }
                        )
                        .subscribe();

                    console.log('üîÑ Subscriptions em tempo real ativadas');
                } catch (error) {
                    console.error('‚ùå Erro ao configurar realtime:', error);
                }
            },

            /**
             * Handle realtime product changes
             */
            async handleRealtimeProductChange(payload) {
                const { eventType, new: newRecord, old: oldRecord } = payload;
                
                switch (eventType) {
                    case 'INSERT':
                        if (newRecord && !AppState.products.find(p => p.id === newRecord.id)) {
                            AppState.products.push(newRecord);
                            ProductManager.renderProducts();
                            Toast.info(`Novo produto adicionado: ${newRecord.name}`);
                        }
                        break;
                        
                    case 'UPDATE':
                        if (newRecord) {
                            const index = AppState.products.findIndex(p => p.id === newRecord.id);
                            if (index !== -1) {
                                AppState.products[index] = newRecord;
                                ProductManager.renderProducts();
                                ProductManager.updateProductGallery();
                            }
                        }
                        break;
                        
                    case 'DELETE':
                        if (oldRecord) {
                            AppState.products = AppState.products.filter(p => p.id !== oldRecord.id);
                            // Remove from cart if exists
                            AppState.cart = AppState.cart.filter(item => item.id !== oldRecord.id);
                            ProductManager.renderProducts();
                            ProductManager.updateProductGallery();
                            CartManager.updateCartDisplay();
                            Toast.info(`Produto removido: ${oldRecord.name}`);
                        }
                        break;
                }
                
                // Update local storage
                StorageManager.saveToLocalStorage();
            },

            showStatus(message, type = 'info') {
                const statusEl = document.getElementById('db-status');
                if (statusEl) {
                    statusEl.textContent = message;
                    
                    // Reset classes
                    statusEl.className = 'db-status px-3 py-1 rounded-full text-sm font-medium';
                    
                    // Add type-specific classes
                    switch (type) {
                        case 'success':
                            statusEl.classList.add('bg-green-100', 'text-green-800');
                            break;
                        case 'error':
                            statusEl.classList.add('bg-red-100', 'text-red-800');
                            break;
                        case 'warning':
                            statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
                            break;
                        default:
                            statusEl.classList.add('bg-blue-100', 'text-blue-800');
                    }
                    
                    statusEl.classList.remove('hidden');
                    
                    setTimeout(() => {
                        statusEl.classList.add('hidden');
                    }, CONFIG.TOAST_DURATION);
                }
            },

            /**
             * Load products with enhanced error handling
             */
            async loadProducts() {
                if (!this.connected) return [];
                
                try {
                    const { data, error } = await this.client
                        .from('products')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    console.log(`üì¶ ${data?.length || 0} produtos carregados do Supabase`);
                    return data || [];
                } catch (error) {
                    console.error('‚ùå Erro ao carregar produtos:', error);
                    Toast.error('Erro ao carregar produtos do servidor');
                    return [];
                }
            },

            /**
             * Save product with validation
             */
            async saveProduct(product) {
                if (!this.connected) return false;
                
                try {
                    // Validate product data
                    if (!product.name || !product.brand || !product.category) {
                        throw new Error('Dados do produto incompletos');
                    }

                    const productData = {
                        id: product.id,
                        name: Utils.sanitizeHtml(product.name.trim()),
                        brand: product.brand,
                        category: product.category,
                        price: parseFloat(product.price),
                        stock: parseInt(product.stock),
                        description: Utils.sanitizeHtml(product.description?.trim() || ''),
                        image: product.image || Utils.getRandomEmoji(),
                        image_url: product.imageUrl || product.image_url || null
                    };
                    
                    const { data, error } = await this.client
                        .from('products')
                        .upsert(productData, { onConflict: 'id' })
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Produto salvo no Supabase:', product.name);
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar produto:', error);
                    Toast.error(`Erro ao salvar produto: ${error.message}`);
                    return false;
                }
            },

            /**
             * Delete product with cleanup
             */
            async deleteProduct(productId) {
                if (!this.connected) return false;
                
                try {
                    const { error } = await this.client
                        .from('products')
                        .delete()
                        .eq('id', productId);
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Produto exclu√≠do do Supabase');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao excluir produto:', error);
                    Toast.error('Erro ao excluir produto');
                    return false;
                }
            },

            /**
             * Upload image with progress tracking
             */
            async uploadImage(file, fileName) {
                if (!this.connected) return null;
                
                try {
                    Utils.validateImageFile(file);
                    
                    const { data, error } = await this.client.storage
                        .from('product_images')
                        .upload(fileName, file, {
                            cacheControl: '3600',
                            upsert: true
                        });
                    
                    if (error) throw error;
                    
                    const { data: urlData } = this.client.storage
                        .from('product_images')
                        .getPublicUrl(fileName);
                    
                    console.log('‚úÖ Imagem enviada para Supabase Storage');
                    return urlData.publicUrl;
                } catch (error) {
                    console.error('‚ùå Erro ao enviar imagem:', error);
                    Toast.error('Erro ao enviar imagem');
                    return null;
                }
            },

            /**
             * Delete image from storage
             */
            async deleteImage(fileName) {
                if (!this.connected) return false;
                
                try {
                    const { error } = await this.client.storage
                        .from('product_images')
                        .remove([fileName]);
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Imagem exclu√≠da do Storage');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao excluir imagem:', error);
                    return false;
                }
            },

            /**
             * Save sale record
             */
            async saveSale(sale) {
                if (!this.connected) return false;
                
                try {
                    const { data, error } = await this.client
                        .from('sales')
                        .insert(sale)
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Venda salva no Supabase');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar venda:', error);
                    Toast.error('Erro ao registrar venda');
                    return false;
                }
            }
        };

        // Enhanced Local Storage Management
        const StorageManager = {
            /**
             * Save data to localStorage with error handling
             */
            saveToLocalStorage() {
                try {
                    const data = {
                        products: AppState.products,
                        sales: AppState.sales,
                        cart: AppState.cart,
                        lastUpdated: new Date().toISOString()
                    };
                    
                    localStorage.setItem('kc_data', JSON.stringify(data));
                    console.log('üíæ Dados salvos no localStorage');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar no localStorage:', error);
                    Toast.error('Erro ao salvar dados localmente');
                    return false;
                }
            },

            /**
             * Load data from localStorage
             */
            loadFromLocalStorage() {
                try {
                    const savedData = localStorage.getItem('kc_data');
                    if (!savedData) return false;
                    
                    const data = JSON.parse(savedData);
                    
                    AppState.products = Array.isArray(data.products) ? data.products : [];
                    AppState.sales = Array.isArray(data.sales) ? data.sales : [];
                    AppState.cart = Array.isArray(data.cart) ? data.cart : [];
                    
                    console.log(`üì± Dados carregados do localStorage:`);
                    console.log(`  - ${AppState.products.length} produtos`);
                    console.log(`  - ${AppState.sales.length} vendas`);
                    console.log(`  - ${AppState.cart.length} itens no carrinho`);
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao carregar do localStorage:', error);
                    // Reset to empty arrays on error
                    AppState.products = [];
                    AppState.sales = [];
                    AppState.cart = [];
                    return false;
                }
            },

            /**
             * Clear all local storage data
             */
            clearLocalStorage() {
                try {
                    localStorage.removeItem('kc_data');
                    localStorage.removeItem('kc_logo');
                    console.log('üóëÔ∏è Dados locais limpos');
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao limpar localStorage:', error);
                    return false;
                }
            }
        };

        // Enhanced Search Manager
        const SearchManager = {
            currentTerm: '',
            
            init() {
                const searchInput = document.getElementById('search-input');
                const clearButton = document.getElementById('clear-search');
                
                if (!searchInput) return;
                
                // Debounced search function
                const debouncedSearch = Utils.debounce((term) => {
                    this.performSearch(term);
                }, CONFIG.SEARCH_DEBOUNCE_DELAY);
                
                // Search input handler
                const searchHandler = (e) => {
                    const term = e.target.value.trim();
                    this.currentTerm = term;
                    AppState.currentSearchTerm = term;
                    
                    // Show/hide clear button
                    if (clearButton) {
                        clearButton.classList.toggle('hidden', !term);
                    }
                    
                    debouncedSearch(term);
                };
                
                searchInput.addEventListener('input', searchHandler);
                
                // Clear search handler
                if (clearButton) {
                    clearButton.addEventListener('click', () => {
                        this.clearSearch();
                    });
                }
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + K to focus search
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        searchInput.focus();
                    }
                    
                    // Escape to clear search
                    if (e.key === 'Escape' && document.activeElement === searchInput) {
                        this.clearSearch();
                    }
                });
                
                // Store cleanup function
                AppState.eventListeners.set('search', () => {
                    searchInput.removeEventListener('input', searchHandler);
                });
            },
            
            performSearch(term) {
                this.currentTerm = term;
                AppState.currentSearchTerm = term;
                
                // Update results count
                this.updateResultsCount();
                
                // Re-render products with search filter
                ProductManager.renderProducts();
            },
            
            clearSearch() {
                const searchInput = document.getElementById('search-input');
                const clearButton = document.getElementById('clear-search');
                const resultsCount = document.getElementById('search-results-count');
                
                if (searchInput) {
                    searchInput.value = '';
                    searchInput.focus();
                }
                
                if (clearButton) {
                    clearButton.classList.add('hidden');
                }
                
                if (resultsCount) {
                    resultsCount.classList.add('hidden');
                }
                
                this.currentTerm = '';
                AppState.currentSearchTerm = '';
                
                ProductManager.renderProducts();
            },
            
            updateResultsCount() {
                const resultsCount = document.getElementById('search-results-count');
                if (!resultsCount) return;
                
                if (!this.currentTerm) {
                    resultsCount.classList.add('hidden');
                    return;
                }
                
                const filteredProducts = this.getFilteredProducts();
                const count = filteredProducts.length;
                
                resultsCount.textContent = count === 1 
                    ? `1 produto encontrado` 
                    : `${count} produtos encontrados`;
                resultsCount.classList.remove('hidden');
            },
            
            getFilteredProducts() {
                let filtered = [...AppState.products];
                
                // Apply search filter
                if (this.currentTerm) {
                    const searchTerm = this.currentTerm.toLowerCase();
                    filtered = filtered.filter(product => 
                        product.name.toLowerCase().includes(searchTerm) ||
                        product.description?.toLowerCase().includes(searchTerm) ||
                        product.brand.toLowerCase().includes(searchTerm)
                    );
                }
                
                // Apply brand filter
                if (AppState.currentBrand !== 'todas') {
                    filtered = filtered.filter(p => p.brand === AppState.currentBrand);
                }
                
                // Apply category filter
                if (AppState.currentFilter !== 'todos') {
                    filtered = filtered.filter(p => p.category === AppState.currentFilter);
                }
                
                return filtered;
            }
        };

        // Enhanced Product Manager
        const ProductManager = {
            /**
             * Load and render products with enhanced error handling
             */
            async loadAndRenderProducts() {
                try {
                    console.log('üîÑ Carregando produtos...');
                    AppState.isLoading = true;
                    
                    if (AppState.isDbConnected) {
                        const supabaseProducts = await DatabaseManager.loadProducts();
                        if (supabaseProducts && supabaseProducts.length > 0) {
                            AppState.products = supabaseProducts;
                            console.log(`‚úÖ ${AppState.products.length} produtos carregados do Supabase`);
                            StorageManager.saveToLocalStorage();
                        } else {
                            StorageManager.loadFromLocalStorage();
                        }
                    } else {
                        StorageManager.loadFromLocalStorage();
                    }
                    
                    this.renderProducts();
                    this.updateProductGallery();
                    SearchManager.updateResultsCount();
                    
                } catch (error) {
                    console.error('‚ùå Erro ao carregar produtos:', error);
                    Toast.error('Erro ao carregar produtos');
                    StorageManager.loadFromLocalStorage();
                    this.renderProducts();
                    this.updateProductGallery();
                } finally {
                    AppState.isLoading = false;
                }
            },

            /**
             * Render products with enhanced filtering and search
             */
            renderProducts() {
                const grid = document.getElementById('products-grid');
                if (!grid) return;
                
                // Show loading state
                if (AppState.isLoading) {
                    grid.innerHTML = `
                        <div class="col-span-full flex justify-center items-center py-12">
                            <div class="loading w-8 h-8"></div>
                        </div>
                    `;
                    return;
                }
                
                // Get filtered products
                const filteredProducts = SearchManager.getFilteredProducts();
                
                // Brand name mapping
                const brandNames = {
                    'boticario': 'üåø Botic√°rio',
                    'mary-kay': 'üíé Mary Kay',
                    'eudora': '‚ú® Eudora',
                    'natura': 'üçÉ Natura'
                };

                // Empty state
                if (filteredProducts.length === 0) {
                    const emptyMessage = AppState.currentSearchTerm 
                        ? `Nenhum produto encontrado para "${AppState.currentSearchTerm}"`
                        : 'Nenhum produto encontrado';
                        
                    grid.innerHTML = `
                        <div class="col-span-full empty-state">
                            <div class="empty-state-icon">üîç</div>
                            <p class="text-lg font-medium mb-2">${emptyMessage}</p>
                            <p class="text-sm">Tente ajustar os filtros ou buscar por outros termos</p>
                        </div>
                    `;
                    return;
                }

                // Create document fragment for better performance
                const fragment = document.createDocumentFragment();
                
                filteredProducts.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card bg-white rounded-lg shadow-md overflow-hidden fade-in';
                    
                    const productImageHtml = product.imageUrl || product.image_url
                        ? `<img src="${product.imageUrl || product.image_url}" 
                             alt="${Utils.sanitizeHtml(product.name)}" 
                             class="product-image" 
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="product-image-placeholder" style="display: none;">${product.image}</div>`
                        : `<div class="product-image-placeholder">${product.image}</div>`;

                    productCard.innerHTML = `
                        <div class="p-0">
                            ${productImageHtml}
                        </div>
                        <div class="p-6">
                            <div class="text-xs text-purple-600 font-semibold mb-2 text-center">
                                ${brandNames[product.brand] || Utils.sanitizeHtml(product.brand)}
                            </div>
                            <h3 class="font-semibold text-lg mb-2 line-clamp-2">
                                ${Utils.sanitizeHtml(product.name)}
                            </h3>
                            <p class="text-gray-600 text-sm mb-3 line-clamp-2">
                                ${Utils.sanitizeHtml(product.description || '')}
                            </p>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-2xl font-bold text-purple-600">
                                    ${Utils.formatPrice(product.price)}
                                </span>
                                <span class="text-sm text-gray-500">
                                    Estoque: ${product.stock}
                                </span>
                            </div>
                            <button onclick="CartManager.addToCart(${product.id})" 
                                    ${product.stock === 0 ? 'disabled' : ''}
                                    class="w-full py-2 px-4 rounded-lg font-semibold transition-all focus-visible:focus
                                    ${product.stock === 0 
                                        ? 'bg-gray-300 text-gray-500 cursor-not-allowed' 
                                        : 'bg-purple-600 text-white hover:bg-purple-700'}"
                                    aria-label="Adicionar ${Utils.sanitizeHtml(product.name)} ao carrinho">
                                ${product.stock === 0 ? 'Sem Estoque' : 'üõí Adicionar ao Carrinho'}
                            </button>
                        </div>
                    `;
                    
                    fragment.appendChild(productCard);
                });
                
                // Clear and append all at once for better performance
                grid.innerHTML = '';
                grid.appendChild(fragment);
            },

            /**
             * Update admin product gallery
             */
            updateProductGallery() {
                const gallery = document.getElementById('product-gallery');
                const productCount = document.getElementById('admin-product-count');
                
                if (!gallery) return;
                
                // Update product count
                if (productCount) {
                    productCount.textContent = AppState.products.length;
                }
                
                const brandNames = {
                    'boticario': 'üåø Botic√°rio',
                    'mary-kay': 'üíé Mary Kay',
                    'eudora': '‚ú® Eudora',
                    'natura': 'üçÉ Natura'
                };

                if (AppState.products.length === 0) {
                    gallery.innerHTML = `
                        <div class="col-span-full empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <p class="text-lg font-medium mb-2">Nenhum produto cadastrado</p>
                            <p class="text-sm">Use o formul√°rio acima para adicionar produtos</p>
                        </div>
                    `;
                    return;
                }

                const fragment = document.createDocumentFragment();
                
                AppState.products.forEach(product => {
                    const productItem = document.createElement('div');
                    productItem.className = 'bg-gray-50 rounded-lg p-4 slide-in';
                    
                    const productImageHtml = product.imageUrl || product.image_url
                        ? `<img src="${product.imageUrl || product.image_url}" 
                             alt="${Utils.sanitizeHtml(product.name)}" 
                             class="w-full h-32 object-cover rounded-lg mb-2" 
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center text-3xl mb-2" style="display: none;">
                               ${product.image}
                           </div>`
                        : `<div class="w-full h-32 bg-gray-100 rounded-lg flex items-center justify-center text-3xl mb-2">
                               ${product.image}
                           </div>`;

                    productItem.innerHTML = `
                        ${productImageHtml}
                        <div class="text-xs text-purple-600 font-medium mb-1">
                            ${brandNames[product.brand] || Utils.sanitizeHtml(product.brand)}
                        </div>
                        <h4 class="font-semibold text-sm mb-1 line-clamp-2">
                            ${Utils.sanitizeHtml(product.name)}
                        </h4>
                        <p class="text-xs text-gray-600 mb-2">
                            ${Utils.formatPrice(product.price)} | Estoque: ${product.stock}
                        </p>
                        <div class="flex space-x-1">
                            <button onclick="AdminManager.editProduct(${product.id})" 
                                    class="flex-1 bg-green-100 text-green-600 text-xs py-1 px-2 rounded hover:bg-green-200 transition-all focus-visible:focus"
                                    aria-label="Editar produto">
                                ‚úèÔ∏è Editar
                            </button>
                            <button onclick="AdminManager.editProductImage(${product.id})" 
                                    class="flex-1 bg-blue-100 text-blue-600 text-xs py-1 px-2 rounded hover:bg-blue-200 transition-all focus-visible:focus"
                                    aria-label="Alterar foto do produto">
                                üì∑ Foto
                            </button>
                            <button onclick="AdminManager.deleteProduct(${product.id})" 
                                    class="flex-1 bg-red-100 text-red-600 text-xs py-1 px-2 rounded hover:bg-red-200 transition-all focus-visible:focus"
                                    aria-label="Excluir produto">
                                üóëÔ∏è Excluir
                            </button>
                        </div>
                    `;
                    
                    fragment.appendChild(productItem);
                });
                
                gallery.innerHTML = '';
                gallery.appendChild(fragment);
            }
        };

        // Enhanced Cart Manager
        const CartManager = {
            /**
             * Add product to cart with validation
             */
            addToCart(productId) {
                const product = AppState.products.find(p => p.id === productId);
                if (!product || product.stock === 0) {
                    Toast.warning('Produto indispon√≠vel ou sem estoque');
                    return;
                }

                const existingItem = AppState.cart.find(item => item.id === productId);
                if (existingItem) {
                    if (existingItem.quantity < product.stock) {
                        existingItem.quantity++;
                        Toast.success(`${product.name} adicionado ao carrinho`);
                    } else {
                        Toast.warning('Quantidade m√°xima em estoque atingida');
                        return;
                    }
                } else {
                    AppState.cart.push({
                        id: productId,
                        name: product.name,
                        price: product.price,
                        quantity: 1,
                        image: product.image,
                        imageUrl: product.imageUrl || product.image_url
                    });
                    Toast.success(`${product.name} adicionado ao carrinho`);
                }
                
                this.updateCartDisplay();
                StorageManager.saveToLocalStorage();
            },

            /**
             * Remove product from cart
             */
            removeFromCart(productId) {
                const item = AppState.cart.find(item => item.id === productId);
                if (item) {
                    AppState.cart = AppState.cart.filter(item => item.id !== productId);
                    Toast.info(`${item.name} removido do carrinho`);
                    this.updateCartDisplay();
                    StorageManager.saveToLocalStorage();
                }
            },

            /**
             * Update item quantity in cart
             */
            updateQuantity(productId, change) {
                const item = AppState.cart.find(item => item.id === productId);
                const product = AppState.products.find(p => p.id === productId);
                
                if (item && product) {
                    const newQuantity = item.quantity + change;
                    if (newQuantity > 0 && newQuantity <= product.stock) {
                        item.quantity = newQuantity;
                    } else if (newQuantity <= 0) {
                        this.removeFromCart(productId);
                        return;
                    } else {
                        Toast.warning('Quantidade m√°xima em estoque atingida');
                        return;
                    }
                }
                this.updateCartDisplay();
                StorageManager.saveToLocalStorage();
            },

            /**
             * Update cart display with enhanced UI
             */
            updateCartDisplay() {
                const cartItems = document.getElementById('cart-items');
                const cartCount = document.getElementById('cart-count');
                const cartTotal = document.getElementById('cart-total');
                const checkoutBtn = document.getElementById('checkout-btn');

                if (!cartItems || !cartCount || !cartTotal) return;

                const totalItems = AppState.cart.reduce((sum, item) => sum + item.quantity, 0);
                const totalPrice = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                cartCount.textContent = totalItems;
                cartTotal.textContent = Utils.formatPrice(totalPrice);

                // Enable/disable checkout button
                if (checkoutBtn) {
                    checkoutBtn.disabled = AppState.cart.length === 0;
                }

                if (AppState.cart.length === 0) {
                    cartItems.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üõí</div>
                            <p>Carrinho vazio</p>
                            <p class="text-sm mt-2">Adicione produtos para come√ßar suas compras</p>
                        </div>
                    `;
                    return;
                }

                const fragment = document.createDocumentFragment();
                
                AppState.cart.forEach(item => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'flex items-center justify-between py-3 border-b border-gray-200 slide-in';
                    
                    const itemImageHtml = item.imageUrl 
                        ? `<img src="${item.imageUrl}" 
                             alt="${Utils.sanitizeHtml(item.name)}" 
                             class="w-12 h-12 object-cover rounded" 
                             loading="lazy"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                           <span class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-xl" style="display: none;">
                               ${item.image}
                           </span>`
                        : `<span class="w-12 h-12 bg-gray-100 rounded flex items-center justify-center text-xl">
                               ${item.image}
                           </span>`;

                    cartItem.innerHTML = `
                        <div class="flex items-center space-x-3">
                            ${itemImageHtml}
                            <div>
                                <h4 class="font-semibold text-sm">${Utils.sanitizeHtml(item.name)}</h4>
                                <p class="text-purple-600 font-semibold text-sm">${Utils.formatPrice(item.price)}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="CartManager.updateQuantity(${item.id}, -1)" 
                                    class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 text-sm focus-visible:focus"
                                    aria-label="Diminuir quantidade">
                                -
                            </button>
                            <span class="w-8 text-center text-sm">${item.quantity}</span>
                            <button onclick="CartManager.updateQuantity(${item.id}, 1)" 
                                    class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300 text-sm focus-visible:focus"
                                    aria-label="Aumentar quantidade">
                                +
                            </button>
                            <button onclick="CartManager.removeFromCart(${item.id})" 
                                    class="ml-2 text-red-500 hover:text-red-700 text-sm focus-visible:focus"
                                    aria-label="Remover item do carrinho">
                                üóëÔ∏è
                            </button>
                        </div>
                    `;
                    
                    fragment.appendChild(cartItem);
                });
                
                cartItems.innerHTML = '';
                cartItems.appendChild(fragment);
            },

            /**
             * Toggle cart sidebar
             */
            toggleCart() {
                const sidebar = document.getElementById('cart-sidebar');
                const overlay = document.getElementById('overlay');
                
                if (sidebar && overlay) {
                    const isOpen = sidebar.classList.contains('open');
                    
                    if (isOpen) {
                        sidebar.classList.remove('open');
                        overlay.classList.add('hidden');
                        document.body.style.overflow = '';
                    } else {
                        sidebar.classList.add('open');
                        overlay.classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                    }
                }
            },

            /**
             * Finalize purchase via WhatsApp with enhanced validation
             */
            async finalizePurchaseWhatsApp() {
                if (AppState.cart.length === 0) {
                    Toast.warning('Seu carrinho est√° vazio!');
                    return;
                }

                const checkoutBtn = document.getElementById('checkout-btn');
                LoadingManager.setButtonLoading('checkout-btn', true);

                try {
                    const total = AppState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    
                    // Validate stock availability
                    for (const item of AppState.cart) {
                        const product = AppState.products.find(p => p.id === item.id);
                        if (!product || product.stock < item.quantity) {
                            Toast.error(`Produto ${item.name} n√£o tem estoque suficiente`);
                            return;
                        }
                    }
                    
                    let message = `üõçÔ∏è *PEDIDO KC PERFUMARIA* üíú\n\n`;
                    
                    message += `üì¶ *PRODUTOS:*\n`;
                    AppState.cart.forEach((item, index) => {
                        message += `${index + 1}. ${item.name}\n`;
                        message += `   Qtd: ${item.quantity}x - ${Utils.formatPrice(item.price * item.quantity)}\n\n`;
                    });
                    
                    message += `üí∞ *TOTAL: ${Utils.formatPrice(total)}*\n\n`;
                    message += `Ol√°! Gostaria de fazer este pedido. Podemos combinar a entrega? üòä`;

                    // Update stock
                    for (const item of AppState.cart) {
                        const product = AppState.products.find(p => p.id === item.id);
                        if (product) {
                            product.stock -= item.quantity;
                            
                            if (AppState.isDbConnected) {
                                await DatabaseManager.saveProduct(product);
                            }
                        }
                    }

                    // Record sale
                    const sale = {
                        id: Utils.generateId(),
                        items: [...AppState.cart],
                        total: total,
                        payment_method: 'WhatsApp',
                        date: new Date().toISOString(),
                        date_formatted: new Date().toLocaleDateString('pt-BR')
                    };
                    
                    AppState.sales.push(sale);
                    
                    if (AppState.isDbConnected) {
                        await DatabaseManager.saveSale(sale);
                    }
                    
                    StorageManager.saveToLocalStorage();

                    // Open WhatsApp
                    const whatsappUrl = `https://wa.me/${CONFIG.WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');

                    // Clear cart and close sidebar
                    AppState.cart = [];
                    this.updateCartDisplay();
                    this.toggleCart();
                    ProductManager.renderProducts();
                    ProductManager.updateProductGallery();

                    Toast.success('Pedido enviado para o WhatsApp! Estoque atualizado automaticamente.');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao processar venda:', error);
                    Toast.error('Erro ao processar venda. Tente novamente.');
                } finally {
                    LoadingManager.setButtonLoading('checkout-btn', false);
                }
            }
        };

        // Enhanced Admin Manager
        const AdminManager = {
            /**
             * Access admin panel with enhanced security
             */
            accessAdmin() {
                const password = prompt('üîê Digite a senha de administrador:');
                
                if (password === CONFIG.ADMIN_PASSWORD) {
                    const customerView = document.getElementById('customer-view');
                    const adminPanel = document.getElementById('admin-panel');
                    
                    if (customerView && adminPanel) {
                        customerView.style.display = 'none';
                        adminPanel.style.display = 'block';
                        adminPanel.classList.remove('admin-panel');
                        
                        ProductManager.updateProductGallery();
                        
                        // Load logo in admin preview
                        const savedLogo = localStorage.getItem('kc_logo');
                        if (savedLogo) {
                            LogoManager.updateAdminLogoPreview(savedLogo);
                        }
                    }
                    
                    Toast.success('Acesso administrativo concedido!');
                    return true;
                } else if (password !== null) {
                    Toast.error('Senha incorreta! Acesso negado.');
                    return false;
                }
                
                return false;
            },

            /**
             * Return to store view
             */
            backToStore() {
                const customerView = document.getElementById('customer-view');
                const adminPanel = document.getElementById('admin-panel');
                
                if (customerView && adminPanel) {
                    customerView.style.display = 'block';
                    adminPanel.style.display = 'none';
                    adminPanel.classList.add('admin-panel');
                }
                
                Toast.info('Voltando para a loja');
            },

            /**
             * Edit product with enhanced modal
             */
            async editProduct(productId) {
                const product = AppState.products.find(p => p.id === productId);
                if (!product) return;

                const modal = this.createModal('‚úèÔ∏è Editar Produto', `
                    <form id="edit-product-form">
                        <div class="space-y-4">
                            <input type="text" 
                                   id="edit-name" 
                                   value="${Utils.sanitizeHtml(product.name)}" 
                                   placeholder="Nome do produto" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                   required
                                   maxlength="100">
                            
                            <select id="edit-brand" 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                    required>
                                <option value="boticario" ${product.brand === 'boticario' ? 'selected' : ''}>üåø Botic√°rio</option>
                                <option value="mary-kay" ${product.brand === 'mary-kay' ? 'selected' : ''}>üíé Mary Kay</option>
                                <option value="eudora" ${product.brand === 'eudora' ? 'selected' : ''}>‚ú® Eudora</option>
                                <option value="natura" ${product.brand === 'natura' ? 'selected' : ''}>üçÉ Natura</option>
                            </select>
                            
                            <select id="edit-category" 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                    required>
                                <option value="perfumes" ${product.category === 'perfumes' ? 'selected' : ''}>Perfumes</option>
                                <option value="cosmeticos" ${product.category === 'cosmeticos' ? 'selected' : ''}>Cosm√©ticos</option>
                                <option value="cuidados" ${product.category === 'cuidados' ? 'selected' : ''}>Cuidados</option>
                            </select>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <input type="number" 
                                       id="edit-price" 
                                       value="${product.price}" 
                                       placeholder="Pre√ßo (R$)" 
                                       step="0.01" 
                                       min="0"
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                       required>
                                
                                <input type="number" 
                                       id="edit-stock" 
                                       value="${product.stock}" 
                                       placeholder="Estoque" 
                                       min="0"
                                       class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" 
                                       required>
                            </div>
                            
                            <textarea id="edit-description" 
                                      placeholder="Descri√ß√£o do produto" 
                                      class="w-full p-3 border border-gray-300 rounded-lg h-20 focus:ring-2 focus:ring-purple-500"
                                      maxlength="500">${Utils.sanitizeHtml(product.description || '')}</textarea>
                        </div>
                        
                        <div class="flex space-x-2 mt-6">
                            <button type="submit" 
                                    id="save-product-btn"
                                    class="flex-1 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 transition-all focus-visible:focus">
                                ‚úÖ Salvar
                            </button>
                            <button type="button" 
                                    onclick="this.closest('.modal-overlay').remove()" 
                                    class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg hover:bg-gray-400 transition-all focus-visible:focus">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </form>
                `);

                const form = modal.querySelector('#edit-product-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    LoadingManager.setButtonLoading('save-product-btn', true);
                    
                    try {
                        product.name = document.getElementById('edit-name').value.trim();
                        product.brand = document.getElementById('edit-brand').value;
                        product.category = document.getElementById('edit-category').value;
                        product.price = parseFloat(document.getElementById('edit-price').value);
                        product.stock = parseInt(document.getElementById('edit-stock').value);
                        product.description = document.getElementById('edit-description').value.trim();
                        
                        if (AppState.isDbConnected) {
                            await DatabaseManager.saveProduct(product);
                        }
                        
                        StorageManager.saveToLocalStorage();
                        await ProductManager.loadAndRenderProducts();
                        modal.remove();
                        
                        Toast.success('Produto atualizado com sucesso!');
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar produto:', error);
                        Toast.error('Erro ao atualizar produto');
                    } finally {
                        LoadingManager.setButtonLoading('save-product-btn', false);
                    }
                });
            },

            /**
             * Edit product image with enhanced handling
             */
            async editProductImage(productId) {
                const product = AppState.products.find(p => p.id === productId);
                if (!product) return;

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                
                fileInput.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        Utils.validateImageFile(file);
                        
                        Toast.info('Enviando imagem...');
                        
                        let imageUrl = null;
                        
                        if (AppState.isDbConnected) {
                            const fileName = `product_${product.id}_${Date.now()}`;
                            imageUrl = await DatabaseManager.uploadImage(file, fileName);
                        }
                        
                        if (!imageUrl) {
                            // Fallback to base64
                            const reader = new FileReader();
                            reader.onload = async (e) => {
                                product.imageUrl = e.target.result;
                                product.image_url = e.target.result;
                                
                                if (AppState.isDbConnected) {
                                    await DatabaseManager.saveProduct(product);
                                }
                                
                                StorageManager.saveToLocalStorage();
                                await ProductManager.loadAndRenderProducts();
                                Toast.success('Foto do produto atualizada!');
                            };
                            reader.readAsDataURL(file);
                        } else {
                            product.imageUrl = imageUrl;
                            product.image_url = imageUrl;
                            
                            if (AppState.isDbConnected) {
                                await DatabaseManager.saveProduct(product);
                            }
                            
                            StorageManager.saveToLocalStorage();
                            await ProductManager.loadAndRenderProducts();
                            Toast.success('Foto do produto atualizada!');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao atualizar imagem:', error);
                        Toast.error(error.message || 'Erro ao atualizar imagem');
                    }
                };
                
                fileInput.click();
            },

            /**
             * Delete product with confirmation
             */
            async deleteProduct(productId) {
                const product = AppState.products.find(p => p.id === productId);
                if (!product) return;

                const confirmed = confirm(`üóëÔ∏è Tem certeza que deseja excluir "${product.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`);
                if (!confirmed) return;

                try {
                    Toast.info('Excluindo produto...');
                    
                    if (AppState.isDbConnected) {
                        await DatabaseManager.deleteProduct(productId);
                        
                        // Delete image if exists
                        if (product.imageUrl && product.imageUrl.includes('supabase')) {
                            const fileName = product.imageUrl.split('/').pop();
                            await DatabaseManager.deleteImage(fileName);
                        }
                    }
                    
                    AppState.products = AppState.products.filter(p => p.id !== productId);
                    
                    // Remove from cart if exists
                    AppState.cart = AppState.cart.filter(item => item.id !== productId);
                    
                    StorageManager.saveToLocalStorage();
                    await ProductManager.loadAndRenderProducts();
                    CartManager.updateCartDisplay();
                    
                    Toast.success('Produto exclu√≠do com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå Erro ao excluir produto:', error);
                    Toast.error('Erro ao excluir produto');
                }
            },

            /**
             * Create modal with enhanced styling
             */
            createModal(title, content) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3 class="text-lg font-bold mb-4">${title}</h3>
                        <div>${content}</div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Close on overlay click
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
                
                // Close on Escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
                
                return modal;
            },

            /**
             * Diagnostic function with enhanced reporting
             */
            async diagnosticSupabase() {
                const results = [];
                
                try {
                    results.push('üîç === DIAGN√ìSTICO DO SISTEMA ===\n');
                    
                    // System info
                    results.push('üìä INFORMA√á√ïES DO SISTEMA:');
                    results.push(`  - Produtos carregados: ${AppState.products.length}`);
                    results.push(`  - Itens no carrinho: ${AppState.cart.length}`);
                    results.push(`  - Vendas registradas: ${AppState.sales.length}`);
                    results.push(`  - Status da conex√£o: ${AppState.isDbConnected ? 'Online' : 'Offline'}`);
                    
                    // Connection test
                    results.push('\n1Ô∏è‚É£ TESTANDO CONEX√ÉO...');
                    if (!DatabaseManager.client) {
                        results.push('‚ùå Cliente Supabase n√£o inicializado');
                    } else {
                        results.push('‚úÖ Cliente Supabase inicializado');
                    }
                    
                    // Database test
                    results.push('\n2Ô∏è‚É£ TESTANDO BANCO DE DADOS...');
                    try {
                        const { data, error } = await DatabaseManager.client
                            .from('products')
                            .select('count')
                            .limit(1);
                        
                        if (error) {
                            results.push(`‚ùå Erro: ${error.message}`);
                            if (error.message.includes('relation "products" does not exist')) {
                                results.push('üí° SOLU√á√ÉO: Execute o SQL de cria√ß√£o das tabelas');
                            }
                        } else {
                            results.push('‚úÖ Tabela products acess√≠vel');
                        }
                    } catch (err) {
                        results.push(`‚ùå Erro ao testar tabela: ${err.message}`);
                    }
                    
                    // Storage test
                    results.push('\n3Ô∏è‚É£ TESTANDO ARMAZENAMENTO LOCAL...');
                    try {
                        const testData = JSON.stringify({ test: true, timestamp: Date.now() });
                        localStorage.setItem('kc_test', testData);
                        const retrieved = localStorage.getItem('kc_test');
                        localStorage.removeItem('kc_test');
                        
                        if (retrieved === testData) {
                            results.push('‚úÖ localStorage funcionando');
                        } else {
                            results.push('‚ùå Erro no localStorage');
                        }
                    } catch (err) {
                        results.push(`‚ùå Erro no localStorage: ${err.message}`);
                    }
                    
                    // Performance info
                    results.push('\n4Ô∏è‚É£ INFORMA√á√ïES DE PERFORMANCE...');
                    results.push(`  - Filtro atual: ${AppState.currentFilter}`);
                    results.push(`  - Marca atual: ${AppState.currentBrand}`);
                    results.push(`  - Termo de busca: ${AppState.currentSearchTerm || 'Nenhum'}`);
                    results.push(`  - Event listeners ativos: ${AppState.eventListeners.size}`);
                    
                    // Browser info
                    results.push('\n5Ô∏è‚É£ INFORMA√á√ïES DO NAVEGADOR...');
                    results.push(`  - User Agent: ${navigator.userAgent.substring(0, 50)}...`);
                    results.push(`  - Idioma: ${navigator.language}`);
                    results.push(`  - Online: ${navigator.onLine ? 'Sim' : 'N√£o'}`);
                    
                    results.push('\nüéØ === FIM DO DIAGN√ìSTICO ===');
                    
                } catch (error) {
                    results.push(`‚ùå ERRO CR√çTICO: ${error.message}`);
                }
                
                const resultText = results.join('\n');
                console.log(resultText);
                
                this.createModal('üîç Diagn√≥stico do Sistema', 
                    `<pre class="whitespace-pre-wrap text-sm bg-gray-50 p-4 rounded-lg border overflow-x-auto font-mono max-h-96">${resultText}</pre>`
                );
            }
        };

        // Enhanced Logo Manager
        const LogoManager = {
            /**
             * Change logo from header
             */
            changeLogo() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        Utils.validateImageFile(file, CONFIG.MAX_LOGO_SIZE);
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const logoData = e.target.result;
                            this.updateLogo(logoData);
                            localStorage.setItem('kc_logo', logoData);
                            Toast.success('Logo atualizada com sucesso!');
                        };
                        reader.readAsDataURL(file);
                    } catch (error) {
                        Toast.error(error.message);
                    }
                };
                
                fileInput.click();
            },

            /**
             * Change logo from admin panel
             */
            changeLogoAdmin() {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'image/*';
                
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    try {
                        Utils.validateImageFile(file, CONFIG.MAX_LOGO_SIZE);
                        
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const logoData = e.target.result;
                            this.updateLogo(logoData);
                            this.updateAdminLogoPreview(logoData);
                            localStorage.setItem('kc_logo', logoData);
                            Toast.success('Logo atualizada com sucesso!');
                        };
                        reader.readAsDataURL(file);
                    } catch (error) {
                        Toast.error(error.message);
                    }
                };
                
                fileInput.click();
            },

            /**
             * Remove logo from admin panel
             */
            removeLogoAdmin() {
                const confirmed = confirm('üóëÔ∏è Tem certeza que deseja remover a logo?');
                if (!confirmed) return;

                this.updateLogo(null);
                this.updateAdminLogoPreview(null);
                localStorage.removeItem('kc_logo');
                Toast.success('Logo removida com sucesso!');
            },

            /**
             * Update logo in header
             */
            updateLogo(logoData) {
                const logoImage = document.getElementById('logo-image');
                const logoText = document.getElementById('logo-text');
                
                if (logoImage && logoText) {
                    if (logoData) {
                        logoImage.src = logoData;
                        logoImage.classList.remove('hidden');
                        logoText.classList.add('hidden');
                    } else {
                        logoImage.classList.add('hidden');
                        logoText.classList.remove('hidden');
                    }
                }
            },

            /**
             * Update logo preview in admin panel
             */
            updateAdminLogoPreview(logoData) {
                const adminLogoImage = document.getElementById('admin-logo-image');
                const adminLogoText = document.getElementById('admin-logo-text');
                
                if (adminLogoImage && adminLogoText) {
                    if (logoData) {
                        adminLogoImage.src = logoData;
                        adminLogoImage.classList.remove('hidden');
                        adminLogoText.classList.add('hidden');
                    } else {
                        adminLogoImage.classList.add('hidden');
                        adminLogoText.classList.remove('hidden');
                    }
                }
            }
        };

        // Enhanced Image Manager
        const ImageManager = {
            /**
             * Setup product image upload with drag & drop
             */
            setupProductImageUpload() {
                const imageInput = document.getElementById('product-image-input');
                const uploadArea = document.getElementById('product-image-upload');
                
                if (!imageInput || !uploadArea) return;
                
                // File input change handler
                const inputHandler = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.handleProductImageFile(file);
                    }
                };
                
                imageInput.addEventListener('change', inputHandler);

                // Drag and drop handlers
                const dragOverHandler = (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                };
                
                const dragLeaveHandler = (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                };
                
                const dropHandler = (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        this.handleProductImageFile(file);
                    }
                };

                uploadArea.addEventListener('dragover', dragOverHandler);
                uploadArea.addEventListener('dragleave', dragLeaveHandler);
                uploadArea.addEventListener('drop', dropHandler);
                
                // Keyboard accessibility
                uploadArea.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        imageInput.click();
                    }
                });
                
                // Store cleanup functions
                AppState.eventListeners.set('imageUpload', () => {
                    imageInput.removeEventListener('change', inputHandler);
                    uploadArea.removeEventListener('dragover', dragOverHandler);
                    uploadArea.removeEventListener('dragleave', dragLeaveHandler);
                    uploadArea.removeEventListener('drop', dropHandler);
                });
            },

            /**
             * Handle product image file with validation
             */
            handleProductImageFile(file) {
                try {
                    Utils.validateImageFile(file);
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        AppState.currentProductImage = {
                            file: file,
                            dataUrl: e.target.result
                        };
                        this.showImagePreview(e.target.result);
                        Toast.success('Imagem carregada com sucesso!');
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    Toast.error(error.message);
                }
            },

            /**
             * Show image preview
             */
            showImagePreview(imageData) {
                const previewContainer = document.getElementById('image-preview-container');
                const uploadPlaceholder = document.getElementById('upload-placeholder');
                const imagePreview = document.getElementById('image-preview');

                if (previewContainer && uploadPlaceholder && imagePreview) {
                    imagePreview.src = imageData;
                    previewContainer.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                }
            },

            /**
             * Remove product image
             */
            removeProductImage(event) {
                event.stopPropagation();
                
                const previewContainer = document.getElementById('image-preview-container');
                const uploadPlaceholder = document.getElementById('upload-placeholder');
                const imageInput = document.getElementById('product-image-input');

                AppState.currentProductImage = null;
                
                if (previewContainer && uploadPlaceholder && imageInput) {
                    previewContainer.classList.add('hidden');
                    uploadPlaceholder.classList.remove('hidden');
                    imageInput.value = '';
                }
                
                Toast.info('Imagem removida');
            }
        };

        // Filter Manager
        const FilterManager = {
            /**
             * Filter products by brand
             */
            filterByBrand(brand) {
                AppState.currentBrand = brand;
                
                // Update button states
                document.querySelectorAll('.brand-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-purple-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                
                const activeBtn = document.querySelector(`[data-brand="${brand}"]`) || event.target;
                activeBtn.classList.add('active', 'bg-purple-600', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                
                ProductManager.renderProducts();
                SearchManager.updateResultsCount();
            },

            /**
             * Filter products by category
             */
            filterProducts(category) {
                AppState.currentFilter = category;
                
                // Update button states
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                });
                
                const activeBtn = document.querySelector(`[data-category="${category}"]`) || event.target;
                activeBtn.classList.add('active', 'bg-indigo-600', 'text-white');
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                
                ProductManager.renderProducts();
                SearchManager.updateResultsCount();
            }
        };

        // Form Manager
        const FormManager = {
            /**
             * Setup add product form
             */
            setupAddProductForm() {
                const form = document.getElementById('add-product-form');
                if (!form) return;
                
                const submitHandler = async (e) => {
                    e.preventDefault();
                    await this.handleAddProduct(e);
                };
                
                form.addEventListener('submit', submitHandler);
                
                // Store cleanup function
                AppState.eventListeners.set('addProductForm', () => {
                    form.removeEventListener('submit', submitHandler);
                });
            },

            /**
             * Handle add product form submission
             */
            async handleAddProduct(e) {
                const form = e.target;
                const submitBtn = document.getElementById('add-product-btn');
                
                LoadingManager.setButtonLoading('add-product-btn', true);
                
                try {
                    const formData = new FormData(form);
                    const name = document.getElementById('product-name').value.trim();
                    const brand = document.getElementById('product-brand').value;
                    const category = document.getElementById('product-category').value;
                    const price = parseFloat(document.getElementById('product-price').value);
                    const stock = parseInt(document.getElementById('product-stock').value);
                    const description = document.getElementById('product-description').value.trim();

                    // Validation
                    if (!name || !brand || !category || isNaN(price) || isNaN(stock)) {
                        throw new Error('Por favor, preencha todos os campos obrigat√≥rios!');
                    }

                    if (price < 0 || stock < 0) {
                        throw new Error('Pre√ßo e estoque devem ser valores positivos!');
                    }

                    const productId = Utils.generateId();
                    let imageUrl = null;

                    // Handle image upload
                    if (AppState.currentProductImage) {
                        if (AppState.isDbConnected) {
                            const fileName = `product_${productId}_${Date.now()}`;
                            imageUrl = await DatabaseManager.uploadImage(AppState.currentProductImage.file, fileName);
                        }
                        
                        if (!imageUrl) {
                            imageUrl = AppState.currentProductImage.dataUrl;
                        }
                    }

                    const newProduct = {
                        id: productId,
                        name: name,
                        brand: brand,
                        category: category,
                        price: price,
                        stock: stock,
                        description: description,
                        image: Utils.getRandomEmoji(),
                        imageUrl: imageUrl,
                        image_url: imageUrl,
                        created_at: new Date().toISOString()
                    };

                    if (AppState.isDbConnected) {
                        const saved = await DatabaseManager.saveProduct(newProduct);
                        if (!saved) {
                            throw new Error('Erro ao salvar no servidor');
                        }
                    }
                    
                    AppState.products.push(newProduct);
                    StorageManager.saveToLocalStorage();
                    
                    // Clear form
                    this.clearAddProductForm();
                    
                    await ProductManager.loadAndRenderProducts();
                    
                    const successMessage = imageUrl 
                        ? `Produto "${name}" adicionado com foto!`
                        : `Produto "${name}" adicionado!`;
                    
                    Toast.success(successMessage);
                    
                } catch (error) {
                    console.error('‚ùå Erro ao salvar produto:', error);
                    Toast.error(error.message || 'Erro ao salvar produto');
                } finally {
                    LoadingManager.setButtonLoading('add-product-btn', false);
                }
            },

            /**
             * Clear add product form
             */
            clearAddProductForm() {
                const form = document.getElementById('add-product-form');
                if (form) {
                    form.reset();
                }
                
                AppState.currentProductImage = null;
                
                const previewContainer = document.getElementById('image-preview-container');
                const uploadPlaceholder = document.getElementById('upload-placeholder');
                
                if (previewContainer && uploadPlaceholder) {
                    previewContainer.classList.add('hidden');
                    uploadPlaceholder.classList.remove('hidden');
                }
            }
        };

        // Application Initializer
        const App = {
            /**
             * Initialize the entire application
             */
            async init() {
                try {
                    console.log('üöÄ Inicializando KC Perfumaria...');
                    
                    // Initialize state
                    AppState.products = [];
                    AppState.sales = [];
                    AppState.cart = [];
                    
                    // Setup managers
                    this.setupManagers();
                    
                    // Try to connect to Supabase
                    const dbConnected = await DatabaseManager.init();
                    AppState.isDbConnected = dbConnected;
                    
                    // Load data
                    await ProductManager.loadAndRenderProducts();
                    
                    // Load cart from localStorage
                    StorageManager.loadFromLocalStorage();
                    CartManager.updateCartDisplay();
                    
                    // Load logo
                    const savedLogo = localStorage.getItem('kc_logo');
                    if (savedLogo) {
                        LogoManager.updateLogo(savedLogo);
                        LogoManager.updateAdminLogoPreview(savedLogo);
                    }
                    
                    // Setup keyboard shortcuts
                    this.setupKeyboardShortcuts();
                    
                    console.log('‚úÖ KC Perfumaria inicializada com sucesso!');
                    console.log(`üìä ${AppState.products.length} produtos carregados`);
                    console.log(`üîó Modo: ${AppState.isDbConnected ? 'Online' : 'Local'}`);
                    
                    Toast.success('Sistema inicializado com sucesso!');
                    
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o:', error);
                    
                    // Emergency fallback
                    AppState.isDbConnected = false;
                    StorageManager.loadFromLocalStorage();
                    ProductManager.renderProducts();
                    ProductManager.updateProductGallery();
                    CartManager.updateCartDisplay();
                    
                    console.log('‚úÖ Sistema funcionando em modo local');
                    Toast.warning('Sistema funcionando em modo offline');
                }
            },

            /**
             * Setup all managers
             */
            setupManagers() {
                SearchManager.init();
                ImageManager.setupProductImageUpload();
                FormManager.setupAddProductForm();
            },

            /**
             * Setup keyboard shortcuts
             */
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    // Alt + A for admin access
                    if (e.altKey && e.key === 'a') {
                        e.preventDefault();
                        AdminManager.accessAdmin();
                    }
                    
                    // Alt + C for cart toggle
                    if (e.altKey && e.key === 'c') {
                        e.preventDefault();
                        CartManager.toggleCart();
                    }
                });
            },

            /**
             * Cleanup function for when the app is destroyed
             */
            cleanup() {
                Utils.cleanupEventListeners();
                console.log('üßπ Aplica√ß√£o limpa');
            }
        };

        // Make functions globally accessible for HTML onclick handlers
        window.CartManager = CartManager;
        window.AdminManager = AdminManager;
        window.LogoManager = LogoManager;
        window.ImageManager = ImageManager;
        window.FilterManager = FilterManager;
        window.SearchManager = SearchManager;

        // Legacy function mappings for backward compatibility
        window.accessAdmin = AdminManager.accessAdmin.bind(AdminManager);
        window.backToStore = AdminManager.backToStore.bind(AdminManager);
        window.toggleCart = CartManager.toggleCart.bind(CartManager);
        window.addToCart = CartManager.addToCart.bind(CartManager);
        window.removeFromCart = CartManager.removeFromCart.bind(CartManager);
        window.updateQuantity = CartManager.updateQuantity.bind(CartManager);
        window.finalizePurchaseWhatsApp = CartManager.finalizePurchaseWhatsApp.bind(CartManager);
        window.filterByBrand = FilterManager.filterByBrand.bind(FilterManager);
        window.filterProducts = FilterManager.filterProducts.bind(FilterManager);
        window.editProduct = AdminManager.editProduct.bind(AdminManager);
        window.editProductImage = AdminManager.editProductImage.bind(AdminManager);
        window.deleteProduct = AdminManager.deleteProduct.bind(AdminManager);
        window.removeProductImage = ImageManager.removeProductImage.bind(ImageManager);
        window.changeLogo = LogoManager.changeLogo.bind(LogoManager);
        window.changeLogoAdmin = LogoManager.changeLogoAdmin.bind(LogoManager);
        window.removeLogoAdmin = LogoManager.removeLogoAdmin.bind(LogoManager);
        window.diagnosticSupabase = AdminManager.diagnosticSupabase.bind(AdminManager);
        window.clearSearch = SearchManager.clearSearch.bind(SearchManager);

        // Initialize application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            App.cleanup();
        });

        // Handle online/offline events
        window.addEventListener('online', () => {
            Toast.info('Conex√£o restaurada');
            DatabaseManager.init();
        });

        window.addEventListener('offline', () => {
            Toast.warning('Conex√£o perdida - modo offline');
            AppState.isDbConnected = false;
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96e44c26c7ab128c',t:'MTc1NTA0NzA1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
